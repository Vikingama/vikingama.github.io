<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='本来以为是很简单的东西，没想到这么复杂和巧妙'><title>VueRouter 2.x 源码学习 · Stay Hungry · Stay Foolish</title>
<link rel=canonical href=https://vikingama.github.io/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/><link rel=stylesheet href=/scss/style.min.38c15d3a5c1bca30008bb625a46636d24f5deb4bf3217095e667a3abc843eaef.css><meta property='og:title' content='VueRouter 2.x 源码学习'><meta property='og:description' content='本来以为是很简单的东西，没想到这么复杂和巧妙'><meta property='og:url' content='https://vikingama.github.io/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2022-01-06T00:00:00+00:00'><meta property='article:modified_time' content='2022-01-06T00:00:00+00:00'><meta property='og:image' content='https://vikingama.github.io/img/cover/vue.png'><meta name=twitter:title content="VueRouter 2.x 源码学习"><meta name=twitter:description content="本来以为是很简单的东西，没想到这么复杂和巧妙"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://vikingama.github.io/img/cover/vue.png'><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=theme-color content="#ffffff"><meta name=robots content="noarchive"><div class=warning-banner>因为 GitHub 账号二次验证失败，计划迁往
<a href=https://elementref.github.io/>新地址&rarr;</a></div></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huae06eac29c2bc6aa7e83a685ea2f6536_13838_300x0_resize_box_3.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>Stay Hungry · Stay Foolish</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=https://github.com/ElementRef/AboutConfig target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg>
<span>配置</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/><img src=/img/cover/vue.png loading=lazy alt="VueRouter 2.x 源码学习"></a></div><div class=article-details><header class=article-category><a href=/categories/vue/>Vue</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/>VueRouter 2.x 源码学习</a></h2><h3 class=article-subtitle>本来以为是很简单的东西，没想到这么复杂和巧妙</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 06, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：12 分钟</time></div></footer></div></header><section class=article-content><h2 id=vueuserouter>Vue.use(Router)</h2><p>Vue.use 会调用 Router 的静态 install 方法：</p><ol><li>保存 Vue 构造函数，方便其他组件调用 Vue 的工具函数；</li><li>在每个 Vue 实例中混入钩子：<ol><li>定义 _routerRoot、_router、_route（getter/setter）；</li><li>调用 Router 实例的 init 方法；</li><li>注册路由实例。</li></ol></li><li>在 Vue 原型上挂载 $router、$route；</li><li>注册 router-view 和 router-link 组件。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>let</span> <span class=nx>_Vue</span><span class=p>;</span> <span class=c1>// 别的地方有用到 _Vue.extend
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>install</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 防止重复 install
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>install</span><span class=p>.</span><span class=nx>installed</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>install</span><span class=p>.</span><span class=nx>installed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保存 Vue
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>_Vue</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isDef</span> <span class=o>=</span> <span class=nx>v</span> <span class=o>=&gt;</span> <span class=nx>v</span> <span class=o>!==</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>registerInstance</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>callVal</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>_parentVnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>data</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>registerRouteInstance</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 调用 vm.$options._parentVnode.data.registerRouteInstance
</span></span></span><span class=line><span class=cl><span class=cm>       * data.registerRouteInstance 存在于 router-view 中
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>i</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>callVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 混入钩子（确保每个 vm 都能访问到路由）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>mixin</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>beforeCreate() {</span>
</span></span><span class=line><span class=cl>      <span class=c1>// new Vue({router, ...})，挂载根实例，如果是根 vm
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>router</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// _routerRoot 指向根组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>_routerRoot</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 传入的 new Router({mode, routes, ...})
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>_router</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 调用 _router 的 init 方法，将 this 保存到数组里
</span></span></span><span class=line><span class=cl><span class=cm>         * 监听 history，有变化会更新所有 this 里的 route
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>_router</span><span class=p>.</span><span class=nx>init</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * defineReactive(obj, key, val, customSetter, shallow)
</span></span></span><span class=line><span class=cl><span class=cm>         * 将 this._route 转化为 getter/setter，render 被调用时
</span></span></span><span class=line><span class=cl><span class=cm>         * router.view 会访问 this._route，触发 getter
</span></span></span><span class=line><span class=cl><span class=cm>         * 当 this._route 更新后，setter 调用
</span></span></span><span class=line><span class=cl><span class=cm>         * router.view 渲染匹配的组件
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>Vue</span><span class=p>.</span><span class=nx>util</span><span class=p>.</span><span class=nx>defineReactive</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s1>&#39;_route&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>_router</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果不是根组件，向上（从父级）查找 _routerRoot
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>_routerRoot</span> <span class=o>=</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_routerRoot</span><span class=p>)</span> <span class=o>||</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>registerInstance</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>destroyed() {</span>
</span></span><span class=line><span class=cl>      <span class=nx>registerInstance</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 直接在原型链上添加 $router/$route，都指向 _routerRoot 上对应的属性
</span></span></span><span class=line><span class=cl><span class=cm>   * vm.$router = this._routerRoot._router = new Router({mode, routes, ...})
</span></span></span><span class=line><span class=cl><span class=cm>   * vm.$route = this._routerRoot._route
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>,</span> <span class=s1>&#39;$router&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 都指向 new VueRouter({...})
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_routerRoot</span><span class=p>.</span><span class=nx>_router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>,</span> <span class=s1>&#39;$route&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 都指向 this._router.history.current
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_routerRoot</span><span class=p>.</span><span class=nx>_route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 全局注册 router-view 和 router-link 组件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>component</span><span class=p>(</span><span class=s1>&#39;router-view&#39;</span><span class=p>,</span> <span class=nx>View</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>component</span><span class=p>(</span><span class=s1>&#39;router-link&#39;</span><span class=p>,</span> <span class=nx>Link</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>strats</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>optionMergeStrategies</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>strats</span><span class=p>.</span><span class=nx>beforeRouteEnter</span> <span class=o>=</span> <span class=nx>strats</span><span class=p>.</span><span class=nx>beforeRouteLeave</span> <span class=o>=</span> <span class=nx>strats</span><span class=p>.</span><span class=nx>created</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=vuerouter>VueRouter</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>VueRouter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>install</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>version</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span>: <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>apps</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ready</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>readyCbs</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Function</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>RouterOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>mode</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>history</span>: <span class=kt>HashHistory</span> <span class=o>|</span> <span class=nx>HTML5History</span> <span class=o>|</span> <span class=nx>AbstractHistory</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span>: <span class=kt>Matcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>fallback</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>beforeHooks</span>: <span class=kt>Array</span><span class=o>&lt;?</span><span class=nx>NavigationGuard</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>resolveHooks</span>: <span class=kt>Array</span><span class=o>&lt;?</span><span class=nx>NavigationGuard</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>afterHooks</span>: <span class=kt>Array</span><span class=o>&lt;?</span><span class=nx>AfterNavigationHook</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>options</span>: <span class=kt>RouterOptions</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>app</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>apps</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>beforeHooks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>resolveHooks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>afterHooks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>matcher</span> <span class=o>=</span> <span class=nx>createMatcher</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>routes</span> <span class=o>||</span> <span class=p>[],</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 默认 hash 模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>mode</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>mode</span> <span class=o>||</span> <span class=s1>&#39;hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>fallback</span> <span class=o>=</span> <span class=c1>// 不支持 history，退回 hash
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>mode</span> <span class=o>===</span> <span class=s1>&#39;history&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>supportsPushState</span> <span class=o>&amp;&amp;</span> <span class=nx>options</span><span class=p>.</span><span class=nx>fallback</span> <span class=o>!==</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>fallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>mode</span> <span class=o>=</span> <span class=s1>&#39;hash&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 非浏览器环境使用 abstract 模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>inBrowser</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>mode</span> <span class=o>=</span> <span class=s1>&#39;abstract&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>mode</span> <span class=o>=</span> <span class=nx>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// options.base 就是&#34;基路径&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=nx>mode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;history&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 处理滚动行为
</span></span></span><span class=line><span class=cl><span class=cm>         * 监听 popstate 并调用 transitionTo
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>history</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>HTML5History</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>options</span><span class=p>.</span><span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;hash&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 处理 URL 格式
</span></span></span><span class=line><span class=cl><span class=cm>         * 监听 hashchange 并调用 transitionTo
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>history</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>HashHistory</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>options</span><span class=p>.</span><span class=nx>base</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>fallback</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;abstract&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>history</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AbstractHistory</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>options</span><span class=p>.</span><span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>match</span><span class=p>(</span><span class=nx>raw</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>current?</span>: <span class=kt>Route</span><span class=p>,</span> <span class=nx>redirectedFrom?</span>: <span class=kt>Location</span><span class=p>)</span><span class=o>:</span> <span class=nx>Route</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>matcher</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>raw</span><span class=p>,</span> <span class=nx>current</span><span class=p>,</span> <span class=nx>redirectedFrom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>currentRoute</span><span class=p>()</span><span class=o>:</span> <span class=o>?</span><span class=nx>Route</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>history</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 每个组件的 beforeCreate 会调用 init 方法，将当前实例传进来
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>init</span><span class=p>(</span><span class=nx>app</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 向 this.apps 添加当前 Vue 实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>apps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 不要重复 init
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>app</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// _router.app = vm
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>app</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>history</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>history</span> <span class=k>instanceof</span> <span class=nx>HTML5History</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * getCurrentLocation 就是截取掉&#34;基路径&#34;后的路径
</span></span></span><span class=line><span class=cl><span class=cm>       * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class=line><span class=cl><span class=cm>       * getCurrentLocation =&gt; /api/?abc=123#hahaha
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>history</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span><span class=nx>history</span><span class=p>.</span><span class=nx>getCurrentLocation</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>history</span> <span class=k>instanceof</span> <span class=nx>HashHistory</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 绑定 hashchange 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>setupHashListener</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>history</span><span class=p>.</span><span class=nx>setupListeners</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 跳转一次页面，触发一次 hashchange
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>history</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * getCurrentLocation 就是截取掉 # 后边的值
</span></span></span><span class=line><span class=cl><span class=cm>         * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class=line><span class=cl><span class=cm>         * getCurrentLocation =&gt; hahaha
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>history</span><span class=p>.</span><span class=nx>getCurrentLocation</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>setupHashListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>setupHashListener</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 路由改变的时候，所有 Vue 实例里的 _route 都要改变
</span></span></span><span class=line><span class=cl><span class=cm>     * history 的 updateRoute 会调用 listen 里的回调
</span></span></span><span class=line><span class=cl><span class=cm>     * _route 已经是“响应式”，会触发组件更新
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>history</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>apps</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>app</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>app</span><span class=p>.</span><span class=nx>_route</span> <span class=o>=</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=nx>fn</span>: <span class=kt>Function</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>registerHook</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>beforeHooks</span><span class=p>,</span> <span class=nx>fn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>beforeResolve</span><span class=p>(</span><span class=nx>fn</span>: <span class=kt>Function</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>registerHook</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>resolveHooks</span><span class=p>,</span> <span class=nx>fn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>afterEach</span><span class=p>(</span><span class=nx>fn</span>: <span class=kt>Function</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>registerHook</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>afterHooks</span><span class=p>,</span> <span class=nx>fn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onReady</span><span class=p>(</span><span class=nx>cb</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>errorCb?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>onReady</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>errorCb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onError</span><span class=p>(</span><span class=nx>errorCb</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>onError</span><span class=p>(</span><span class=nx>errorCb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>push</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>location</span><span class=p>,</span> <span class=nx>onComplete</span><span class=p>,</span> <span class=nx>onAbort</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>replace</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=nx>location</span><span class=p>,</span> <span class=nx>onComplete</span><span class=p>,</span> <span class=nx>onAbort</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>go</span><span class=p>(</span><span class=nx>n</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>go</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>back() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>go</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>forward() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>go</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>getMatchedComponents</span><span class=p>(</span><span class=nx>to?</span>: <span class=kt>RawLocation</span> <span class=o>|</span> <span class=nx>Route</span><span class=p>)</span><span class=o>:</span> <span class=nb>Array</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>route</span>: <span class=kt>any</span> <span class=o>=</span> <span class=nx>to</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>to</span><span class=p>.</span><span class=nx>matched</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>to</span>
</span></span><span class=line><span class=cl>        : <span class=kt>this.resolve</span><span class=p>(</span><span class=nx>to</span><span class=p>).</span><span class=nx>route</span>
</span></span><span class=line><span class=cl>      : <span class=kt>this.currentRoute</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>route</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[].</span><span class=nx>concat</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span><span class=p>.</span><span class=nx>matched</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>components</span><span class=p>).</span><span class=nx>map</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>resolve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>to</span>: <span class=kt>RawLocation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>current?</span>: <span class=kt>Route</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>append?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>location</span>: <span class=kt>Location</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>route</span>: <span class=kt>Route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>href</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>normalizedTo</span>: <span class=kt>Location</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>resolved</span>: <span class=kt>Route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>location</span> <span class=o>=</span> <span class=nx>normalizeLocation</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>to</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>current</span> <span class=o>||</span> <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>append</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>route</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>location</span><span class=p>,</span> <span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fullPath</span> <span class=o>=</span> <span class=nx>route</span><span class=p>.</span><span class=nx>redirectedFrom</span> <span class=o>||</span> <span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>base</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>href</span> <span class=o>=</span> <span class=nx>createHref</span><span class=p>(</span><span class=nx>base</span><span class=p>,</span> <span class=nx>fullPath</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>href</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>normalizedTo</span>: <span class=kt>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>resolved</span>: <span class=kt>route</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>addRoutes</span><span class=p>(</span><span class=nx>routes</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>RouteConfig</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>matcher</span><span class=p>.</span><span class=nx>addRoutes</span><span class=p>(</span><span class=nx>routes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>current</span> <span class=o>!==</span> <span class=nx>START</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>getCurrentLocation</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=basehistory>BaseHistory</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>History</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>base</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span><span class=o>:</span> <span class=p>(</span><span class=nx>r</span>: <span class=kt>Route</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>current</span>: <span class=kt>Route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>errorCbs</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Function</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>pending</span>: <span class=kt>?Route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ready</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>readyCbs</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Function</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>readyErrorCbs</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Function</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=nx>router</span>: <span class=kt>Router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要子类去实现的方法：
</span></span></span><span class=line><span class=cl><span class=cm>   * +ensureURL: (push?: boolean) =&gt; void;
</span></span></span><span class=line><span class=cl><span class=cm>   * +getCurrentLocation: () =&gt; string;
</span></span></span><span class=line><span class=cl><span class=cm>   * +go: (n: number) =&gt; void;
</span></span></span><span class=line><span class=cl><span class=cm>   * +push: (loc: RawLocation) =&gt; void;
</span></span></span><span class=line><span class=cl><span class=cm>   * +replace: (loc: RawLocation) =&gt; void;
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>router</span>: <span class=kt>Router</span><span class=p>,</span> <span class=nx>base</span>: <span class=kt>?string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>base</span> <span class=o>=</span> <span class=nx>normalizeBase</span><span class=p>(</span><span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>START</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>errorCbs</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pending</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ready</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>readyCbs</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>readyErrorCbs</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>router</span> <span class=o>=</span> <span class=nx>router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>listen</span><span class=p>(</span><span class=nx>cb</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 给 this.cb 赋值，会在 updateRoute 调用 this.cb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>=</span> <span class=nx>cb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onReady</span><span class=p>(</span><span class=nx>cb</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>errorCb</span>: <span class=kt>?Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>ready</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cb</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>readyCbs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>errorCb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>readyErrorCbs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>errorCb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onError</span><span class=p>(</span><span class=nx>errorCb</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>errorCbs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>errorCb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 用于路由切换
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onAbort?</span>: <span class=kt>Function</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 匹配目标 location 的 route
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>route</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>location</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 确认切换（异步）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>confirmTransition</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// onComplete
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>updateRoute</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span> <span class=c1>// 更新 route
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>onComplete</span> <span class=o>&amp;&amp;</span> <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>ensureURL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>ready</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>ready</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>readyCbs</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cb</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cb</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>// onAbort
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>onAbort</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>onAbort</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>ready</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>ready</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>readyErrorCbs</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cb</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cb</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>confirmTransition</span><span class=p>(</span><span class=nx>route</span>: <span class=kt>Route</span><span class=p>,</span> <span class=nx>onComplete</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 导航取消的时候调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>abort</span> <span class=o>=</span> <span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isError</span><span class=p>(</span><span class=nx>err</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>errorCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>errorCbs</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cb</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cb</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>onAbort</span> <span class=o>&amp;&amp;</span> <span class=nx>onAbort</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果 route 和 current 是相同路径（path、hash、query、params 一样）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>isSameRoute</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>current</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 并且匹配的长度一致
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>route</span><span class=p>.</span><span class=nx>matched</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=nx>current</span><span class=p>.</span><span class=nx>matched</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 就没必要跳转
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>ensureURL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 找出 currentRecord 和 nextRecord 中的相同与不同
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>updated</span><span class=p>,</span> <span class=c1>// 相同但需要更新的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>deactivated</span><span class=p>,</span> <span class=c1>// currentRecord 独有的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>activated</span> <span class=c1>// nextRecord 独有的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=o>=</span> <span class=nx>resolveQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>matched</span><span class=p>,</span> <span class=c1>// currentRecord 数组
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>route</span><span class=p>.</span><span class=nx>matched</span> <span class=c1>// nextRecord 数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 导航被触发
</span></span></span><span class=line><span class=cl><span class=cm>     * 在失活的组件里调用 beforeRouteLeave 守卫
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用全局的 beforeEach 守卫
</span></span></span><span class=line><span class=cl><span class=cm>     * 在重用的组件里调用 beforeRouteUpdate 守卫
</span></span></span><span class=line><span class=cl><span class=cm>     * 在路由配置里调用 beforeEnter
</span></span></span><span class=line><span class=cl><span class=cm>     * 解析异步路由组件
</span></span></span><span class=line><span class=cl><span class=cm>     * 在被激活的组件里调用 beforeRouteEnter
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用全局的 beforeResolve 守卫
</span></span></span><span class=line><span class=cl><span class=cm>     * 导航被确认
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用全局的 afterEach 钩子
</span></span></span><span class=line><span class=cl><span class=cm>     * 触发 DOM 更新
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>queue</span>: <span class=kt>Array</span><span class=o>&lt;?</span><span class=nx>NavigationGuard</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>[].</span><span class=nx>concat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 组件内部的 beforeRouteLeave
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>extractLeaveGuards</span><span class=p>(</span><span class=nx>deactivated</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 全局 beforeEach
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>beforeHooks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 组件内部的 beforeRouteUpdate
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>extractUpdateHooks</span><span class=p>(</span><span class=nx>updated</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=c1>// routes 路由表里写的 beforeEnter
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>activated</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=nx>m</span><span class=p>.</span><span class=nx>beforeEnter</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 解析异步路由组件，会等待异步组件的加载，加载完成之后再导航
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>resolveAsyncComponents</span><span class=p>(</span><span class=nx>activated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pending</span> <span class=o>=</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>iterator</span> <span class=o>=</span> <span class=p>(</span><span class=nx>hook</span>: <span class=kt>NavigationGuard</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// next 被调用之后，会去拿数组里的下一个钩子函数
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pending</span> <span class=o>!==</span> <span class=nx>route</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 有点 to、from、next 那味儿了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hook</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>current</span><span class=p>,</span> <span class=p>(</span><span class=nx>to</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>to</span> <span class=o>===</span> <span class=kc>false</span> <span class=o>||</span> <span class=nx>isError</span><span class=p>(</span><span class=nx>to</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// next(false) -&gt; 停止导航
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>ensureURL</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>abort</span><span class=p>(</span><span class=nx>to</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>typeof</span> <span class=nx>to</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=k>typeof</span> <span class=nx>to</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=k>typeof</span> <span class=nx>to</span><span class=p>.</span><span class=nx>path</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span> <span class=o>||</span> <span class=k>typeof</span> <span class=nx>to</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// next(&#39;/&#39;) 或 next({ path: &#39;/&#39; }) -&gt; 重定向
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>to</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>to</span><span class=p>.</span><span class=nx>replace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>this</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=nx>to</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>this</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>to</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>next</span><span class=p>(</span><span class=nx>to</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>abort</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>runQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>queue</span><span class=p>,</span> <span class=c1>// 保存了要执行的钩子函数
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>iterator</span><span class=p>,</span> <span class=c1>// queue 里的钩子会被一个一个的拿到 iterator 里执行
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// queue 里的钩子被全部调用完成之后，会执行此函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>postEnterCbs</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>isValid</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span> <span class=o>===</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取组件里 beforeRouteEnter 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>enterGuards</span> <span class=o>=</span> <span class=nx>extractEnterGuards</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>activated</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>postEnterCbs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isValid</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 拼接上全局 beforeResolve 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>queue</span> <span class=o>=</span> <span class=nx>enterGuards</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>resolveHooks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>runQueue</span><span class=p>(</span><span class=nx>queue</span><span class=p>,</span> <span class=nx>iterator</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 新的 queue 里的钩子被全部调用完成之后，会执行此函数
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>pending</span> <span class=o>!==</span> <span class=nx>route</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>abort</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>pending</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>app</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>app</span><span class=p>.</span><span class=nx>$nextTick</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>postEnterCbs</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cb</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>cb</span><span class=p>();</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>updateRoute</span><span class=p>(</span><span class=nx>route</span>: <span class=kt>Route</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prev</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>current</span> <span class=o>=</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 this.cb（init 的时候，由 history.listen 赋值）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>afterHooks</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>hook</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hook</span> <span class=o>&amp;&amp;</span> <span class=nx>hook</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>prev</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>runQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>queue</span>: <span class=kt>Array</span><span class=o>&lt;?</span><span class=nx>NavigationGuard</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>fn</span>: <span class=kt>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span>: <span class=kt>Function</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>step</span> <span class=o>=</span> <span class=nx>index</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>index</span> <span class=o>&gt;=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cb</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>queue</span><span class=p>[</span><span class=nx>index</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fn</span><span class=p>(</span><span class=nx>queue</span><span class=p>[</span><span class=nx>index</span><span class=p>],</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>step</span><span class=p>(</span><span class=nx>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>step</span><span class=p>(</span><span class=nx>index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>step</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=html5history>HTML5History</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>HTML5History</span> <span class=kr>extends</span> <span class=nx>History</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>router</span>: <span class=kt>Router</span><span class=p>,</span> <span class=nx>base</span>: <span class=kt>?string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>(</span><span class=nx>router</span><span class=p>,</span> <span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>expectScroll</span> <span class=o>=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>scrollBehavior</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>expectScroll</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// popstate 时，保存滚动位置
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>setupScroll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件
</span></span></span><span class=line><span class=cl><span class=cm>     * popstate 事件只会在浏览器后退按钮或调用 history.back() 方法时触发
</span></span></span><span class=line><span class=cl><span class=cm>     * 即，在同一文档的两个历史记录条目之间导航会触发该事件
</span></span></span><span class=line><span class=cl><span class=cm>     * 重新调用 transitionTo 完成页面切换
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;popstate&#39;</span><span class=p>,</span> <span class=nx>e</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span><span class=nx>getLocation</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span><span class=p>),</span> <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>expectScroll</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * handleScroll(router, to, from, isPop)
</span></span></span><span class=line><span class=cl><span class=cm>           * 调用 getScrollPosition 获取滚动位置（保存在 history 的 state 里）
</span></span></span><span class=line><span class=cl><span class=cm>           * 调用 router.options.scrollBehavior(to, from, position) 判断是否需要滚动
</span></span></span><span class=line><span class=cl><span class=cm>           * 调用 window.scrollTo 进行滚动
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>handleScroll</span><span class=p>(</span><span class=nx>router</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>current</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>go</span><span class=p>(</span><span class=nx>n</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>go</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>push</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>current</span>: <span class=kt>fromRoute</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>pushState</span><span class=p>(</span><span class=nx>cleanPath</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span> <span class=o>+</span> <span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleScroll</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>fromRoute</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>onComplete</span> <span class=o>&amp;&amp;</span> <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>onAbort</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>replace</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>current</span>: <span class=kt>fromRoute</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>replaceState</span><span class=p>(</span><span class=nx>cleanPath</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span> <span class=o>+</span> <span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleScroll</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>fromRoute</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>onComplete</span> <span class=o>&amp;&amp;</span> <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>onAbort</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>ensureURL</span><span class=p>(</span><span class=nx>push?</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>getLocation</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span><span class=p>)</span> <span class=o>!==</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=nx>cleanPath</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>push</span> <span class=o>?</span> <span class=nx>pushState</span><span class=p>(</span><span class=nx>current</span><span class=p>)</span> <span class=o>:</span> <span class=nx>replaceState</span><span class=p>(</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>getCurrentLocation</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>getLocation</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=hashhistory>HashHistory</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>HashHistory</span> <span class=kr>extends</span> <span class=nx>History</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>router</span>: <span class=kt>Router</span><span class=p>,</span> <span class=nx>base</span>: <span class=kt>?string</span><span class=p>,</span> <span class=nx>fallback</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>(</span><span class=nx>router</span><span class=p>,</span> <span class=nx>base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * checkFallback 会把 HTML5History 格式的链接转换为 HashHistory 格式的链接
</span></span></span><span class=line><span class=cl><span class=cm>     * 然后 location.replace 掉
</span></span></span><span class=line><span class=cl><span class=cm>     * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class=line><span class=cl><span class=cm>     * checkFallback =&gt; https://router.vuejs.org/zh/#/api/?abc=123#hahaha
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>fallback</span> <span class=o>&amp;&amp;</span> <span class=nx>checkFallback</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>base</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// /zh#/api/?abc=123#hahaha replace 成为 /zh/#/api/?abc=123#hahaha
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ensureSlash</span><span class=p>();</span> <span class=c1>// 保证 # 前边有 /
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 延迟到应用挂载，防止事件过早触发
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>setupListeners() {</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;hashchange&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>ensureSlash</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 获取 hash 并跳转
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span><span class=nx>getHash</span><span class=p>(),</span> <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>replaceHash</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>push</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 赋值 window.location.hash
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>pushHash</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>onComplete</span> <span class=o>&amp;&amp;</span> <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>onAbort</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>replace</span><span class=p>(</span><span class=nx>location</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=nx>onComplete?</span>: <span class=kt>Function</span><span class=p>,</span> <span class=nx>onAbort?</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>transitionTo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 window.location.replace
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>replaceHash</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>onComplete</span> <span class=o>&amp;&amp;</span> <span class=nx>onComplete</span><span class=p>(</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>onAbort</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>go</span><span class=p>(</span><span class=nx>n</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>go</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>ensureURL</span><span class=p>(</span><span class=nx>push?</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>current</span><span class=p>.</span><span class=nx>fullPath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>getHash</span><span class=p>()</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>push</span> <span class=o>?</span> <span class=nx>pushHash</span><span class=p>(</span><span class=nx>current</span><span class=p>)</span> <span class=o>:</span> <span class=nx>replaceHash</span><span class=p>(</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>getCurrentLocation() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>getHash</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=matcher>matcher</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createMatcher</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>routes</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>RouteConfig</span><span class=p>&gt;,</span> <span class=c1>// options.routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>router</span>: <span class=kt>VueRouter</span> <span class=c1>// VueRouter 实例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span><span class=o>:</span> <span class=nx>Matcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 把传入的路由表转换为路由映射表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>pathList</span><span class=p>,</span> <span class=nx>pathMap</span><span class=p>,</span> <span class=nx>nameMap</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>createRouteMap</span><span class=p>(</span><span class=nx>routes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// addRoutes 就是把新来的 routes 添加到 pathList, pathMap, nameMap 里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>addRoutes</span><span class=p>(</span><span class=nx>routes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createRouteMap</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=nx>pathList</span><span class=p>,</span> <span class=nx>pathMap</span><span class=p>,</span> <span class=nx>nameMap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据 RawLocation 和 currentRoute 返回一个 route
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>match</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>raw</span>: <span class=kt>RawLocation</span><span class=p>,</span> <span class=c1>// url 或者 Location 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>currentRoute?</span>: <span class=kt>Route</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirectedFrom?</span>: <span class=kt>Location</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Route</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>location</span> <span class=o>=</span> <span class=nx>normalizeLocation</span><span class=p>(</span><span class=nx>raw</span><span class=p>,</span> <span class=nx>currentRoute</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>router</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>name</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>location</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>record</span> <span class=o>=</span> <span class=nx>nameMap</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span> <span class=c1>// 获取 name 对应的 record
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>record</span><span class=p>)</span> <span class=k>return</span> <span class=nx>_createRoute</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>location</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>paramNames</span> <span class=o>=</span> <span class=nx>record</span><span class=p>.</span><span class=nx>regex</span><span class=p>.</span><span class=nx>keys</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>key</span><span class=p>.</span><span class=nx>optional</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=nx>key</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>location</span><span class=p>.</span><span class=nx>params</span> <span class=o>!==</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>location</span><span class=p>.</span><span class=nx>params</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>currentRoute</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>currentRoute</span><span class=p>.</span><span class=nx>params</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>currentRoute</span><span class=p>.</span><span class=nx>params</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>location</span><span class=p>.</span><span class=nx>params</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>paramNames</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>location</span><span class=p>.</span><span class=nx>params</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>currentRoute</span><span class=p>.</span><span class=nx>params</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>record</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>location</span><span class=p>.</span><span class=nx>path</span> <span class=o>=</span> <span class=nx>fillParams</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>record</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>location</span><span class=p>.</span><span class=nx>params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=sb>`named route &#34;</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>&#34;`</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>_createRoute</span><span class=p>(</span><span class=nx>record</span><span class=p>,</span> <span class=nx>location</span><span class=p>,</span> <span class=nx>redirectedFrom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>location</span><span class=p>.</span><span class=nx>params</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>pathList</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>pathList</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>record</span> <span class=o>=</span> <span class=nx>pathMap</span><span class=p>[</span><span class=nx>path</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>matchRoute</span><span class=p>(</span><span class=nx>record</span><span class=p>.</span><span class=nx>regex</span><span class=p>,</span> <span class=nx>location</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=nx>location</span><span class=p>.</span><span class=nx>params</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>_createRoute</span><span class=p>(</span><span class=nx>record</span><span class=p>,</span> <span class=nx>location</span><span class=p>,</span> <span class=nx>redirectedFrom</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>_createRoute</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>location</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>match</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>addRoutes</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=route-map>route-map</h2><p>传入 option.routes（开发者写的路由表）返回一个数组两个对象：</p><ol><li>所有路由的 path 组成的数组；</li><li>path 到 record 的映射关系；</li><li>name 到 record 的映射关系。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 对路由表（routes）进行数据结构的转换
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createRouteMap</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>routes</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>RouteConfig</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldPathList?</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;,</span> <span class=c1>// addRoutes 才用得上
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>oldPathMap?</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;,</span> <span class=c1>// addRoutes 才用得上
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>oldNameMap?</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;</span> <span class=c1>// addRoutes 才用得上
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 用来控制路径匹配优先级
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>pathList</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>oldPathList</span> <span class=o>||</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathMap</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>oldPathMap</span> <span class=o>||</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>nameMap</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>oldNameMap</span> <span class=o>||</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>routes</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>route</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>addRouteRecord</span><span class=p>(</span><span class=nx>pathList</span><span class=p>,</span> <span class=nx>pathMap</span><span class=p>,</span> <span class=nx>nameMap</span><span class=p>,</span> <span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 确保 path 为通配符的路由一直在结尾
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>pathList</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>pathList</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;*&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pathList</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>pathList</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=nx>l</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>i</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathList</span><span class=p>,</span> <span class=c1>// routePath[]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pathMap</span><span class=p>,</span> <span class=c1>// {path: record, ...}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>nameMap</span> <span class=c1>// {name: rocord, ...}
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>addRouteRecord</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>pathList</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>pathMap</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>nameMap</span>: <span class=kt>Dictionary</span><span class=p>&lt;</span><span class=nt>RouteRecord</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>route</span>: <span class=kt>RouteConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>parent?</span>: <span class=kt>RouteRecord</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>matchAs?</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>name</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 去除 path 最后的 /，并拼接上 parent.path
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>normalizedPath</span> <span class=o>=</span> <span class=nx>normalizePath</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathToRegexpOptions</span>: <span class=kt>PathToRegexpOptions</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nx>route</span><span class=p>.</span><span class=nx>pathToRegexpOptions</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>route</span><span class=p>.</span><span class=nx>caseSensitive</span> <span class=o>===</span> <span class=s1>&#39;boolean&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathToRegexpOptions</span><span class=p>.</span><span class=nx>sensitive</span> <span class=o>=</span> <span class=nx>route</span><span class=p>.</span><span class=nx>caseSensitive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据传入的 route 生成一个 record
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>record</span>: <span class=kt>RouteRecord</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span>: <span class=kt>normalizedPath</span><span class=p>,</span> <span class=c1>// 规范化之后的 path，带上父级路由的那种
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>regex</span>: <span class=kt>compileRouteRegex</span><span class=p>(</span><span class=nx>normalizedPath</span><span class=p>,</span> <span class=nx>pathToRegexpOptions</span><span class=p>),</span> <span class=c1>// 将 path 解析成正则表达式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 一条 path 可以对应多个 components，通过 router-view 的 name 属性来判断渲染出口
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>components</span>: <span class=kt>route.components</span> <span class=o>||</span> <span class=p>{</span> <span class=k>default</span><span class=o>:</span> <span class=nx>route</span><span class=p>.</span><span class=nx>component</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>instances</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parent</span><span class=p>,</span> <span class=c1>// ParentRouteRecord
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>matchAs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirect</span>: <span class=kt>route.redirect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>beforeEnter</span>: <span class=kt>route.beforeEnter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>meta</span>: <span class=kt>route.meta</span> <span class=o>||</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=nx>props</span>:
</span></span><span class=line><span class=cl>      <span class=kt>route.props</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>route</span><span class=p>.</span><span class=nx>components</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>route</span><span class=p>.</span><span class=nx>props</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=p>{</span> <span class=k>default</span><span class=o>:</span> <span class=nx>route</span><span class=p>.</span><span class=nx>props</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>children</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;如果 route 有 name，没有重定向，有一个默认的子路由，如果通过 name 进行导航，默认的子路由不会渲染&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>route</span><span class=p>.</span><span class=nx>children</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>child</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>childMatchAs</span> <span class=o>=</span> <span class=nx>matchAs</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>cleanPath</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>matchAs</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>child</span><span class=p>.</span><span class=nx>path</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// record 作为 children 的 parent，重新调用 addRouteRecord
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>addRouteRecord</span><span class=p>(</span><span class=nx>pathList</span><span class=p>,</span> <span class=nx>pathMap</span><span class=p>,</span> <span class=nx>nameMap</span><span class=p>,</span> <span class=nx>child</span><span class=p>,</span> <span class=nx>record</span><span class=p>,</span> <span class=nx>childMatchAs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果路由有别名，同样会生成一条 record
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>alias</span> <span class=o>!==</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>aliases</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>route</span><span class=p>.</span><span class=nx>alias</span><span class=p>)</span> <span class=o>?</span> <span class=nx>route</span><span class=p>.</span><span class=nx>alias</span> <span class=o>:</span> <span class=p>[</span><span class=nx>route</span><span class=p>.</span><span class=nx>alias</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>aliases</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>alias</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>aliasRoute</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span>: <span class=kt>alias</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span>: <span class=kt>route.children</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>addRouteRecord</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>pathList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>pathMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>nameMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>aliasRoute</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>record</span><span class=p>.</span><span class=nx>path</span> <span class=o>||</span> <span class=s1>&#39;/&#39;</span> <span class=c1>// matchAs
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>pathMap</span><span class=p>[</span><span class=nx>record</span><span class=p>.</span><span class=nx>path</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathList</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>record</span><span class=p>.</span><span class=nx>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathMap</span><span class=p>[</span><span class=nx>record</span><span class=p>.</span><span class=nx>path</span><span class=p>]</span> <span class=o>=</span> <span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>nameMap</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>nameMap</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>record</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=router-link>router-link</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;router-link&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>to</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Object</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>required</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// router-link 默认就是 a 标签
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tag</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span> <span class=s1>&#39;a&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>exact</span>: <span class=kt>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>append</span>: <span class=kt>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>replace</span>: <span class=kt>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>activeClass</span>: <span class=kt>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exactActiveClass</span>: <span class=kt>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>event</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Array</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span> <span class=s1>&#39;click&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>(</span><span class=nx>h</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$router</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>location</span><span class=p>,</span> <span class=nx>route</span><span class=p>,</span> <span class=nx>href</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>to</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>current</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>append</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>classes</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>globalActiveClass</span> <span class=o>=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>linkActiveClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>globalExactActiveClass</span> <span class=o>=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>linkExactActiveClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 不同状态的类名处理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>activeClassFallback</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>globalActiveClass</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=s1>&#39;router-link-active&#39;</span> <span class=o>:</span> <span class=nx>globalActiveClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>exactActiveClassFallback</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>globalExactActiveClass</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=s1>&#39;router-link-exact-active&#39;</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>globalExactActiveClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>activeClass</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>activeClass</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=nx>activeClassFallback</span> : <span class=kt>this.activeClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>exactActiveClass</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>exactActiveClass</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>exactActiveClassFallback</span>
</span></span><span class=line><span class=cl>        : <span class=kt>this.exactActiveClass</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>compareTarget</span> <span class=o>=</span> <span class=nx>location</span><span class=p>.</span><span class=nx>path</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>createRoute</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>location</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=nx>route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>classes</span><span class=p>[</span><span class=nx>exactActiveClass</span><span class=p>]</span> <span class=o>=</span> <span class=nx>isSameRoute</span><span class=p>(</span><span class=nx>current</span><span class=p>,</span> <span class=nx>compareTarget</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>classes</span><span class=p>[</span><span class=nx>activeClass</span><span class=p>]</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>exact</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>classes</span><span class=p>[</span><span class=nx>exactActiveClass</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=nx>isIncludedRoute</span><span class=p>(</span><span class=nx>current</span><span class=p>,</span> <span class=nx>compareTarget</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>handler</span> <span class=o>=</span> <span class=nx>e</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 按下 meta、alt、ctrl、shift 时不起作用
</span></span></span><span class=line><span class=cl><span class=cm>       * 调用 preventDefault 时不起作用
</span></span></span><span class=line><span class=cl><span class=cm>       * target=_blank 时不起作用
</span></span></span><span class=line><span class=cl><span class=cm>       * 右键点击时不起作用
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>guardEvent</span><span class=p>(</span><span class=nx>e</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 调用 replace 和 push
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>replace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>router</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=nx>location</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>location</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>on</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>click</span>: <span class=kt>guardEvent</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>event</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>e</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果绑定了多个事件处理，也仅绑定在 click 上
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>on</span><span class=p>[</span><span class=nx>e</span><span class=p>]</span> <span class=o>=</span> <span class=nx>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>on</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>event</span><span class=p>]</span> <span class=o>=</span> <span class=nx>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span>: <span class=kt>any</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>class</span><span class=o>:</span> <span class=nx>classes</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建 a 链接之后，会在 a 链接上绑定 href 属性和 click 事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>href</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 找到子元素中的 a 标签，在上面加 listener 和 href
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>findAnchor</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将 a 标签上已有的属性和 on/href 进行合并
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>a</span><span class=p>.</span><span class=nx>isStatic</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>extend</span> <span class=o>=</span> <span class=nx>_Vue</span><span class=p>.</span><span class=nx>util</span><span class=p>.</span><span class=nx>extend</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>aData</span> <span class=o>=</span> <span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>data</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({},</span> <span class=nx>a</span><span class=p>.</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>aData</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>aAttrs</span> <span class=o>=</span> <span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({},</span> <span class=nx>a</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>aAttrs</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=nx>href</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 没 a 标签，那就把 listener 加到自己身上
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>data</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>h</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=router-view>router-view</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;router-view&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>functional</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span> <span class=s1>&#39;default&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>(</span><span class=nx>_</span><span class=p>,</span> <span class=p>{</span> <span class=nx>props</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>data</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>.</span><span class=nx>routerView</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 借用父级的 h 函数，酱紫 router-view 渲染的组件可以解析具名插槽
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>h</span> <span class=o>=</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>$createElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当同一层级同时有多个 router-view 存在时，会通过 name 属性来确定渲染哪个组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>route</span> <span class=o>=</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>$route</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cache</span> <span class=o>=</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>_routerViewCache</span> <span class=o>||</span> <span class=p>(</span><span class=nx>parent</span><span class=p>.</span><span class=nx>_routerViewCache</span> <span class=o>=</span> <span class=p>{});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前 router-view 所处的层级（嵌套深度，上层还有几个 router-view），顺便检查当前是否 active
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>depth</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>inactive</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * this._routerRoot = this.$parent._routerRoot
</span></span></span><span class=line><span class=cl><span class=cm>     * 非根组件的 _routerRoot 指向父级 _routerRoot
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>parent</span> <span class=o>&amp;&amp;</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>_routerRoot</span> <span class=o>!==</span> <span class=nx>parent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果父级组件中有一层 routerView，depth++
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>parent</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>routerView</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>depth</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果父级没有被激活，当前组件也不应激活，和 keep-active 组件有关
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>parent</span><span class=p>.</span><span class=nx>_inactive</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>inactive</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>parent</span> <span class=o>=</span> <span class=nx>parent</span><span class=p>.</span><span class=nx>$parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>.</span><span class=nx>routerViewDepth</span> <span class=o>=</span> <span class=nx>depth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是 inactive 状态，渲染前一个视图
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>inactive</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>h</span><span class=p>(</span><span class=nx>cache</span><span class=p>[</span><span class=nx>name</span><span class=p>],</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前 route 下，对应层级有没有要渲染的组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>matched</span> <span class=o>=</span> <span class=nx>route</span><span class=p>.</span><span class=nx>matched</span><span class=p>[</span><span class=nx>depth</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 没有匹配上，就渲染空节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>matched</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cache</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>h</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取匹配到的组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>component</span> <span class=o>=</span> <span class=p>(</span><span class=nx>cache</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>matched</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// data 上保存了一个函数，被实例注入的生命周期钩子调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>data</span><span class=p>.</span><span class=nx>registerRouteInstance</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>current</span> <span class=o>=</span> <span class=nx>matched</span><span class=p>.</span><span class=nx>instances</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=nx>val</span> <span class=o>&amp;&amp;</span> <span class=nx>current</span> <span class=o>!==</span> <span class=nx>vm</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=o>!</span><span class=nx>val</span> <span class=o>&amp;&amp;</span> <span class=nx>current</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>matched</span><span class=p>.</span><span class=nx>instances</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>hook</span> <span class=o>||</span> <span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>hook</span> <span class=o>=</span> <span class=p>{})).</span><span class=nx>prepatch</span> <span class=o>=</span> <span class=p>(</span><span class=nx>_</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>matched</span><span class=p>.</span><span class=nx>instances</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 解析 props
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>data</span><span class=p>.</span><span class=nx>props</span> <span class=o>=</span> <span class=nx>resolveProps</span><span class=p>(</span><span class=nx>route</span><span class=p>,</span> <span class=nx>matched</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>matched</span><span class=p>.</span><span class=nx>props</span><span class=p>[</span><span class=nx>name</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 h 函数，渲染匹配到的组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>h</span><span class=p>(</span><span class=nx>component</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>总之，VueRouter 在初始化的时候，会向组件 mixin 一些钩子函数；在 beforeCreate 中，会借助 Vue.util.defineReactive API 将 vm._route 转换为 getter/setter；又因为 router-view 在调用 h 函数渲染组件的时候，会访问 vm._route.matched，router-view 所在实例的 renderWatcher 形成对 vm._route 的依赖。所以，每当 vm._route 变化，router-view 会自动匹配自己要渲染的组件。</p><p>router-link 默认会渲染出一个绑定了事件的 a 标签，用户点击时，会调用 transitionTo 进行导航；transitionTo 会计算出最新的 route，调用 History API 更新 URL，调用路由钩子，更新 vm._route，触发 router-view 更新。</p><p>至于 popstate 事件，主要用来处理浏览器的行为（history.pushState/replaceState 并不会触发 popstate）并调用 transitionTo 更新页面。</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue 2.x/3.x 比较（基于源码）</h2></div></a></article><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8E%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%8F%92%E6%A7%BD%E7%9A%84-renderless-%E7%BB%84%E4%BB%B6/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>基于作用域插槽的 Renderless 组件</h2></div></a></article><article class=has-image><a href=/p/vue-composition-api/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue Composition API</h2></div></a></article><article class=has-image><a href=/p/vue-3.0-%E6%9D%A5%E4%BA%86/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue 3.0 来了</h2></div></a></article><article class=has-image><a href=/p/vue-2.x-%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue 2.x 复习总结</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2024
<a href=https://github.com/Vikingama target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#vueuserouter>Vue.use(Router)</a></li><li><a href=#vuerouter>VueRouter</a></li><li><a href=#basehistory>BaseHistory</a></li><li><a href=#html5history>HTML5History</a></li><li><a href=#hashhistory>HashHistory</a></li><li><a href=#matcher>matcher</a></li><li><a href=#route-map>route-map</a></li><li><a href=#router-link>router-link</a></li><li><a href=#router-view>router-view</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script></body></html>