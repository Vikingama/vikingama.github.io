<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='最近在看 Vue 源码，顺手做下笔记'><title>Vue 2.x/3.x 比较（基于源码） · Stay Hungry · Stay Foolish</title>
<link rel=canonical href=https://vikingama.github.io/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81/><link rel=stylesheet href=/scss/style.min.38c15d3a5c1bca30008bb625a46636d24f5deb4bf3217095e667a3abc843eaef.css><meta property='og:title' content='Vue 2.x/3.x 比较（基于源码）'><meta property='og:description' content='最近在看 Vue 源码，顺手做下笔记'><meta property='og:url' content='https://vikingama.github.io/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2021-10-24T00:00:00+00:00'><meta property='article:modified_time' content='2021-10-24T00:00:00+00:00'><meta property='og:image' content='https://vikingama.github.io/img/cover/vue.png'><meta name=twitter:title content="Vue 2.x/3.x 比较（基于源码）"><meta name=twitter:description content="最近在看 Vue 源码，顺手做下笔记"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://vikingama.github.io/img/cover/vue.png'><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=theme-color content="#ffffff"><meta name=robots content="noarchive"><div class=warning-banner>因为 GitHub 账号二次验证失败，计划迁往
<a href=https://elementref.github.io/>新地址&rarr;</a></div></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huae06eac29c2bc6aa7e83a685ea2f6536_13838_300x0_resize_box_3.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>Stay Hungry · Stay Foolish</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=https://github.com/ElementRef/AboutConfig target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg>
<span>配置</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81/><img src=/img/cover/vue.png loading=lazy alt="Vue 2.x/3.x 比较（基于源码）"></a></div><div class=article-details><header class=article-category><a href=/categories/vue/>Vue</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83%E5%9F%BA%E4%BA%8E%E6%BA%90%E7%A0%81/>Vue 2.x/3.x 比较（基于源码）</a></h2><h3 class=article-subtitle>最近在看 Vue 源码，顺手做下笔记</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 24, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：88 分钟</time></div></footer></div></header><section class=article-content><h2 id=响应式原理-2x>响应式原理 2.x</h2><p>Dep 用来存放/管理订阅者（watcher）的对象；每个 Dep 实例都存在于<strong>对象每个属性对应的 getter/setter 所在的闭包里</strong>并且都有唯一的 id。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Dep</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span> <span class=o>=</span> <span class=p>[];</span> <span class=c1>// 存放着 watchers（订阅者）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>addSub</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>sub</span><span class=p>);</span> <span class=c1>// 将 watcher 添加到列表（一般由 watcher 调用）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>removeSub</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>,</span> <span class=nx>sub</span><span class=p>);</span> <span class=c1>// 从列表移除 watcher
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>depend() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 进行依赖收集时，Dep.target 会指向待被收集的 watcher
</span></span></span><span class=line><span class=cl><span class=cm>       * dep.depend 调用 watcher 的 addDep 方法
</span></span></span><span class=line><span class=cl><span class=cm>       * watcher.addDep 会调用 dep.addSub
</span></span></span><span class=line><span class=cl><span class=cm>       * 把对方“记录”下来
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>addDep</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>notify() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环“订阅者列表”，触发 watcher.update，告诉它们“数据变了”
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>subs</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>slice</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>subs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>subs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>update</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 用来指向某个正在被求值/调用的 watcher/副作用函数
</span></span></span><span class=line><span class=cl><span class=cm> * 某个时间点，仅有一个 watcher 可以被求值
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 更新粒度是组件级的，每个组件的 render 相当于一个 watcher
</span></span></span><span class=line><span class=cl><span class=cm> * 组件嵌套成树就映射为 render 的调用栈，保存在“栈”里
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>targetStack</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=c1>// 收集依赖之前调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>pushTarget</span><span class=p>(</span><span class=nx>target</span>: <span class=kt>?Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>targetStack</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span> <span class=o>=</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 收集依赖完成调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>popTarget() {</span>
</span></span><span class=line><span class=cl>  <span class=nx>targetStack</span><span class=p>.</span><span class=nx>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 回退到上一个 Dep.target，因为上一个 target 已经出栈了
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span> <span class=o>=</span> <span class=nx>targetStack</span><span class=p>[</span><span class=nx>targetStack</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Watcher 实例被称作<strong>需要被收集起来的依赖者</strong>或者订阅者，它<strong>依赖/观察/订阅</strong>了数据变动（在依赖收集期间，或者 watcher 被调用期间，访问了数据的 getter）；数据的 getter 被触发时，watcher 会被收集起来（Dep.target 被收集起来）；数据的 setter 被调用时，dep.notify 会触发 watcher.update，即 watcher 得到了通知，需要重新执行：</p><ul><li>在 mountComponent 中会 new Watcher(&mldr;) 作为组件的 renderWatcher；同时在组件 update 时，会调用 watcher.before 来触发 beforeUpdate 钩子；</li><li>每个 vm.$watch 或者 watchOptions 都会 new Watcher(&mldr;)；</li><li>组件的 computedOptions 也会 new Watcher(&mldr;)。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Watcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 每个响应式数据都有自己的 Dep 实例（存在于闭包中）来管理依赖于自己的 watcher
</span></span></span><span class=line><span class=cl><span class=cm>   * 每当访问数据，会触发数据的 getter，将 Dep.target 添加到 dep.subs 列表
</span></span></span><span class=line><span class=cl><span class=cm>   * 每当数据变化，会触发数据的 setter，遍历 dep.subs 调用 watcher.update
</span></span></span><span class=line><span class=cl><span class=cm>   * 每个 watcher 都维护了一份 dep 列表，通过 watch.addDep 收集的
</span></span></span><span class=line><span class=cl><span class=cm>   * 当 watcher 销毁时，需要调用 dep.removeSub
</span></span></span><span class=line><span class=cl><span class=cm>   * 告诉 dep 数据再发生变化，别通知我了
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>,</span> <span class=c1>// 组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>expOrFn</span><span class=p>,</span> <span class=c1>// a.b.c || () =&gt; a.b.c
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cb</span><span class=p>,</span> <span class=c1>// 副作用回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>options</span><span class=p>,</span> <span class=c1>// computed || deep || lazy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isRenderWatcher</span> <span class=c1>// 是否是 renderWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>vm</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isRenderWatcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果是 renderWatcher，就保存在 vm._watcher 属性上
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_watcher</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// vm._watchers 是一个数组，保存着组件的 renderWatcher、computedWatchers 和 watchWatchers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>before</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>before</span><span class=p>;</span> <span class=c1>// watcher.run 执行之前先要执行的逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>deep</span><span class=p>;</span> <span class=c1>// deep: true || false
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>lazy</span><span class=p>;</span> <span class=c1>// 是否是 computedWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>sync</span><span class=p>;</span> <span class=c1>// immediate: true || false
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>user</span><span class=p>;</span> <span class=c1>// 是否是 watchWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// watcher 是否存活，teardown 之后被置为 false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>=</span> <span class=nx>cb</span><span class=p>;</span> <span class=c1>// 保存回调
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span><span class=p>;</span> <span class=c1>// computedGetter 被触发时，会判断数据『是否&#34;脏&#34;了』，脏了的话，就会重新求最新值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=o>++</span><span class=nx>uid</span><span class=p>;</span> <span class=c1>// 唯一的标识，批处理用的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 为什么会有 deps、newDeps、depIds、newDepIds？
</span></span></span><span class=line><span class=cl><span class=cm>     * 假设 vm.$watch(() =&gt; vm.a ? vm.b : vm.c, () =&gt; {...})
</span></span></span><span class=line><span class=cl><span class=cm>     * 上一次收集的依赖和这一次收集的依赖可能不一样（取决于 vm.a 的值）
</span></span></span><span class=line><span class=cl><span class=cm>     * 当 vm.a 为 true 时，收集的依赖为 vm.a、vm.b
</span></span></span><span class=line><span class=cl><span class=cm>     * 当 vm.a 为 false 时，收集的依赖为 vm.a、vm.c
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>expression</span> <span class=o>=</span> <span class=nx>expOrFn</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span> <span class=c1>// 为了方便报错提示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 解析 expOrFn 为 getter，有两种形式：
</span></span></span><span class=line><span class=cl><span class=cm>     * 1. 属性路径：a.b.c 指向的数据会被 watcher 订阅
</span></span></span><span class=line><span class=cl><span class=cm>     * 2. 函数：function () {
</span></span></span><span class=line><span class=cl><span class=cm>     *      函数里访问的所有数据会被 watcher 订阅
</span></span></span><span class=line><span class=cl><span class=cm>     *      任何数据变化都会通知 watcher
</span></span></span><span class=line><span class=cl><span class=cm>     * }
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>expOrFn</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>expOrFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 将点语法转换为函数调用：
</span></span></span><span class=line><span class=cl><span class=cm>       * a.b.c 转换为 () =&gt; a.b.c
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>parsePath</span><span class=p>(</span><span class=nx>expOrFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>noop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果不是 computedWatcher，则在实例化的过程中调用 get 对 expOrFn 进行求值
</span></span></span><span class=line><span class=cl><span class=cm>     * 1. 先运行一次，完成依赖收集
</span></span></span><span class=line><span class=cl><span class=cm>     * 2. 作为 prevValue
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>?</span> <span class=kc>undefined</span> <span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=kr>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 求值并重新出发依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 将 Dep.target 设置为当前 watcher
</span></span></span><span class=line><span class=cl><span class=cm>     * 并将当前 watcher 推进 targetStack
</span></span></span><span class=line><span class=cl><span class=cm>     * 当前 watcher 被添加到对应的依赖列表
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>pushTarget</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 求值的过程中，当前 watcher 被收集起来
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 对 watchOption 进行报错
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>handleError</span><span class=p>(</span><span class=sb>`getter for watcher &#34;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果要深层监听数据变化的话
</span></span></span><span class=line><span class=cl><span class=cm>       * 递归的触发每个属性的 getter
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>traverse</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 恢复上一个 Dep.target 的值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>popTarget</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 清理依赖
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>cleanupDeps</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 保存 dep 并调用 dep.addSub(watcher)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>addDep</span><span class=p>(</span><span class=nx>dep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>dep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>depIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>addSub</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>teardown() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将自己从组件的 _watchers 里移除
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 告诉所有“收集了 this 作为订阅者”的 dep
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 完成销毁
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果副作用中出现 a ? b : c 条件访问时，能够清除上次的依赖关系
</span></span></span><span class=line><span class=cl><span class=cm>   * cleanupDeps 应该在每次运行副作用之前调用
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>cleanupDeps() {</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>dep</span><span class=p>.</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=nx>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=nx>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 watcher.addDep(dep)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>depend() {</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>depend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 依赖变化，会调用 update（dep.notify 调用的），执行副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>update() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>lazy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果是 computed，将 watcher 标记为“脏”的
</span></span></span><span class=line><span class=cl><span class=cm>       * 当访问 computed 的值时，会在 computedGetter 里调用 watcher.evaluate 求值
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sync</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 立即调用 run 方法，重新求值并执行回调，一般用来在组件初始化阶段执行一次 cb
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 把 watcher 加入异步队列
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>queueWatcher</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * watcher 接收到通知后，如果实例没被销毁
</span></span></span><span class=line><span class=cl><span class=cm>   * 重新访问 getter 获取最新值
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果数据和之前的不一样
</span></span></span><span class=line><span class=cl><span class=cm>   * 或者数据是对象或数组
</span></span></span><span class=line><span class=cl><span class=cm>   * 或者开启了深层监听
</span></span></span><span class=line><span class=cl><span class=cm>   * 说明数据变化了
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要执行回调
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>run() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=kr>get</span><span class=p>();</span> <span class=c1>// 重新求值作为最新的值，并对比前后值；数据变化才会执行 cb
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>value</span> <span class=o>!==</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>||</span> <span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将新/旧值都传给回调
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 给 computed 惰性求值用的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>evaluate() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=kr>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 求值完了之后，会标记为『干净』
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>defineReactive 通过调用 Object.defineProperty 将 o[k（可配置属性）] 转化为 getter/setter（访问器）的形式，并在闭包内实例化了一个 Dep，用于保存收集的 watcher：</p><ul><li>初始化依赖注入时，会调用 defineReactive(vm, key, (resolveInject(vm.$options.inject, vm))[key])；</li><li>初始化渲染函数时，会调用 defineReactive(vm, &lsquo;$attrs/$listeners&rsquo;, &mldr;)；</li><li>初始化 props 时，会调用 defineReactive(props, key, value)；</li><li>作为 Vue.util.defineReactive 工具函数使用；</li><li>每次调用 vm.$set 都会调用 defineReactive；</li><li>new Observer() 会调用 defineReactive。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 将 obj[key] 转换为 getter/setters 形式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>val</span><span class=p>,</span> <span class=nx>customSetter</span><span class=p>,</span> <span class=nx>shallow</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>property</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>getOwnPropertyDescriptor</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 属性不可配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>configurable</span> <span class=o>===</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Vue 的响应式 + 依赖收集，会有很多闭包产生
</span></span></span><span class=line><span class=cl><span class=cm>   * React 也会在内存中渲染一个完整的 WIP 树
</span></span></span><span class=line><span class=cl><span class=cm>   * 不知道使用 Vue/React 开发的网站
</span></span></span><span class=line><span class=cl><span class=cm>   * 内存占用情况会不会很糟糕
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果之前设置过 getter/setter，先将他们保存下来
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>getter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=kr>get</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=kr>set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>getter</span> <span class=o>||</span> <span class=nx>setter</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>val</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果要深层转换并且 val 是复杂数据的话，递归调用 observe
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>val</span><span class=p>);</span> <span class=c1>// val.__ob__ || undefined
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>enumerable</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>configurable</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>get</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveGetter() {</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * watcher 的 getter 被调用之前会执行 pushTarget
</span></span></span><span class=line><span class=cl><span class=cm>       * 将 Dep.target 设置为 watcher，并把自身 push 到 targetStack
</span></span></span><span class=line><span class=cl><span class=cm>       * 调用 dep.depend，进而调用 watcher.addDep 方法
</span></span></span><span class=line><span class=cl><span class=cm>       * 最终，watcher 被收集到 dep.subs 里，dep 被 push 到 watcher.dep 里
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>childOb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 子项的 dep 也要收集 Dep.target
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>childOb</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 有多个依赖项目
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dependArray</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 返回给 watcher 的返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=kr>set</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveSetter</span><span class=p>(</span><span class=nx>newVal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对 newVal 和 value 进行浅比较，没变化就返回
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>===</span> <span class=nx>value</span> <span class=o>||</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>!==</span> <span class=nx>newVal</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span> <span class=o>!==</span> <span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>customSetter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 自定义 setter（比如，computed 可以自定义 setter）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>customSetter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 只读属性，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>getter</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>setter</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>setter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>newVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>val</span> <span class=o>=</span> <span class=nx>newVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>newVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * dep.notify 会循环 dep.subs，调用每个 watcher.update
</span></span></span><span class=line><span class=cl><span class=cm>       * watcher 接到通知，会根据“配置”执行相应动作
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 收集数组元素上的依赖关系，因为无法对数组元素的访问做拦截
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>dependArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>e</span><span class=p>,</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span> <span class=o>=</span> <span class=nx>value</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span> <span class=o>&amp;&amp;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>__ob__</span> <span class=o>&amp;&amp;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>e</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 递归调用
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>dependArray</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>observe(value) 会返回一个 Observer 实例（对 value 的观察者），这个实例挂载在 value.__ob__ 上，而且是单例的；同时，观察者对象的 value 指向被观察对象，形成循环引用；observe(value) 会通过判断 value 类型，将其转化为响应式对象/数组：</p><ul><li>作为 Vue.observable 工具函数使用（返回的对象是响应式的，可直接用于 Vue 渲染）；</li><li>在初始化组件状态时，会调用 observe(vm.$options.data)；</li><li>需要深层响应的场景，会递归调用 observe。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 为“值”创建观察者实例的工厂函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>asRootData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// value 不能是 VNode，只能对对象进行 observe
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>value</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>ob</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasOwn</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span> <span class=k>instanceof</span> <span class=nx>Observer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 观察者实例保存在 __ob__ 属性上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ob</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>shouldObserve</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Object</span><span class=p>.</span><span class=nx>isExtensible</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>value</span><span class=p>.</span><span class=nx>_isVue</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Observer</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>asRootData</span> <span class=o>&amp;&amp;</span> <span class=nx>ob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span><span class=p>.</span><span class=nx>vmCount</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ob</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 对数组部分方法进行遮蔽（不涉及 Array.prototype 的修改）
</span></span></span><span class=line><span class=cl><span class=cm> * 这也表明了为什么 arr[i] = j、arr.length = 0 不会触发更新
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>arrayProto</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>prototype</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>arrayMethods</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>arrayProto</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=s1>&#39;push&#39;</span><span class=p>,</span> <span class=s1>&#39;pop&#39;</span><span class=p>,</span> <span class=s1>&#39;shift&#39;</span><span class=p>,</span> <span class=s1>&#39;unshift&#39;</span><span class=p>,</span> <span class=s1>&#39;splice&#39;</span><span class=p>,</span> <span class=s1>&#39;sort&#39;</span><span class=p>,</span> <span class=s1>&#39;reverse&#39;</span><span class=p>].</span><span class=nx>forEach</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将原来的方法保存在闭包里
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>original</span> <span class=o>=</span> <span class=nx>arrayProto</span><span class=p>[</span><span class=nx>method</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nx>def</span><span class=p>(</span><span class=nx>arrayMethods</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>mutator</span><span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 缓存正常操作的结果
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>original</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>ob</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>inserted</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 获取新插入的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>switch</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;push&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;unshift&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=s1>&#39;splice&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 先单独对新插入的数据进行“观察”
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>inserted</span><span class=p>)</span> <span class=nx>ob</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>inserted</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通知“订阅者”
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>ob</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 对传入的 value 进行 defineReactive 转化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Observer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 保存订阅了 value 本身的 watcher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将此对象作为 rootData 的 Vue 实例数量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>vmCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 observer 保存到 __ob__ 属性上
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>def</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对于数组，重写原型链上的数组操作方法
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>value</span><span class=p>.</span><span class=nx>__proto__</span> <span class=o>=</span> <span class=nx>arrayMethods</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 并对数组的子元素依次调用 observe
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对于对象，遍历 value，将其可枚举属性转换为 getter/setter 形式
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>walk</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>walk</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>observeArray</span><span class=p>(</span><span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>items</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>observe</span><span class=p>(</span><span class=nx>items</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 beforeMount 和 mounted 钩子之间（mountComponent），会初始化组件 watcher（renderWatcher）；renderWatcher 保存在 vm._watcher（一个组件仅有一个 renderWatcher），同时还保存在 vm._watchers 数组里（存放着组件涉及到的所有 watcher，比如 computed、watch 等）。renderWatcher 的 getter 为 updateComponent，当调用 vm._render 时，会触发所有在渲染函数中用到的数据的 getter（会执行 updateComponent.call(vm, vm)）。函数访问到的数据的 getter 会把 renderWatcher 添加到自己的 dep.subs 列表中；当数据变化，响应式数据 setter 被触发，dep.notify 将调用 watcher.update，将执行 queueWatcher 把 watcher 添加到更新队列，更新队列会在合适的时候调用 watcher.run 触发页面更新（生成 VNode，再 patch 到 DOM，过程中会经历 diff）。</p><h2 id=响应式原理-3x>响应式原理 3.x</h2><p>createReactiveObject 用来将普通对象（Object、Array、Map、Set、WeakMap、WeakSet）通过 Proxy + handlers 代理为响应式数据：</p><ol><li>reactive 对应的 handler：<strong>mutableHandlers</strong>, <strong>mutableCollectionHandlers</strong>；</li><li>shallowReactive 对应的 handler：<strong>shallowReactiveHandlers</strong>, <strong>shallowCollectionHandlers</strong>；</li><li>readonly 对应的 handler：<strong>readonlyHandlers</strong>, <strong>readonlyCollectionHandlers</strong>；</li><li>shallowReadonly 对应的 handler：<strong>shallowReadonlyHandlers</strong>, <strong>readonlyCollectionHandlers</strong>。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>reactiveMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>&lt;</span><span class=nt>Target</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>readonlyMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>&lt;</span><span class=nt>Target</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createReactiveObject</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span>: <span class=kt>Target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isReadonly</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>baseHandlers</span>: <span class=kt>ProxyHandler</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>collectionHandlers</span>: <span class=kt>ProxyHandler</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 只有 Object、Array、Map、Set、WeakMap、WeakSet 才可以转换为响应式数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// target 已经不是原始数据，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>__v_raw</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>target</span><span class=p>.</span><span class=nx>__v_isReactive</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>proxyMap</span> <span class=o>=</span> <span class=nx>isReadonly</span> <span class=o>?</span> <span class=nx>readonlyMap</span> : <span class=kt>reactiveMap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 每次调用 createReactiveObject 都会创建一个新的代理对象
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果 target 对应的代理对象已经存在？就不需要重新创建
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>existingProxy</span> <span class=o>=</span> <span class=nx>proxyMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>existingProxy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>existingProxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>__v_skip</span> <span class=o>||</span> <span class=o>!</span><span class=nb>Object</span><span class=p>.</span><span class=nx>isExtensible</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>toRawType</span> <span class=o>=</span> <span class=nx>v</span> <span class=o>=&gt;</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>toString</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>v</span><span class=p>).</span><span class=nx>slice</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>targetTypeMap</span><span class=p>(</span><span class=nx>toRawType</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=o>===</span> <span class=nx>TargetType</span><span class=p>.</span><span class=nx>INVALID</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Proxy 只能拦截对象的基本（单一）操作：get、set、apply...
</span></span></span><span class=line><span class=cl><span class=cm>   * 而不能拦截对象的复合操作，例如：object.fn()；包含了两个操作：读取 get 和调用 apply
</span></span></span><span class=line><span class=cl><span class=cm>   * 任何 Proxy 可以拦截的操作，Reflect 里都能找到对应的同名函数，提供了这些操作的默认行为
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>proxy</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Proxy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Object、Array 使用 baseHandlers
</span></span></span><span class=line><span class=cl><span class=cm>     * Map、Set、WeakMap、WeakSet 使用 collectionHandlers
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>targetType</span> <span class=o>===</span> <span class=nx>TargetType</span><span class=p>.</span><span class=nx>COLLECTION</span> <span class=o>?</span> <span class=nx>collectionHandlers</span> : <span class=kt>baseHandlers</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将创建的代理对象记录下来，防止重复创建
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>proxyMap</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>proxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>proxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>reactive 通过调用 createReactiveObject 来创建原始对象的响应式副本，这种转换是深层的，reactive 会影响所有嵌套属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>reactive</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// readonly 数据直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span> <span class=o>&amp;&amp;</span> <span class=nx>target</span><span class=p>.</span><span class=nx>__v_isReadonly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 Proxy 对 target 进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>createReactiveObject</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * baseHandlers
</span></span></span><span class=line><span class=cl><span class=cm>     * track: get、has、ownKeys
</span></span></span><span class=line><span class=cl><span class=cm>     * trigger: set、deleteProperty
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_isReactive&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_isReadonly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_raw&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>receiver</span> <span class=o>===</span> <span class=nx>reactiveMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 无论是 readonly 还是 reactive，访问 __v_raw 都能得到原始数据
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>targetIsArray</span> <span class=o>=</span> <span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 target 是数组，并且对 target 的操作 key 存在于 arrayInstrumentations 中，就劫持操作
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>targetIsArray</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>arrayInstrumentations</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * arrayInstrumentations 包含了对数组方法的劫持：
</span></span></span><span class=line><span class=cl><span class=cm>           * __proto__
</span></span></span><span class=line><span class=cl><span class=cm>           * [Symbol.iterator]
</span></span></span><span class=line><span class=cl><span class=cm>           * concat
</span></span></span><span class=line><span class=cl><span class=cm>           * entries
</span></span></span><span class=line><span class=cl><span class=cm>           * every
</span></span></span><span class=line><span class=cl><span class=cm>           * ...
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>arrayInstrumentations</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 使用 Reflect 而不是使用 target[key] 是因为：
</span></span></span><span class=line><span class=cl><span class=cm>         * 我们只希望副作用和“代理对象”产生关联，而不是和 target（原始对象）
</span></span></span><span class=line><span class=cl><span class=cm>         * 这里的 receiver 指向了代理对象 proxy，指的是访问“谁”的 key（this 是“谁”）
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果 key 是内建 Symbol 或者是 __proto__/__v_isRef，不需要依赖收集，直接返回
</span></span></span><span class=line><span class=cl><span class=cm>         * 因为 for...of 只需要和数组 length 和 index 之间建立联系就好
</span></span></span><span class=line><span class=cl><span class=cm>         * 不需要追踪 [Symbol.iterator] 的变化
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSymbol</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=nx>builtInSymbols</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=nx>key</span> <span class=o>===</span> <span class=sb>`__proto__`</span> <span class=o>||</span> <span class=nx>key</span> <span class=o>===</span> <span class=sb>`__v_isRef`</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 追踪依赖
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>track</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过 res.__v_isRef 进行判断
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>res</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 target 是一个数组且 key 是一个整数，就不应该把 res 自动展开
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>shouldUnwrap</span> <span class=o>=</span> <span class=o>!</span><span class=p>(</span><span class=nx>targetIsArray</span> <span class=o>&amp;&amp;</span> <span class=nx>isIntegerKey</span><span class=p>(</span><span class=nx>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 自动展开
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>shouldUnwrap</span> <span class=o>?</span> <span class=nx>res.value</span> : <span class=kt>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>res</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 res 是 Object，对 res 调用 reactive
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>reactive</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 target 不是数组，旧值为 ref，新值不为 ref
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isRef</span><span class=p>(</span><span class=nx>oldValue</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 更新旧值的 value
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>oldValue</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>hadKey</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isIntegerKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=c1>// 通过数组下标直接更新，并且 key 是否小于数组长度
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=nb>Number</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nx>target</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=c1>// 否则使用 hasOwnProperty 判断
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果 child 继承自 parent，bar 属性只存在于 parent 上
</span></span></span><span class=line><span class=cl><span class=cm>         * 对 child.bar 修改，会同时影响 child 和 parent 的依赖收集
</span></span></span><span class=line><span class=cl><span class=cm>         * target 是 receiver 的原始对象时，才触发副作用，排除原型链的影响
</span></span></span><span class=line><span class=cl><span class=cm>         * 才能避免依赖被重复收集（parent 和 child 的 proxy 都收集同一个依赖于 child.bar 的副作用）
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>target</span> <span class=o>===</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>receiver</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * hadKey 用来区分 set 操作是修改了已有属性还是新增了新的属性
</span></span></span><span class=line><span class=cl><span class=cm>           * 因为新增属性需要触发“迭代器”的副作用执行
</span></span></span><span class=line><span class=cl><span class=cm>           * 而更新属性值不需要触发“迭代器”
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// key 不存在（Array 同理，会触发数组 length 的变化），add 行为
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;add&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>hasChanged</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// key 存在，并且值有变化，set 行为
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;set&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对应 in 操作符
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>has</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>Reflect</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isSymbol</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>||</span> <span class=o>!</span><span class=nx>builtInSymbols</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>track</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;has&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对应 delete 操作符
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>deleteProperty</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=p>(</span><span class=nx>target</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 不同于 delete 操作返回“删除 key 对应的 value”
</span></span></span><span class=line><span class=cl><span class=cm>         * Reflect.deleteProperty 返回一个 boolean
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>Reflect</span><span class=p>.</span><span class=nx>deleteProperty</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>result</span> <span class=o>&amp;&amp;</span> <span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * key 本就存在，且删除成功之后，才能触发 delete 副作用
</span></span></span><span class=line><span class=cl><span class=cm>           * 这个操作同样会影响“迭代器”
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;delete&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 通过 ownKeys + ITERATE_KEY 拦截 for...in
</span></span></span><span class=line><span class=cl><span class=cm>       * ownKeys 是用来遍历所有 key 的
</span></span></span><span class=line><span class=cl><span class=cm>       * 所以这里拿不到具体的 key
</span></span></span><span class=line><span class=cl><span class=cm>       * 用 ITERATE_KEY 指代
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>ownKeys</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 对迭代访问进行依赖收集
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果是对数组进行遍历，需要考虑数组元素个数的变化（length 的变化）
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>track</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;iterate&#39;</span><span class=p>,</span> <span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>?</span> <span class=s1>&#39;length&#39;</span> <span class=o>:</span> <span class=nx>ITERATE_KEY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>Reflect</span><span class=p>.</span><span class=nx>ownKeys</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// collectionHandlers for Map、Set、WeakMap、WeakSet
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>mutableInstrumentations</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>mutableInstrumentations 用来对 Map|Set 的部分方法进行拦截。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mutableInstrumentations</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>Function</span><span class=p>&gt;</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>MapTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kr>get</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>size() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>size</span><span class=p>(</span><span class=k>this</span> <span class=kr>as</span> <span class=kt>unknown</span> <span class=kr>as</span> <span class=nx>IterableCollections</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>add</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>delete</span><span class=o>:</span> <span class=nx>deleteEntry</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>has</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>set</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>forEach</span>: <span class=kt>createForEach</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>keys</span>: <span class=kt>createIterableMethod</span><span class=p>(</span><span class=s1>&#39;keys&#39;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>values</span>: <span class=kt>createIterableMethod</span><span class=p>(</span><span class=s1>&#39;values&#39;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>entries</span>: <span class=kt>createIterableMethod</span><span class=p>(</span><span class=s1>&#39;entries&#39;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>Symbol</span><span class=p>.</span><span class=nx>iterator</span><span class=p>]</span><span class=o>:</span> <span class=nx>createIterableMethod</span><span class=p>(</span><span class=nx>Symbol</span><span class=p>.</span><span class=nx>iterator</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=kr>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span>: <span class=kt>MapTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isReadonly</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isShallow</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span> <span class=o>=</span> <span class=p>(</span><span class=nx>target</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>RAW</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>rawTarget</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span> <span class=c1>// 获取原始对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>rawKey</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span> <span class=c1>// 获取原始 key
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>!==</span> <span class=nx>rawKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>GET</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>GET</span><span class=p>,</span> <span class=nx>rawKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>has</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getProto</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>wrap</span> <span class=o>=</span> <span class=nx>isShallow</span> <span class=o>?</span> <span class=nx>toShallow</span> : <span class=kt>isReadonly</span> <span class=o>?</span> <span class=nx>toReadonly</span> : <span class=kt>toReactive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>rawKey</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>rawKey</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>target</span> <span class=o>!==</span> <span class=nx>rawTarget</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>size</span><span class=p>(</span><span class=nx>target</span>: <span class=kt>IterableCollections</span><span class=p>,</span> <span class=nx>isReadonly</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span> <span class=o>=</span> <span class=p>(</span><span class=nx>target</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>RAW</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=nx>target</span><span class=p>),</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>ITERATE</span><span class=p>,</span> <span class=nx>ITERATE_KEY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要将第三个参数（this 对象）指向 target，而不是 receiver
</span></span></span><span class=line><span class=cl><span class=cm>   * 因为 size 是一个访问器属性，响应式对象上没有实现 [[SetData]]
</span></span></span><span class=line><span class=cl><span class=cm>   * 所以，需要借用原始数据的 [[SetData]] 返回 size 值
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=s1>&#39;size&#39;</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>has</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>CollectionTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>,</span> <span class=nx>isReadonly</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=p>(</span><span class=k>this</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>RAW</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>rawTarget</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>rawKey</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>!==</span> <span class=nx>rawKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>HAS</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>HAS</span><span class=p>,</span> <span class=nx>rawKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>key</span> <span class=o>===</span> <span class=nx>rawKey</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>target</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=nx>target</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>||</span> <span class=nx>target</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>rawKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>add</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>SetTypes</span><span class=p>,</span> <span class=nx>value</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>proto</span> <span class=o>=</span> <span class=nx>getProto</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>proto</span><span class=p>.</span><span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 只有在值不存在的情况下，添加 key 并触发响应
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>target</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span> <span class=c1>// 这里需要对原始对象进行操作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>ADD</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=kr>set</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>MapTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>,</span> <span class=nx>value</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 不要将代理对象设置到原始对象上，所以需要拿到 value 的原始值
</span></span></span><span class=line><span class=cl><span class=cm>   * 否则，会污染原始数据
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>has</span><span class=p>,</span> <span class=kr>get</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getProto</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=kr>get</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span> <span class=c1>// 获取旧值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>target</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span> <span class=c1>// 设置新值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 触发新增
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>ADD</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>hasChanged</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 新旧值不相等，触发 SET
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>SET</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>deleteEntry</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>CollectionTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>has</span><span class=p>,</span> <span class=kr>get</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>getProto</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span> <span class=c1>// key 也可能为一个代理对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hadKey</span> <span class=o>=</span> <span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=kr>get</span> <span class=o>?</span> <span class=kr>get</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=o>:</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span> <span class=c1>// 通过原始对象 delete
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>hadKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 只有要删除的元素存在，才触发副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>DELETE</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>clear</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>IterableCollections</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hadItems</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=nx>size</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>oldTarget</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=nx>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hadItems</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>trigger</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>CLEAR</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>oldTarget</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createForEach</span><span class=p>(</span><span class=nx>isReadonly</span>: <span class=kt>boolean</span><span class=p>,</span> <span class=nx>isShallow</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 遍历操作只和值的数量有关
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>forEach</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>:</span> <span class=nx>IterableCollections</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>callback</span>: <span class=kt>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>thisArg?</span>: <span class=kt>unknown</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>observed</span> <span class=o>=</span> <span class=k>this</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>observed</span><span class=p>[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>RAW</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>rawTarget</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span> <span class=c1>// 还是在 target 上调用 forEach
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>wrap</span> <span class=o>=</span> <span class=nx>isShallow</span> <span class=o>?</span> <span class=nx>toShallow</span> : <span class=kt>isReadonly</span> <span class=o>?</span> <span class=nx>toReadonly</span> : <span class=kt>toReactive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span> <span class=nx>track</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>ITERATE</span><span class=p>,</span> <span class=nx>ITERATE_KEY</span><span class=p>);</span> <span class=c1>// 和 ITERATE_KEY 建立联系
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>target</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>value</span>: <span class=kt>unknown</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 需要将 value 和 key 包装为响应式数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>callback</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>thisArg</span><span class=p>,</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>value</span><span class=p>),</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>key</span><span class=p>),</span> <span class=nx>observed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// keys, values, entries, [Symbol.iterator]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>createIterableMethod</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>method</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kt>symbol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isReadonly</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isShallow</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>:</span> <span class=nx>IterableCollections</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span><span class=nx>args</span>: <span class=kt>unknown</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Iterable</span> <span class=o>&amp;</span> <span class=nx>Iterator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=p>(</span><span class=k>this</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>RAW</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>rawTarget</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span> <span class=c1>// 获取原始数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>targetIsMap</span> <span class=o>=</span> <span class=nx>isMap</span><span class=p>(</span><span class=nx>rawTarget</span><span class=p>);</span> <span class=c1>// 原始数据是不是 Map
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isPair</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>method</span> <span class=o>===</span> <span class=s1>&#39;entries&#39;</span> <span class=o>||</span> <span class=p>(</span><span class=nx>method</span> <span class=o>===</span> <span class=nx>Symbol</span><span class=p>.</span><span class=nx>iterator</span> <span class=o>&amp;&amp;</span> <span class=nx>targetIsMap</span><span class=p>);</span> <span class=c1>// [key, value]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isKeyOnly</span> <span class=o>=</span> <span class=nx>method</span> <span class=o>===</span> <span class=s1>&#39;keys&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>targetIsMap</span><span class=p>;</span> <span class=c1>// 只对 Map 的 key 进行了遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>innerIterator</span> <span class=o>=</span> <span class=nx>target</span><span class=p>[</span><span class=nx>method</span><span class=p>](...</span><span class=nx>args</span><span class=p>);</span> <span class=c1>// 获取原始迭代器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>wrap</span> <span class=o>=</span> <span class=nx>isShallow</span> <span class=o>?</span> <span class=nx>toShallow</span> : <span class=kt>isReadonly</span> <span class=o>?</span> <span class=nx>toReadonly</span> : <span class=kt>toReactive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isReadonly</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 这里多出一个 MAP_KEY_ITERATE_KEY 的原因是：
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果副作用函数中，只对 Map 遍历了 key 值，而没有 value 值
</span></span></span><span class=line><span class=cl><span class=cm>       * 而外部仅修改了已存在 key 的 value 值时，副作用不应该被重新运行
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>track</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>rawTarget</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>ITERATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isKeyOnly</span> <span class=o>?</span> <span class=nx>MAP_KEY_ITERATE_KEY</span> : <span class=kt>ITERATE_KEY</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 迭代器协议（一个对象实现了 next 方法）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>next() {</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>done</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>innerIterator</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span> <span class=c1>// 调用原始迭代器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>done</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=p>{</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>done</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=c1>// 将 value 转换为代理对象
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=nx>value</span>: <span class=kt>isPair</span> <span class=o>?</span> <span class=p>[</span><span class=nx>wrap</span><span class=p>(</span><span class=nx>value</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>value</span><span class=p>[</span><span class=mi>1</span><span class=p>])]</span> <span class=o>:</span> <span class=nx>wrap</span><span class=p>(</span><span class=nx>value</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=nx>done</span>
</span></span><span class=line><span class=cl>            <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 可迭代协议（一个对象实现了 Symbol.iterator 方法，entries 用到）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>[</span><span class=nx>Symbol</span><span class=p>.</span><span class=nx>iterator</span><span class=p>]()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>arrayInstrumentations 用来对数组的部分方法进行拦截。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 使用 Reflect.get(arrayInstrumentations, key, receiver);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>arrayInstrumentations</span> <span class=o>=</span> <span class=cm>/*#__PURE__*/</span> <span class=nx>createArrayInstrumentations</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createArrayInstrumentations() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>instrumentations</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>Function</span><span class=p>&gt;</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 数组查询操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>([</span><span class=s1>&#39;includes&#39;</span><span class=p>,</span> <span class=s1>&#39;indexOf&#39;</span><span class=p>,</span> <span class=s1>&#39;lastIndexOf&#39;</span><span class=p>]</span> <span class=kr>as</span> <span class=kr>const</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 形参里的 this 只是 TS 声明函数 this 类型的一种写法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>instrumentations</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=kt>unknown</span><span class=p>[],</span> <span class=p>...</span><span class=nx>args</span>: <span class=kt>unknown</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>arr</span> <span class=o>=</span> <span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span> <span class=c1>// this 指代“代理对象”，arr 为“原始对象”
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>track</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>TrackOpTypes</span><span class=p>.</span><span class=nx>GET</span><span class=p>,</span> <span class=nx>i</span> <span class=o>+</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>arr</span><span class=p>[</span><span class=nx>key</span><span class=p>](...</span><span class=nx>args</span><span class=p>);</span> <span class=c1>// 在原始对象上调用方法 key 并获取结果 res
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// res 为 falsey，表示在 arr 里没有找到对应元素
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>res</span> <span class=o>===</span> <span class=o>-</span><span class=mi>1</span> <span class=o>||</span> <span class=nx>res</span> <span class=o>===</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 没找到，说明 args 里存在“代理对象”，就用 toRaw 将 args 里的数据转化为原始数据
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果不做处理，就会有以下问题：
</span></span></span><span class=line><span class=cl><span class=cm>         * const tempObj = {};
</span></span></span><span class=line><span class=cl><span class=cm>         * const tempReactiveArr = reactive([tempObj]);
</span></span></span><span class=line><span class=cl><span class=cm>         * tempReactiveArr.includes(tempObj) // 不做特殊处理，就会得到 false；应该为 true 才符合预期
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>arr</span><span class=p>[</span><span class=nx>key</span><span class=p>](...</span><span class=nx>args</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 数组修改操作，会间接读取/修改 length，造成不必要的依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>([</span><span class=s1>&#39;push&#39;</span><span class=p>,</span> <span class=s1>&#39;pop&#39;</span><span class=p>,</span> <span class=s1>&#39;shift&#39;</span><span class=p>,</span> <span class=s1>&#39;unshift&#39;</span><span class=p>,</span> <span class=s1>&#39;splice&#39;</span><span class=p>]</span> <span class=kr>as</span> <span class=kr>const</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>instrumentations</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=kt>unknown</span><span class=p>[],</span> <span class=p>...</span><span class=nx>args</span>: <span class=kt>unknown</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 直接停止依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>pauseTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>pauseScheduling</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 调用原始对象的方法，并将 this 指向代理对象，并返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)[</span><span class=nx>key</span><span class=p>].</span><span class=nx>apply</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>resetScheduling</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>resetTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>instrumentations</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>readonly 用来创建原始对象的只读副本，这种转换同样是深层的，readonly 会影响所有嵌套属性。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=kr>readonly</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>createReactiveObject</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Object、Array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_isReactive&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_isReadonly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__v_raw&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>receiver</span> <span class=o>===</span> <span class=nx>readonlyMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>targetIsArray</span> <span class=o>=</span> <span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSymbol</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=nx>builtInSymbols</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=nx>key</span> <span class=o>===</span> <span class=sb>`__proto__`</span> <span class=o>||</span> <span class=nx>key</span> <span class=o>===</span> <span class=sb>`__v_isRef`</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>res</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 target 是一个数组且 key 是一个整数，就不应该把 res 自动展开
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>shouldUnwrap</span> <span class=o>=</span> <span class=o>!</span><span class=nx>targetIsArray</span> <span class=o>||</span> <span class=o>!</span><span class=nx>isIntegerKey</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>shouldUnwrap</span> <span class=o>?</span> <span class=nx>res.value</span> : <span class=kt>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 递归只读
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>res</span><span class=p>))</span> <span class=k>return</span> <span class=kr>readonly</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;target is readonly&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>deleteProperty</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;target is readonly&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>readonlyInstrumentations</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>readonlyInstrumentations</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>Function</span><span class=p>&gt;</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>MapTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kr>get</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>size() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>size</span><span class=p>(</span><span class=k>this</span> <span class=kr>as</span> <span class=kt>unknown</span> <span class=kr>as</span> <span class=nx>IterableCollections</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>has</span><span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>MapTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>has</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 除了 delete，其他全部返回 this
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>add</span>: <span class=kt>createReadonlyMethod</span><span class=p>(</span><span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>ADD</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=kr>set</span><span class=o>:</span> <span class=nx>createReadonlyMethod</span><span class=p>(</span><span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>SET</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=k>delete</span><span class=o>:</span> <span class=nx>createReadonlyMethod</span><span class=p>(</span><span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>DELETE</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>clear</span>: <span class=kt>createReadonlyMethod</span><span class=p>(</span><span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>CLEAR</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>forEach</span>: <span class=kt>createForEach</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createReadonlyMethod</span><span class=p>(</span><span class=kr>type</span><span class=o>:</span> <span class=nx>TriggerOpTypes</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>CollectionTypes</span><span class=p>,</span> <span class=p>...</span><span class=nx>args</span>: <span class=kt>unknown</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kr>type</span> <span class=o>===</span> <span class=nx>TriggerOpTypes</span><span class=p>.</span><span class=nx>DELETE</span> <span class=o>?</span> <span class=kc>false</span> <span class=o>:</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>createRef 用来将基本类型的值（原始值）转换为包装类型；ref、shallowRef 都会通过它来转换数据。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createRef</span><span class=p>(</span><span class=nx>rawValue</span><span class=p>,</span> <span class=nx>shallow</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>rawValue</span> <span class=o>&amp;&amp;</span> <span class=nx>rawValue</span><span class=p>.</span><span class=nx>__v_isRef</span> <span class=o>===</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>rawValue</span><span class=p>;</span> <span class=c1>// 已经是包装类型，就别来凑热闹了
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ref 就是简单的对 value 的 getter/setter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>new</span> <span class=nx>RefImpl</span><span class=p>(</span><span class=nx>rawValue</span><span class=p>,</span> <span class=nx>shallow</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>RefImpl</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>_value</span>: <span class=kt>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 可以用来区分 ref(1) 与 reactive({value: 1})，也是自动解构 .value 的依据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>public</span> <span class=kr>readonly</span> <span class=nx>__v_isRef</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>_rawValue</span>: <span class=kt>T</span><span class=p>,</span> <span class=kr>public</span> <span class=kr>readonly</span> <span class=nx>_shallow</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_value</span> <span class=o>=</span> <span class=nx>_shallow</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>_rawValue</span>
</span></span><span class=line><span class=cl>      : <span class=kt>isObject</span><span class=p>(</span><span class=nx>_rawValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=c1>// 如果 _rawValue 是对象，调用 reactive 深度转换
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>reactive</span><span class=p>(</span><span class=nx>_rawValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=nx>_rawValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>value() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>track</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>set</span> <span class=nx>value</span><span class=p>(</span><span class=nx>newVal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>hasChanged</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=nx>newVal</span><span class=p>),</span> <span class=k>this</span><span class=p>.</span><span class=nx>_rawValue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_rawValue</span> <span class=o>=</span> <span class=nx>newVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_shallow</span> <span class=o>?</span> <span class=nx>newVal</span> : <span class=kt>convert</span><span class=p>(</span><span class=nx>newVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>trigger</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=s1>&#39;set&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>,</span> <span class=nx>newVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ref 接受一个内部值并返回一个响应式且可变的 ref 对象；ref 对象具有指向内部值的单个属性 .value。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>ref</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>createRef</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 循环调用 toRef，可以在解构的同时，保持响应性，解决响应性丢失的问题
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>toRefs</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>object</span><span class=p>&gt;(</span><span class=kt>object</span><span class=o>:</span> <span class=nx>T</span><span class=p>)</span><span class=o>:</span> <span class=nx>ToRefs</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ret</span>: <span class=kt>any</span> <span class=o>=</span> <span class=nx>isArray</span><span class=p>(</span><span class=kt>object</span><span class=p>)</span> <span class=o>?</span> <span class=k>new</span> <span class=nb>Array</span><span class=p>(</span><span class=kt>object</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=o>:</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=kt>object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ret</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>toRef</span><span class=p>(</span><span class=kt>object</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>toRef</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>object</span><span class=err>,</span> <span class=na>K</span> <span class=na>extends</span> <span class=na>keyof</span> <span class=na>T</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=kt>object</span><span class=o>:</span> <span class=nx>T</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span>: <span class=kt>K</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>ToRef</span><span class=p>&lt;</span><span class=nt>T</span><span class=err>[</span><span class=na>K</span><span class=err>]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>isRef</span><span class=p>(</span><span class=kt>object</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=kt>object</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=p>(</span><span class=k>new</span> <span class=nx>ObjectRefImpl</span><span class=p>(</span><span class=kt>object</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ObjectRefImpl</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>object</span><span class=err>,</span> <span class=na>K</span> <span class=na>extends</span> <span class=na>keyof</span> <span class=na>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>readonly</span> <span class=nx>__v_isRef</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>_object</span>: <span class=kt>T</span><span class=p>,</span> <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>_key</span>: <span class=kt>K</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>value() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_object</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>_key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>set</span> <span class=nx>value</span><span class=p>(</span><span class=nx>newVal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_object</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>_key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>newVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>proxyRefs</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>object</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=nx>objectWithRefs</span>: <span class=kt>T</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>ShallowUnwrapRef</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>isReactive</span><span class=p>(</span><span class=nx>objectWithRefs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>objectWithRefs</span>
</span></span><span class=line><span class=cl>    : <span class=kt>new</span> <span class=nx>Proxy</span><span class=p>(</span><span class=nx>objectWithRefs</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>get</span><span class=o>:</span> <span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nx>unref</span><span class=p>(</span><span class=nx>Reflect</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=kr>set</span><span class=o>:</span> <span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>oldValue</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldValue</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>Reflect</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>unref</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span><span class=nx>ref</span>: <span class=kt>T</span> <span class=o>|</span> <span class=nx>Ref</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>isRef</span><span class=p>(</span><span class=nx>ref</span><span class=p>)</span> <span class=o>?</span> <span class=p>(</span><span class=nx>ref</span><span class=p>.</span><span class=nx>value</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>)</span> <span class=o>:</span> <span class=nx>ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>track 和 trigger 用于依赖收集和在依赖变动时触发的副作用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 追踪类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=kr>enum</span> <span class=nx>TrackOpTypes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>GET</span> <span class=o>=</span> <span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=c1>// 属性读取
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>HAS</span> <span class=o>=</span> <span class=s1>&#39;has&#39;</span><span class=p>,</span> <span class=c1>// in 操作符（不包括 for...in）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>ITERATE</span> <span class=o>=</span> <span class=s1>&#39;iterate&#39;</span> <span class=c1>// 迭代器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 触发类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=kr>enum</span> <span class=nx>TriggerOpTypes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ADD</span> <span class=o>=</span> <span class=s1>&#39;add&#39;</span><span class=p>,</span> <span class=c1>// 属性添加
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>CLEAR</span> <span class=o>=</span> <span class=s1>&#39;clear&#39;</span> <span class=c1>// 清空属性
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>DELETE</span> <span class=o>=</span> <span class=s1>&#39;delete&#39;</span><span class=p>,</span> <span class=c1>// 属性删除
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>SET</span> <span class=o>=</span> <span class=s1>&#39;set&#39;</span><span class=p>,</span> <span class=c1>// 属性设置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 依赖列表（2.x Array =&gt; 3.x Set）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>type</span> <span class=nx>Dep</span> <span class=o>=</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>ReactiveEffect</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=c1>// key 对应的依赖列表 [[[key, dep]],...]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>type</span> <span class=nx>KeyToDepMap</span> <span class=o>=</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>any</span><span class=err>,</span> <span class=na>Dep</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>shouldTrack</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 指向被收集的副作用函数，同 2.x 中的 Dep.target
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>activeEffect</span>: <span class=kt>ReactiveEffect</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>trackStack</span>: <span class=kt>boolean</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * target 的 key 对应的依赖列表，储存着 target -&gt; key -&gt; dep 的联系
</span></span></span><span class=line><span class=cl><span class=cm> * 为什么不用 Map 而用 WeakMap？
</span></span></span><span class=line><span class=cl><span class=cm> * 1. Map（WeakMap）内部有两个数组，分别存 key 和 value；所以在 Map（WeakMap）内部，key 和 value 并没有真正建立联系；
</span></span></span><span class=line><span class=cl><span class=cm> * 2. Map 的 key 和内存地址绑定，外部引用的消失不会影响绑定关系；WeakMap 内部对 key 的引用都是弱引用，不会阻止垃圾回收；
</span></span></span><span class=line><span class=cl><span class=cm> * 3. Map 的 key 可以为任意类型，WeakMap 的 key 只能为对象；
</span></span></span><span class=line><span class=cl><span class=cm> * 4. Map 可以被遍历，WeakMap 不能被遍历。
</span></span></span><span class=line><span class=cl><span class=cm> * 这里使用 WeakMap 可以使内存及时被释放
</span></span></span><span class=line><span class=cl><span class=cm> * 同理 Set 和 WeakSet 的区别如下：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. WeakSet 的成员都是弱引用；
</span></span></span><span class=line><span class=cl><span class=cm> * 2. WeakSet 的成员都是对象；
</span></span></span><span class=line><span class=cl><span class=cm> * 3. WeakSet 不能遍历。
</span></span></span><span class=line><span class=cl><span class=cm> * 只要外部引用消失，立即清除就会帮我们自动回收
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>targetMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WeakMap</span><span class=p>&lt;</span><span class=nt>any</span><span class=err>,</span> <span class=na>KeyToDepMap</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>ITERATE_KEY</span> <span class=o>=</span> <span class=nx>Symbol</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>MAP_KEY_ITERATE_KEY</span> <span class=o>=</span> <span class=nx>Symbol</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 暂停追踪，使用场景：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. 在对数组执行一些可能间接改变 length 属性的操作（push、pop、shift、unshift、splice）；
</span></span></span><span class=line><span class=cl><span class=cm> * 2. 在生命周期函数里暂停追踪，因为可能会触发潜在的 effect；
</span></span></span><span class=line><span class=cl><span class=cm> * 3. 调用 applyOptions 之前（兼容 2.x 语法）；
</span></span></span><span class=line><span class=cl><span class=cm> * 4. 调用内置的 warn 时；
</span></span></span><span class=line><span class=cl><span class=cm> * 5. 调用 setup 之前。
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>pauseTracking() {</span>
</span></span><span class=line><span class=cl>  <span class=nx>trackStack</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>shouldTrack</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>shouldTrack</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 开始追踪
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>enableTracking() {</span>
</span></span><span class=line><span class=cl>  <span class=nx>trackStack</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>shouldTrack</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>shouldTrack</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 重置到上一步
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>resetTracking() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>last</span> <span class=o>=</span> <span class=nx>trackStack</span><span class=p>.</span><span class=nx>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>shouldTrack</span> <span class=o>=</span> <span class=nx>last</span> <span class=o>===</span> <span class=kc>undefined</span> <span class=o>?</span> <span class=kc>true</span> <span class=o>:</span> <span class=nx>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 收集 activeEffect（在对数据进行 get、has、iterate 操作时）：
</span></span></span><span class=line><span class=cl><span class=cm> * 每次 track，就是把当前 activeEffect 作为对 target[key] 的依赖；
</span></span></span><span class=line><span class=cl><span class=cm> * 然后收集到 target 相关的 depsMap 对应 key 下的依赖集合 dep 中。
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>track</span><span class=p>(</span><span class=nx>target</span>: <span class=kt>object</span><span class=p>,</span> <span class=kr>type</span><span class=o>:</span> <span class=nx>TrackOpTypes</span><span class=p>,</span> <span class=nx>key</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>shouldTrack</span> <span class=o>||</span> <span class=nx>activeEffect</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * targetMap 是一个 WeakMap；
</span></span></span><span class=line><span class=cl><span class=cm>   * targetMap.get(target) 是一个 Map（被称为 depsMap）
</span></span></span><span class=line><span class=cl><span class=cm>   * 保存着 target 的每个 key 对应的 effects（2.x 里的 watcher），保存在 Set 里
</span></span></span><span class=line><span class=cl><span class=cm>   * targetMap = { // WeakMap(targetMap)
</span></span></span><span class=line><span class=cl><span class=cm>   *    [target]: { // Map(depsMap)
</span></span></span><span class=line><span class=cl><span class=cm>   *        [key]: new Set([effect1, effect2, effect3,...]), // Set(dep)
</span></span></span><span class=line><span class=cl><span class=cm>   *        ...
</span></span></span><span class=line><span class=cl><span class=cm>   *    },
</span></span></span><span class=line><span class=cl><span class=cm>   *    ...
</span></span></span><span class=line><span class=cl><span class=cm>   * }
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>depsMap</span> <span class=o>=</span> <span class=nx>targetMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// target 对应的 depsMap 不存在，就新建一个
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>depsMap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>targetMap</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=p>(</span><span class=nx>depsMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 副作用应该只与对应的 key 建立联系，而不是和所有 key
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>dep</span> <span class=o>=</span> <span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>dep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>depsMap</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=p>(</span><span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>dep</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>activeEffect</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 和 2.x 一样，dep 和 activeEffect 都保存着彼此
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>dep</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>activeEffect</span><span class=p>);</span> <span class=c1>// 没有就添加 activeEffect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>activeEffect</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>dep</span><span class=p>);</span> <span class=c1>// activeEffect 在自己 deps 里也保存一份（方便依赖清除）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 触发收集到的 effects（在对数据进行 set、add、delete、clear 操作时）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>trigger</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span>: <span class=kt>object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>TriggerOpTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key?</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>newValue?</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldValue?</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldTarget?</span>: <span class=kt>Map</span><span class=p>&lt;</span><span class=nt>unknown</span><span class=err>,</span> <span class=na>unknown</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>unknown</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 depsMap 并将 activeEffect 收集到 effects 里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>depsMap</span> <span class=o>=</span> <span class=nx>targetMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// target 没有被 track 过
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>depsMap</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 执行 effect 之前，需要重新构建一个 Set 来替代 depsMap.get(key)
</span></span></span><span class=line><span class=cl><span class=cm>   * 因为 effect 调用的过程中，存在 cleanup 并 reTrack 的逻辑
</span></span></span><span class=line><span class=cl><span class=cm>   * 在这个过程中，会对 depsMap.get(key) 对应的 set 进行“操作”
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果直接循环“原来的 set”，会导致无限循环调用
</span></span></span><span class=line><span class=cl><span class=cm>   * 究其原因，在 Set.prototype.forEach 中
</span></span></span><span class=line><span class=cl><span class=cm>   * 对 Set 本身进行“操作”，会陷入死循环
</span></span></span><span class=line><span class=cl><span class=cm>   * const set = new Set([1]);
</span></span></span><span class=line><span class=cl><span class=cm>   * set.forEach(item =&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>   *    // 这会死循环
</span></span></span><span class=line><span class=cl><span class=cm>   *    set.delete(1);
</span></span></span><span class=line><span class=cl><span class=cm>   *    set.add(1);
</span></span></span><span class=line><span class=cl><span class=cm>   * });
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>effects</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>ReactiveEffect</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将 effectsToAdd 按条件添加到 effects 里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>add</span> <span class=o>=</span> <span class=p>(</span><span class=nx>effectsToAdd</span>: <span class=kt>Set</span><span class=p>&lt;</span><span class=nt>ReactiveEffect</span><span class=p>&gt;</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>effectsToAdd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// effectsToAdd 中保存着 activeEffect
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>effectsToAdd</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>effect</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果 effect 和当前正在执行的 activeEffect 相同，就不放到 effects 里
</span></span></span><span class=line><span class=cl><span class=cm>         * 因为这种情况，一般是因为 activeEffect 内部逻辑对 target[key] 进行了操作
</span></span></span><span class=line><span class=cl><span class=cm>         * 导致又触发了 track/trigger，为了避免无限递归导致的栈溢出，需要做一下判断
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>effect</span> <span class=o>!==</span> <span class=nx>activeEffect</span> <span class=o>||</span> <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>effects</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=s1>&#39;clear&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Map/Set 要被清空，触发 target 下的所有 effects
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>depsMap</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>add</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;length&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 触发数组“长度变化”对应的 effect，一般是由于 key &gt;= Array.length
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>depsMap</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>dep</span><span class=p>,</span> <span class=nx>k</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// k 为 0、1、2、3、...、length
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>k</span> <span class=o>===</span> <span class=s1>&#39;length&#39;</span> <span class=o>||</span> <span class=nx>k</span> <span class=o>&gt;=</span> <span class=nx>newValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// target[&#39;length&#39;] 和 target[newValue～k] 对应的 effects 都要加去
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>add</span><span class=p>(</span><span class=nx>dep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理 SET | ADD | DELETE
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>!==</span> <span class=k>void</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Set(dep) 都添加进去
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理 ADD | DELETE | SET 的 ITERATE_KEY
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 需要将 ITERATE_KEY 对应的副作用也取出来
</span></span></span><span class=line><span class=cl><span class=cm>       * 因为，target 属性的增删，可能会影响到对 target 属性的遍历
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;add&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>ITERATE_KEY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>isMap</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Map 的 key 值变多了，要触发副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>MAP_KEY_ITERATE_KEY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isIntegerKey</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 数组 length 改变
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;length&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;delete&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>ITERATE_KEY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>isMap</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Map 的 key 值变少了，要触发副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>MAP_KEY_ITERATE_KEY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;set&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果操作类型是 SET 并且 target 是 Map 类型，需要触发 ITERATE_KEY 关联的副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>isMap</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>add</span><span class=p>(</span><span class=nx>depsMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>ITERATE_KEY</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 循环 effects，调用被收集的 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>effects</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>effect</span>: <span class=kt>ReactiveEffect</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>effect</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>scheduler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 使用调度器调用 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>effect</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>scheduler</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>effect</span><span class=p>();</span> <span class=c1>// 直接执行 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>effect 很像之前的 watcher；每次调用 effect（如果不 lazy 的话），会调用 createReactiveEffect 创建 reactiveEffect 并设置为 activeEffect（就像 2.x 的 watcher 在被收集之前，会将自己赋值给 Dep.target 一样）；之后会调用传入的 fn（componentEffect 内部的 renderComponentRoot 方法会执行组件的 render 方法、computedGetter、&mldr;），如果在 fn 调用的过程中，访问到了『响应式』数据；Proxy 会通过 track 将 activeEffect 收集起来（响应式数据与 effect 建立联系），放到 Set(dep) 里（dep.add(activeEffect)）；同时，activeEffect 也会保存一份 dep（activeEffect.deps.push(dep)）。</p><p>cleanup 流程就是通知 effect.deps 里保存的 dep，调用 dep.delete 方法。</p><p>stop 流程就是在 cleanup 的基础上，调用传入的 onStop 钩子。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>let</span> <span class=nx>uid</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>effectStack</span>: <span class=kt>ReactiveEffect</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>ReactiveEffect</span><span class=p>&lt;</span><span class=nt>T</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>()</span><span class=o>:</span> <span class=nx>T</span><span class=p>;</span> <span class=c1>// ReactiveEffect 可调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>_isEffect</span>: <span class=kt>true</span><span class=p>;</span> <span class=c1>// ReactiveEffect._isEffect = true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>active</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// ReactiveEffect.active = false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>allowRecurse</span>: <span class=kt>boolean</span><span class=p>;</span> <span class=c1>// ReactiveEffect.allowRecurse = true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>deps</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Dep</span><span class=p>&gt;;</span> <span class=c1>// ReactiveEffect.deps = []
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>id</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// ReactiveEffect.id = 123
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>options</span>: <span class=kt>ReactiveEffectOptions</span><span class=p>;</span> <span class=c1>// ReactiveEffect.options = {}
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>raw</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>T</span><span class=p>;</span> <span class=c1>// ReactiveEffect.raw = ReactiveEffect
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>ReactiveEffectOptions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>allowRecurse?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>lazy?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>onStop</span><span class=o>?:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>scheduler</span><span class=o>?:</span> <span class=p>(</span><span class=nx>job</span>: <span class=kt>ReactiveEffect</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 调度器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 将 fn（普通副作用）转换为 ReactiveEffect（自动副作用），场景如下：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. setupRenderEffect 中，instance.update = effect(function componentEffect() {...})
</span></span></span><span class=line><span class=cl><span class=cm> * 2. computed 中，this._value = (effect(getter, {}))()
</span></span></span><span class=line><span class=cl><span class=cm> * 3. watch 中，newValue = (effect(getter, {}))()
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>effect</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>fn</span> <span class=o>&amp;&amp;</span> <span class=nx>fn</span><span class=p>.</span><span class=nx>_isEffect</span> <span class=o>===</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fn</span> <span class=o>=</span> <span class=nx>fn</span><span class=p>.</span><span class=nx>raw</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>effect</span> <span class=o>=</span> <span class=nx>createReactiveEffect</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 运行 effect，触发 fn 里对使用到的数据的操作
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果是 lazy，惰性运行 effect（不立即执行）
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>options</span><span class=p>.</span><span class=nx>lazy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>effect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>effect</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createReactiveEffect</span><span class=p>&lt;</span><span class=nt>T</span> <span class=err>=</span> <span class=na>any</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=nx>fn</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>T</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>ReactiveEffectOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>ReactiveEffect</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 被收集的 effect 的每次调用：cleanup -&gt; enableTracking -&gt; fn -&gt; resetTracking
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>effect</span> <span class=o>=</span> <span class=kd>function</span> <span class=nx>reactiveEffect</span><span class=p>()</span><span class=o>:</span> <span class=kt>unknown</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>effect</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>options</span><span class=p>.</span><span class=nx>scheduler</span> <span class=o>?</span> <span class=kc>undefined</span> <span class=o>:</span> <span class=nx>fn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>effectStack</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>effect</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 每次运行 fn 之前，先清除上一次被收集的结果
</span></span></span><span class=line><span class=cl><span class=cm>       * 确保收集的依赖总是最新的
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>cleanup</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>enableTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * effect 会发生嵌套，就像组件一层一层嵌套那样
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果内层 effect 调用完，不及时释放 activeEffect 的话
</span></span></span><span class=line><span class=cl><span class=cm>         * 外层 effect 在进行剩下的逻辑处理的过程中，如果触发依赖收集，被收集的还会是内层的 effect
</span></span></span><span class=line><span class=cl><span class=cm>         * effectStack 的存在，保证了 activeEffect 永远指向 effectStack 的栈顶
</span></span></span><span class=line><span class=cl><span class=cm>         * 酱紫保证了，依赖收集机制只会收集对当前数据进行直接访问的 effect
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>effectStack</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将自身设置为 activeEffect，方便 track 对自己进行追踪，从而进行依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>activeEffect</span> <span class=o>=</span> <span class=nx>effect</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 每次调用 effect，都会执行 fn，将 fn 的返回值返回
</span></span></span><span class=line><span class=cl><span class=cm>         * computed/watch/render 需要用到返回值
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>fn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * （fn/组件的渲染工作）是递归的
</span></span></span><span class=line><span class=cl><span class=cm>         * 渲染完成之后，需要及时将渲染流程交还给父级组件
</span></span></span><span class=line><span class=cl><span class=cm>         * 此时，虽然子级已完成渲染（子级依赖收集完成）
</span></span></span><span class=line><span class=cl><span class=cm>         * 但父级的渲染还没完成，需要交还给父级继续完成父级的依赖收集
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>effectStack</span><span class=p>.</span><span class=nx>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>resetTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// activeEffect 永远指向 effectStack 的栈顶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>activeEffect</span> <span class=o>=</span> <span class=nx>effectStack</span><span class=p>[</span><span class=nx>effectStack</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=kr>as</span> <span class=nx>ReactiveEffect</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>_isEffect</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>allowRecurse</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>effect</span><span class=p>.</span><span class=nx>raw</span> <span class=o>=</span> <span class=nx>fn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>effect</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 清除 effect
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>cleanup</span><span class=p>(</span><span class=nx>effect</span>: <span class=kt>ReactiveEffect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 每个 effect 都保存了“自己被哪个 dep 收集了”
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>deps</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>effect</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>deps</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通知他们，把自己删掉；如果再更新的话，不要通知我
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=k>delete</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 清空 effect.deps
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>deps</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 终止 effect，使用场景如下：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. watcher 返回的函数中，用于取消 watcher 的 effect
</span></span></span><span class=line><span class=cl><span class=cm> * 2. unmountComponent 时，用于清除组件的 effect
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>stop</span><span class=p>(</span><span class=nx>effect</span>: <span class=kt>ReactiveEffect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>effect</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cleanup</span><span class=p>(</span><span class=nx>effect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>effect</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>onStop</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>effect</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>onStop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>effect</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=异步队列-2x>异步队列 2.x</h2><p>queueWatcher 在 watcher.update 方法内调用，用来将 watcher 推入队列（缓冲在一个事件循环内的所有数据变化）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>queueWatcher</span><span class=p>(</span><span class=nx>watcher</span>: <span class=kt>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 watcher 的唯一的 id
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>has</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 同一个 watcher 被多次 update，也只进入队列一次
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>has</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>flushing</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 队列暂时没有被清空，直接入队
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>watcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果正在清空队列，将新来的 watcher 添加到合适的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=nx>index</span> <span class=o>&amp;&amp;</span> <span class=nx>queue</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>id</span> <span class=o>&gt;</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>queue</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>watcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>waiting</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>waiting</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 在下个事件循环就清空队列并执行所有 watcher 回调
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>nextTick</span><span class=p>(</span><span class=nx>flushSchedulerQueue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>flushSchedulerQueue 刷新/清空队列，调用 watcher.run 执行副作用；完成 watcher 调用之后，调用组件 activated/updated 钩子函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>function</span> <span class=nx>flushSchedulerQueue() {</span>
</span></span><span class=line><span class=cl>  <span class=nx>currentFlushTimestamp</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>flushing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>watcher</span><span class=p>,</span> <span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 在清空之前，先按照 id 进行排序：
</span></span></span><span class=line><span class=cl><span class=cm>   * 1. 组件更新/渲染总是先父后子（父组件先创建）
</span></span></span><span class=line><span class=cl><span class=cm>   * 2. vm.$watch 比 renderWatch 先运行（因为 vm.$watch 先创建）
</span></span></span><span class=line><span class=cl><span class=cm>   * 3. 在父组件 watcher 运行期间，如果子组件被销毁，他的 watcher 会被跳过（watcher.active = false）
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>queue</span><span class=p>.</span><span class=nx>sort</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>a</span><span class=p>.</span><span class=nx>id</span> <span class=o>-</span> <span class=nx>b</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 不要缓存队列长度，因为随时可能会变
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=nx>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>index</span> <span class=o>&lt;</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>index</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>watcher</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>[</span><span class=nx>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>before</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 2.x 里唯一用到的地方是 callHook(vm, &#39;beforeUpdate&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>watcher</span><span class=p>.</span><span class=nx>before</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span> <span class=o>=</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>has</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>watcher</span><span class=p>.</span><span class=nx>run</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>has</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>circular</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>circular</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>||</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 同一个 watch 不能运行多次
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>circular</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 判断是否是死循环
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在重置状态之前保留队列的副本
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>activatedQueue</span> <span class=o>=</span> <span class=nx>activatedChildren</span><span class=p>.</span><span class=nx>slice</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>updatedQueue</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>slice</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>resetSchedulerState</span><span class=p>();</span> <span class=c1>// 重置队列状态
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callActivatedHooks</span><span class=p>(</span><span class=nx>activatedQueue</span><span class=p>);</span> <span class=c1>// callHook(vm, &#39;activated&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callUpdatedHooks</span><span class=p>(</span><span class=nx>updatedQueue</span><span class=p>);</span> <span class=c1>// callHook(vm, &#39;updated&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=异步队列-3x>异步队列 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 一共有三种队列：preFlushCbs、queue、postFlushCbs
</span></span></span><span class=line><span class=cl><span class=cm> * watchEffect(() =&gt; {}, {
</span></span></span><span class=line><span class=cl><span class=cm> *    flush: &#39;pre&#39;, // 默认，在组件渲染之前执行
</span></span></span><span class=line><span class=cl><span class=cm> *    flush: &#39;sync&#39; // 在响应式依赖发生改变时立即触发侦听器
</span></span></span><span class=line><span class=cl><span class=cm> *    flush: &#39;post&#39;, // 延迟到组件渲染之后再执行
</span></span></span><span class=line><span class=cl><span class=cm> * });
</span></span></span><span class=line><span class=cl><span class=cm> * 1. preFlushCbs，清空 queue 之前执行的回调队列（渲染之前需要的任务）
</span></span></span><span class=line><span class=cl><span class=cm> * 2. queue，“组件渲染/同步”任务队列
</span></span></span><span class=line><span class=cl><span class=cm> * 3. postFlushCbs，清空 queue 之后执行的回调队列（渲染之后需要的任务）
</span></span></span><span class=line><span class=cl><span class=cm> * 每次刷新（flush）的过程：清空 preFlushCbs -&gt; 清空 queue -&gt; 清空 postFlushCbs
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>SchedulerJob</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>()</span><span class=o>:</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id?</span>: <span class=kt>number</span><span class=p>;</span> <span class=c1>// 唯一的 jobID，仅在 RAWEffect（例如，组件渲染）上出现
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 是否允许 job 递归触发自身
</span></span></span><span class=line><span class=cl><span class=cm>   * 默认情况下，一个 job 不能触发自身
</span></span></span><span class=line><span class=cl><span class=cm>   * 因为一些内建方法的调用（例如，Array.prototype.push）会导致无限循环
</span></span></span><span class=line><span class=cl><span class=cm>   * 只有在“组件更新函数”和“watch 回调”的情况下，这个选项才可以为 true
</span></span></span><span class=line><span class=cl><span class=cm>   * 组件更新可能会导致子组件的 props 更新，进而触发子组件的“flush: pre”的 watch 回调
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>allowRecurse?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>type</span> <span class=nx>SchedulerCb</span> <span class=o>=</span> <span class=nb>Function</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>id?</span>: <span class=kt>number</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>type</span> <span class=nx>SchedulerCbs</span> <span class=o>=</span> <span class=nx>SchedulerCb</span> <span class=o>|</span> <span class=nx>SchedulerCb</span><span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>CountMap</span> <span class=o>=</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>SchedulerJob</span> <span class=err>|</span> <span class=na>SchedulerCb</span><span class=err>,</span> <span class=na>number</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>isFlushing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否正在刷新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>isFlushPending</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否正在等待刷新
</span></span></span><span class=line><span class=cl><span class=c1>// 还未被执行的 pre/post 任务，如果当前 tick 正在 flushPreCbs/flushPostCbs 的时候，有新的任务进来，会被添加到这个数组中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>pendingPreFlushCbs</span>: <span class=kt>SchedulerCb</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>pendingPostFlushCbs</span>: <span class=kt>SchedulerCb</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=c1>// 正在被执行的任务，此时如果 pendingPreFlushCbs/pendingPostFlushCbs 中有新的任务进来的时候，会被合并到这个队列中被继续执行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>activePreFlushCbs</span>: <span class=kt>SchedulerCb</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>activePostFlushCbs</span>: <span class=kt>SchedulerCb</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>preFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>postFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>currentFlushPromise</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>currentPreFlushParentJob</span>: <span class=kt>SchedulerJob</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>resolvedPromise</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 在下个事件循环刷新 job 队列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>queueFlush() {</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在没有刷新队列和没有等待刷新队列的情况下，进入「刷新 job 队列」任务
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isFlushing</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isFlushPending</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>isFlushPending</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 正在等待刷新
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>currentFlushPromise</span> <span class=o>=</span> <span class=nx>resolvedPromise</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>flushJobs</span><span class=p>);</span> <span class=c1>// 使用微任务
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>flushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 异步渲染任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>queue</span>: <span class=kt>SchedulerJob</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 渲染任务入列（renderEffect 的调度器）：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. 强制组件重新渲染：vm.$forceUpdate: i =&gt; () =&gt; queueJob(i.update)
</span></span></span><span class=line><span class=cl><span class=cm> * 2. 强制父组件重新渲染：queueJob(instance.parent.update)
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>queueJob</span><span class=p>(</span><span class=nx>job</span>: <span class=kt>SchedulerJob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 重复数据消除搜索使用 Array.prototype.include 的 startIndex 参数
</span></span></span><span class=line><span class=cl><span class=cm>   * 判断队列中是否已有该 job，没有才会添加到任务队列中，防止任务重新执行
</span></span></span><span class=line><span class=cl><span class=cm>   * 默认情况下，搜索索引包含正在运行的当前 job，因此它无法再次递归触发自身
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>!</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>queue</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>job</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isFlushing</span> <span class=o>&amp;&amp;</span> <span class=nx>job</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>?</span> <span class=nx>flushIndex</span> <span class=o>+</span> <span class=nx>1</span> : <span class=kt>flushIndex</span>
</span></span><span class=line><span class=cl>      <span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>job</span> <span class=o>!==</span> <span class=nx>currentPreFlushParentJob</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 就把 job 加入队列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>queue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>job</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 在下个事件循环调用 flushJobs“刷新 job 队列”
</span></span></span><span class=line><span class=cl><span class=cm>     * 内部会调用 Promise.then(flushJobs)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>queueFlush</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将失效的 job 从队列中剔除（主要用来避免子组件重新渲染）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>invalidateJob</span><span class=p>(</span><span class=nx>job</span>: <span class=kt>SchedulerJob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>job</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 刷新 job 队列（flushPreFlushCbs -&gt; queue -&gt; flushPostFlushCbs）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>flushJobs</span><span class=p>(</span><span class=nx>seen?</span>: <span class=kt>CountMap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>isFlushPending</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isFlushing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 队列正在刷新，isFlushing 确保了每个事件循环内，只会调用一次 flushJobs
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>flushPreFlushCbs</span><span class=p>(</span><span class=nx>seen</span><span class=p>);</span> <span class=c1>// 刷新前置回调队列
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 刷新队列前，先排序；确保：
</span></span></span><span class=line><span class=cl><span class=cm>   * 1. 组件的更新顺序是由父到子（父比子先创建，renderEffect 的优先级也应该如此）
</span></span></span><span class=line><span class=cl><span class=cm>   * 2. 如果组件在父级更新之后被卸载了，他就可以跳过更新
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>queue</span><span class=p>.</span><span class=nx>sort</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>getId</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>-</span> <span class=nx>getId</span><span class=p>(</span><span class=nx>b</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环 job 队列，执行 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=nx>flushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>flushIndex</span> <span class=o>&lt;</span> <span class=nx>queue</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>flushIndex</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>job</span> <span class=o>=</span> <span class=nx>queue</span><span class=p>[</span><span class=nx>flushIndex</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>job</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将 job 放到 try...catch 里执行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>callWithErrorHandling</span><span class=p>(</span><span class=nx>job</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>SCHEDULER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>flushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>flushPostFlushCbs</span><span class=p>(</span><span class=nx>seen</span><span class=p>);</span> <span class=c1>// 刷新后置回调队列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isFlushing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentFlushPromise</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span> <span class=c1>// 重置 Promise
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 回调可能将新的 job 添加到了 job 队列，那就再次刷新 job 队列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>queue</span><span class=p>.</span><span class=nx>length</span> <span class=o>||</span> <span class=nx>pendingPostFlushCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>flushJobs</span><span class=p>(</span><span class=nx>seen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将回调函数加入队列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>queueCb</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span>: <span class=kt>SchedulerCbs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>activeQueue</span>: <span class=kt>SchedulerCb</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span> <span class=c1>// 激活的队列？
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>pendingQueue</span>: <span class=kt>SchedulerCb</span><span class=p>[],</span> <span class=c1>// 等待的队列？
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>index</span>: <span class=kt>number</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 向 pendingQueue 添加回调
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>cb</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>activeQueue</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>activeQueue</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>cb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>cb</span> <span class=kr>as</span> <span class=nx>SchedulerJob</span><span class=p>).</span><span class=nx>allowRecurse</span> <span class=o>?</span> <span class=nx>index</span> <span class=o>+</span> <span class=nx>1</span> : <span class=kt>index</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pendingQueue</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pendingQueue</span><span class=p>.</span><span class=nx>push</span><span class=p>(...</span><span class=nx>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>queueFlush</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将「渲染之“前”要执行的回调」入列（flush: pre）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>queuePreFlushCb</span><span class=p>(</span><span class=nx>cb</span>: <span class=kt>SchedulerCb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queueCb</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>activePreFlushCbs</span><span class=p>,</span> <span class=nx>pendingPreFlushCbs</span><span class=p>,</span> <span class=nx>preFlushIndex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将「渲染之“后”要执行的回调」入列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>queuePostFlushCb</span><span class=p>(</span><span class=nx>cb</span>: <span class=kt>SchedulerCbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>queueCb</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>activePostFlushCbs</span><span class=p>,</span> <span class=nx>pendingPostFlushCbs</span><span class=p>,</span> <span class=nx>postFlushIndex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 刷新「渲染之“前”要执行的回调」
</span></span></span><span class=line><span class=cl><span class=cm> * 渲染更新之前，触发因为 props 更新而运行的 watcher（flush: pre）
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>flushPreFlushCbs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>seen?</span>: <span class=kt>CountMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>parentJob</span>: <span class=kt>SchedulerJob</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>pendingPreFlushCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentPreFlushParentJob</span> <span class=o>=</span> <span class=nx>parentJob</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>activePreFlushCbs</span> <span class=o>=</span> <span class=p>[...</span><span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>pendingPreFlushCbs</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>    <span class=nx>pendingPreFlushCbs</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>preFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>preFlushIndex</span> <span class=o>&lt;</span> <span class=nx>activePreFlushCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>preFlushIndex</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>activePreFlushCbs</span><span class=p>[</span><span class=nx>preFlushIndex</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>activePreFlushCbs</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>preFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentPreFlushParentJob</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 递归刷新，直到耗尽为止
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>flushPreFlushCbs</span><span class=p>(</span><span class=nx>seen</span><span class=p>,</span> <span class=nx>parentJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 刷新「渲染之“后”要执行的回调」
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>flushPostFlushCbs</span><span class=p>(</span><span class=nx>seen?</span>: <span class=kt>CountMap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>pendingPostFlushCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>deduped</span> <span class=o>=</span> <span class=p>[...</span><span class=k>new</span> <span class=nx>Set</span><span class=p>(</span><span class=nx>pendingPostFlushCbs</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>    <span class=nx>pendingPostFlushCbs</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>activePostFlushCbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>activePostFlushCbs</span><span class=p>.</span><span class=nx>push</span><span class=p>(...</span><span class=nx>deduped</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>activePostFlushCbs</span> <span class=o>=</span> <span class=nx>deduped</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>activePostFlushCbs</span><span class=p>.</span><span class=nx>sort</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>getId</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=o>-</span> <span class=nx>getId</span><span class=p>(</span><span class=nx>b</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>postFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>postFlushIndex</span> <span class=o>&lt;</span> <span class=nx>activePostFlushCbs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>postFlushIndex</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>activePostFlushCbs</span><span class=p>[</span><span class=nx>postFlushIndex</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>activePostFlushCbs</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>postFlushIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=依赖注入-2x>依赖注入 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 在 Vue 初始化的过程中（Vue.prototype._init）
</span></span></span><span class=line><span class=cl><span class=cm> * 先会调用 initInjections(vm) 再调用 initProvide(vm)
</span></span></span><span class=line><span class=cl><span class=cm> * 1. Reflect.ownKeys/Object.keys 获取 inject 配置的 keys
</span></span></span><span class=line><span class=cl><span class=cm> * 2. inject[keys[i]].from 获取对应的 provideKey
</span></span></span><span class=line><span class=cl><span class=cm> * 3. 通过 vm.$parent 向上查找组件
</span></span></span><span class=line><span class=cl><span class=cm> * 4. 直到 vm._provided &amp;&amp; hasOwn(vm._provided, provideKey)
</span></span></span><span class=line><span class=cl><span class=cm> * 5. 取出 vm._provided[provideKey] 的值或者 inject[key].default 的值
</span></span></span><span class=line><span class=cl><span class=cm> * 6. 得到所有 inject 对应的值之后，调用 defineReactive 将其变为响应式
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initProvide</span><span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 provide 配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>provide</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>provide</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>provide</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 兼容 provide 的两种写法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_provided</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>provide</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span> <span class=o>?</span> <span class=nx>provide</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=o>:</span> <span class=nx>provide</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initInjections</span><span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 解析 inject 获取结果
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>resolveInject</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>inject</span><span class=p>,</span> <span class=nx>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>toggleObserving</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>result</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>key</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>result</span><span class=p>[</span><span class=nx>key</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>toggleObserving</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>resolveInject</span><span class=p>(</span><span class=nx>inject</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>vm</span>: <span class=kt>Component</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nb>Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>inject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Reflect.ownKeys 自身可枚举属性 + 自身不可枚举属性 + Symbol 属性 + length
</span></span></span><span class=line><span class=cl><span class=cm>     * for...in... 自身可枚举属性 + 原型链
</span></span></span><span class=line><span class=cl><span class=cm>     * Object.keys 自身可枚举属性
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nx>hasSymbol</span> <span class=o>?</span> <span class=nx>Reflect</span><span class=p>.</span><span class=nx>ownKeys</span><span class=p>(</span><span class=nx>inject</span><span class=p>)</span> <span class=o>:</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>inject</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span> <span class=c1>// 获取注入的 key
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span> <span class=c1>// 跳过 __ob__
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>provideKey</span> <span class=o>=</span> <span class=nx>inject</span><span class=p>[</span><span class=nx>key</span><span class=p>].</span><span class=kr>from</span><span class=p>;</span> <span class=c1>// 对应 provider 的 key
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>source</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过 $parent 向上查找
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>source</span><span class=p>.</span><span class=nx>_provided</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>source</span><span class=p>.</span><span class=nx>_provided</span><span class=p>,</span> <span class=nx>provideKey</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>result</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>source</span><span class=p>.</span><span class=nx>_provided</span><span class=p>[</span><span class=nx>provideKey</span><span class=p>];</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>source</span> <span class=o>=</span> <span class=nx>source</span><span class=p>.</span><span class=nx>$parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 没有找到？
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果有默认值，使用默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=s1>&#39;default&#39;</span> <span class=k>in</span> <span class=nx>inject</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>provideDefault</span> <span class=o>=</span> <span class=nx>inject</span><span class=p>[</span><span class=nx>key</span><span class=p>].</span><span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>result</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=k>typeof</span> <span class=nx>provideDefault</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=nx>provideDefault</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=o>:</span> <span class=nx>provideDefault</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 否则报错
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>warn</span><span class=p>(</span><span class=sb>`Injection &#34;</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>&#34; not found`</span><span class=p>,</span> <span class=nx>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=依赖注入-3x>依赖注入 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>provide</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>currentInstance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=sb>`provide() 只能在用在 setup() 里`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>provides</span> <span class=o>=</span> <span class=nx>currentInstance</span><span class=p>.</span><span class=nx>provides</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 默认，实例会继承父级的 provides 对象
</span></span></span><span class=line><span class=cl><span class=cm>     * 组件会基于父级的 provides（作为原型）创建自己的 provides
</span></span></span><span class=line><span class=cl><span class=cm>     * 这样，在“Inject”的时候，我们可以简单地查找来自“直接父级”的注入，并让原型链来完成这项工作
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>parentProvides</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentInstance</span><span class=p>.</span><span class=nx>parent</span> <span class=o>&amp;&amp;</span> <span class=nx>currentInstance</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>provides</span><span class=p>;</span> <span class=c1>// 找到父级的 provides
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>parentProvides</span> <span class=o>===</span> <span class=nx>provides</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 基于父级的 provides 创建自己的 provides
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>provides</span> <span class=o>=</span> <span class=nx>currentInstance</span><span class=p>.</span><span class=nx>provides</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>parentProvides</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 保存 value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>provides</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>inject</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span>: <span class=kt>InjectionKey</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=o>|</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>defaultValue?</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>treatDefaultAsFactory</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 找到离自己最近的父组件的 provides 或着 vnode 的上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>currentInstance</span> <span class=o>||</span> <span class=nx>currentRenderingInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从父级组件查找 provide
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>provides</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>appContext</span> <span class=o>&amp;&amp;</span> <span class=nx>instance.vnode.appContext.provides</span>
</span></span><span class=line><span class=cl>        : <span class=kt>instance.parent.provides</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 在 provies 里找到 inject 对应的 key 的值，返回即可
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>provides</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>key</span> <span class=kr>as</span> <span class=kt>string</span> <span class=o>|</span> <span class=kt>symbol</span><span class=p>)</span> <span class=k>in</span> <span class=nx>provides</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>provides</span><span class=p>[</span><span class=nx>key</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 找不到的情况下，使用默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>treatDefaultAsFactory</span> <span class=o>&amp;&amp;</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>defaultValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>defaultValue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>defaultValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>warn</span><span class=p>(</span><span class=sb>`找不到`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=sb>`inject() 只能在用在 setup() 里`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=生命周期-2x>生命周期 2.x</h2><p>所有生命周期，都是通过 callHook 调用的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>,</span> <span class=nx>hook</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>pushTarget</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>handlers</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>[</span><span class=nx>hook</span><span class=p>];</span> <span class=c1>// 找到钩子函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>hook</span><span class=si>}</span><span class=sb> hook`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>handlers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果是 mixin/extend，handlers 有可能是数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>j</span> <span class=o>=</span> <span class=nx>handlers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>j</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeWithErrorHandling</span><span class=p>(</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>vm</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_hasHookEvent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果有 vm.$on(&#39;hook:xxx&#39;, () =&gt; {})
</span></span></span><span class=line><span class=cl><span class=cm>     * vm._hasHookEvent 会被置为 true
</span></span></span><span class=line><span class=cl><span class=cm>     * 需要用 $emit 调用
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$emit</span><span class=p>(</span><span class=s1>&#39;hook:&#39;</span> <span class=o>+</span> <span class=nx>hook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>popTarget</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vue 是一个构造函数，在被 new 之前，需要经过初始化和混入操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>function</span> <span class=nx>Vue</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=k>this</span> <span class=k>instanceof</span> <span class=nx>Vue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;Vue 只能被 new 操作符调用&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>_init</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Vue.prototype._init = ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$data = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$props = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$set = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$delete = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$watch = ...
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>stateMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$on = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$once = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$off = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$emit = ...
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>eventsMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype._update = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$forceUpdate = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$destroy = ...
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>lifecycleMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype.$nextTick = ...
</span></span></span><span class=line><span class=cl><span class=cm> * Vue.prototype._render = ...
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>renderMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span>: <span class=kt>Class</span><span class=p>&lt;</span><span class=nt>Component</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_init</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>options?</span>: <span class=kt>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span>: <span class=kt>Component</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>startTag</span><span class=p>,</span> <span class=nx>endTag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_isVue</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 不要 observe 我
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_uid</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span><span class=p>;</span> <span class=c1>// 每个实例唯一的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 合并 options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span> <span class=o>&amp;&amp;</span> <span class=nx>options</span><span class=p>.</span><span class=nx>_isComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initInternalComponent</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span> <span class=o>=</span> <span class=nx>mergeOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=kr>constructor</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>options</span> <span class=o>||</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_renderProxy</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_self</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span> <span class=c1>// 我自己就是我自己
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initLifecycle</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 初始化属性，定位非抽象父级
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initEvents</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 更新父级给自己绑定的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initRender</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 处理插槽的渲染上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeCreate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>initInjections</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 在解析 data/props 之前先解析 injections
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initState</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 按顺序初始化 props、methods、data、computed、watch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initProvide</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span> <span class=c1>// 在解析 data/props 之后先解析 provide
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;created&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$mount</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>);</span> <span class=c1>// 挂载，调用 mountComponent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>created 钩子调用之后，会判断 vm.$options.el 是否存在，接着会调用 mountComponent。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$mount</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>el?</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nx>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span> <span class=o>=</span> <span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>inBrowser</span> <span class=o>?</span> <span class=nx>query</span><span class=p>(</span><span class=nx>el</span><span class=p>)</span> <span class=o>:</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>mountComponent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>mountComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span>: <span class=kt>?Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>render</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=nx>createEmptyVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeMount&#39;</span><span class=p>);</span> <span class=c1>// 找到挂载点，render 准备好渲染的内容之后，调用“beforeMount”
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// renderWatcher 被 render 用到的变量的 getter 收集
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>noop</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>before() {</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 在 watcher.before 之前执行
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果组件已经挂载，则执行‘beforeUpdate’
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=kc>true</span> <span class=cm>/* isRenderWatcher */</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// renderWatcher 初始化完成之后，调用“mounted”
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;mounted&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>updated 钩子会在前边总结的“异步队列”里调用；下面来看 destroy。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$destroy</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vm</span>: <span class=kt>Component</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果组件正在销毁，别往下走了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 进入销毁流程
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeDestroy&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>parent</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>parent</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>parent</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=kr>abstract</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果父级没有销毁，将自己从父级的子组件中删除
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>remove</span><span class=p>(</span><span class=nx>parent</span><span class=p>.</span><span class=nx>$children</span><span class=p>,</span> <span class=nx>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 销毁 renderWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_watcher</span><span class=p>.</span><span class=nx>teardown</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 销毁 computedWatchers 和 其他的 watchers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>teardown</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 移除 observer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>.</span><span class=nx>vmCount</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 我死了
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将组件对应的 VNode 置为 null
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 我真的死了
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;destroyed&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 移除所有事件绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$off</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>.</span><span class=nx>parent</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=生命周期-3x>生命周期 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=kr>enum</span> <span class=nx>LifecycleHooks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>BEFORE_CREATE</span> <span class=o>=</span> <span class=s1>&#39;bc&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>CREATED</span> <span class=o>=</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BEFORE_MOUNT</span> <span class=o>=</span> <span class=s1>&#39;bm&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>MOUNTED</span> <span class=o>=</span> <span class=s1>&#39;m&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BEFORE_UPDATE</span> <span class=o>=</span> <span class=s1>&#39;bu&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UPDATED</span> <span class=o>=</span> <span class=s1>&#39;u&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BEFORE_UNMOUNT</span> <span class=o>=</span> <span class=s1>&#39;bum&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UNMOUNTED</span> <span class=o>=</span> <span class=s1>&#39;um&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>DEACTIVATED</span> <span class=o>=</span> <span class=s1>&#39;da&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ACTIVATED</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RENDER_TRIGGERED</span> <span class=o>=</span> <span class=s1>&#39;rtg&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RENDER_TRACKED</span> <span class=o>=</span> <span class=s1>&#39;rtc&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ERROR_CAPTURED</span> <span class=o>=</span> <span class=s1>&#39;ec&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createHook</span> <span class=o>=</span> <span class=nx>lifecycle</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>injectHook</span><span class=p>(</span><span class=nx>lifecycle</span><span class=p>,</span> <span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>injectHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>LifecycleHooks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hook</span>: <span class=kt>Function</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>__weh?</span>: <span class=kt>Function</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=nx>currentInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>prepend</span>: <span class=kt>boolean</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>hooks</span> <span class=o>=</span> <span class=nx>target</span><span class=p>[</span><span class=kr>type</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=nx>target</span><span class=p>[</span><span class=kr>type</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]);</span> <span class=c1>// 保存着实例对应的钩子函数的数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>wrappedHook</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>hook</span><span class=p>.</span><span class=nx>__weh</span> <span class=o>||</span> <span class=c1>// __weh 的意思是“带有错误处理的”
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>__weh</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>unknown</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>isUnmounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>pauseTracking</span><span class=p>();</span> <span class=c1>// 在 Hook 中禁用依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 在 Hook 调用期间，设置 currentInstance 为 target
</span></span></span><span class=line><span class=cl><span class=cm>         * 只有当用户做了一些 funky 操作，这条假设（钩子不会同步触发其他钩子）才不成立
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>setCurrentInstance</span><span class=p>(</span><span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>callWithAsyncErrorHandling</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>setCurrentInstance</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span> <span class=c1>// 释放 currentInstance
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>resetTracking</span><span class=p>();</span> <span class=c1>// 恢复依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>prepend</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hooks</span><span class=p>.</span><span class=nx>unshift</span><span class=p>(</span><span class=nx>wrappedHook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hooks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>wrappedHook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>wrappedHook</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 在 setup 内部，没有 beforeCreate 和 created 钩子；setup 充当了这两个钩子的角色
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onBeforeMount</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>BEFORE_MOUNT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onMounted</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>MOUNTED</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onBeforeUpdate</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>BEFORE_UPDATE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onUpdated</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>UPDATED</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onBeforeUnmount</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>BEFORE_UNMOUNT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onUnmounted</span> <span class=o>=</span> <span class=nx>createHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>UNMOUNTED</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 酱紫写，是为了区分 ErrorCapturedHook 与普通 Hook 的不同
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>type</span> <span class=nx>ErrorCapturedHook</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentPublicInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>info</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=&gt;</span> <span class=kr>boolean</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onErrorCaptured</span> <span class=o>=</span> <span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>injectHook</span><span class=p>(</span><span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>ERROR_CAPTURED</span><span class=p>,</span> <span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>在 setup 内部，没有 beforeCreate 和 created 钩子；setup 充当了这两个钩子的角色。对于 Options API，beforeCreate 和 created 继续存在；组件在 mountComponent 时会调用 setupComponent，最终会调用 applyOptions 将 options API 和 composition API 进行合并。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>applyOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>ComponentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>deferredData</span>: <span class=kt>DataFn</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nx>deferredWatch</span>: <span class=kt>ComponentWatchOptions</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nx>deferredProvide</span><span class=o>:</span> <span class=p>(</span><span class=nx>Data</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>)[]</span> <span class=o>=</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=nx>asMixin</span>: <span class=kt>boolean</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在明确了上下文和 this 之后，应用“GlobalMixins”之前会调用“beforeCreate”
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>asMixin</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>isInBeforeCreate</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>callSyncHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;beforeCreate&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>BEFORE_CREATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>globalMixins</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>isInBeforeCreate</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 应用 GlobalMixins
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 应用 extendsOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 应用 mixins
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 处理 injectOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 合并 methods
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 处理 dataOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 处理 computedOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 处理 watchOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 处理 provideOptions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>asMixin</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>callSyncHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;created&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>CREATED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>globalMixins</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 处理 lifecycleOptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>callSyncHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;beforeCreate&#39;</span> <span class=o>|</span> <span class=s1>&#39;created&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>LifecycleHooks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>ComponentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>globalMixins</span>: <span class=kt>ComponentOptions</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 循环 globalMixins 的深度，循环调用 mixins[i][name]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callHookFromMixins</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>globalMixins</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=kr>extends</span><span class=o>:</span> <span class=nx>base</span><span class=p>,</span> <span class=nx>mixins</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>base</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 递归调用 base[name]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHookFromExtends</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>base</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>mixins</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环 mixins 的深度，循环调用 mixins[i][name]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHookFromMixins</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>mixins</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用自身的 beforeCreate 或 created
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>selfHook</span> <span class=o>=</span> <span class=nx>options</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>selfHook</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>callWithAsyncErrorHandling</span><span class=p>(</span><span class=nx>selfHook</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>proxy</span><span class=o>!</span><span class=p>),</span> <span class=nx>instance</span><span class=p>,</span> <span class=kr>type</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>onActivated 和 onDeactivated 会通过 registerKeepAliveHook 进行注册。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>onActivated</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>registerKeepAliveHook</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>ACTIVATED</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>onDeactivated</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>registerKeepAliveHook</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>LifecycleHooks</span><span class=p>.</span><span class=nx>DEACTIVATED</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>registerKeepAliveHook</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>hook</span>: <span class=kt>Function</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>__wdc?</span>: <span class=kt>Function</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>LifecycleHooks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>target</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=nx>currentInstance</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// __wdc 的意思是“带有失活检查的”，这玩意，调度器会删除重复的钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>wrappedHook</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=nx>hook</span><span class=p>.</span><span class=nx>__wdc</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>__wdc</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 仅当目标实例不在 deactivated 状态中时才触发 Hook
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>current</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>current</span><span class=p>.</span><span class=nx>isDeactivated</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>current</span> <span class=o>=</span> <span class=nx>current</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>hook</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>injectHook</span><span class=p>(</span><span class=kr>type</span><span class=p>,</span> <span class=nx>wrappedHook</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 除了在目标实例上注册它之外
</span></span></span><span class=line><span class=cl><span class=cm>   * 向上遍历父链，并将其注册到‘are keep-alive roots’的所有祖先实例上
</span></span></span><span class=line><span class=cl><span class=cm>   * 这避免了在调用这些钩子时需要遍历整个组件树，更重要的是，避免了跟踪数组中的子组件
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>current</span> <span class=o>=</span> <span class=nx>target</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>current</span> <span class=o>&amp;&amp;</span> <span class=nx>current</span><span class=p>.</span><span class=nx>parent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isKeepAlive</span><span class=p>(</span><span class=nx>current</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>injectToKeepAliveRoot</span><span class=p>(</span><span class=nx>wrappedHook</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>current</span> <span class=o>=</span> <span class=nx>current</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=computed-2x>computed 2.x</h2><p>computed 是定义在 vm 上的特殊 getter，computedWatcher 在创建的时候会将 dirty 和 lazy 属性设置为 true；当 computed 的值被访问，触发 computedGetter，computedGetter 会调用 watcher.evaluate 进行求值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initState</span> <span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span> <span class=nx>initComputed</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 在 initState 过程中会调用 initComputed(vm, opts.computed)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>initComputed</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>computed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 实例的 computed 创建的 watcher 都保存在 vm._computedWatchers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>watchers</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_computedWatchers</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 循环组件内 computed 配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>computed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * computed 有两种形式：
</span></span></span><span class=line><span class=cl><span class=cm>     * 1. a: () =&gt; someValue
</span></span></span><span class=line><span class=cl><span class=cm>     * 2. b: { get:..., set:... }
</span></span></span><span class=line><span class=cl><span class=cm>     * 最终，都会转化为 getter/setter
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>userDef</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>getter</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>userDef</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span> <span class=o>?</span> <span class=nx>userDef</span> : <span class=kt>userDef.get</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>getter</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;没有 getter？开什么玩笑&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 为计算属性创建 watcher，这里的“副作用回调”为 noop
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>watchers</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>getter</span> <span class=o>||</span> <span class=nx>noop</span><span class=p>,</span> <span class=nx>noop</span><span class=p>,</span> <span class=p>{</span> <span class=nx>lazy</span>: <span class=kt>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 判断 computed 属性是否和 vm.$data、vm.$options.methods、vm.$options.props 冲突
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>vm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>defineComputed</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>userDef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 冲突的话，抛出警告
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=sb>`already defined in data`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=sb>`already defined as a prop`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>methods</span> <span class=o>&amp;&amp;</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>methods</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=sb>`already defined as a method`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineComputed</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>userDef</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>userDef</span><span class=p>.</span><span class=kr>get</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>userDef</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span> <span class=o>?</span> <span class=nx>userDef</span> : <span class=kt>userDef.get</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>get</span><span class=o>:</span> <span class=nx>createComputedGetter</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>set</span><span class=o>:</span> <span class=nx>userDef</span><span class=p>.</span><span class=kr>set</span> <span class=o>||</span> <span class=nx>noop</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createComputedGetter</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>computedGetter() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>watcher</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>dirty</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 惰性求值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>depend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=computed-3x>computed 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 处理两种参数形式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>computed</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=nx>getterOrOptions</span>: <span class=kt>ComputedGetter</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>WritableComputedOptions</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>getter</span>: <span class=kt>ComputedGetter</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>setter</span>: <span class=kt>ComputedSetter</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 标准化参数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>getterOrOptions</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span> <span class=o>=</span> <span class=nx>getterOrOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>setter</span> <span class=o>=</span> <span class=nx>NOOP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span> <span class=o>=</span> <span class=nx>getterOrOptions</span><span class=p>.</span><span class=kr>get</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>setter</span> <span class=o>=</span> <span class=nx>getterOrOptions</span><span class=p>.</span><span class=kr>set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回 computed 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>new</span> <span class=nx>ComputedRefImpl</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>setter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isFunction</span><span class=p>(</span><span class=nx>getterOrOptions</span><span class=p>)</span> <span class=o>||</span> <span class=o>!</span><span class=nx>getterOrOptions</span><span class=p>.</span><span class=kr>set</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * computed 有别于一般的副作用（watch/render）
</span></span></span><span class=line><span class=cl><span class=cm> * 它的 effect 在创建时，不会被运行一次（lazy 是 true）
</span></span></span><span class=line><span class=cl><span class=cm> * 当内部的 value 被访问时，才进行第一次依赖收集（运行 this.effect 求值，然后被收集）
</span></span></span><span class=line><span class=cl><span class=cm> * 当 getter 内部访问到的数据更新时，只会将 _dirty 置为 true
</span></span></span><span class=line><span class=cl><span class=cm> * 当内部的 value 再次被访问时，才会重新求值
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ComputedRefImpl</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>_dirty</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 初始化的时候，默认是“脏”的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>private</span> <span class=nx>_value</span><span class=o>!:</span> <span class=nx>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>readonly</span> <span class=nx>__v_isRef</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// computed 是一个 ref
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>public</span> <span class=kr>readonly</span> <span class=p>[</span><span class=nx>ReactiveFlags</span><span class=p>.</span><span class=nx>IS_READONLY</span><span class=p>]</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>readonly</span> <span class=nx>effect</span>: <span class=kt>ReactiveEffect</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span>: <span class=kt>ComputedGetter</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>_setter</span>: <span class=kt>ComputedSetter</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isReadonly</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * this.effect 还没有运行过，还没有被 getter 中访问到的数据收集过
</span></span></span><span class=line><span class=cl><span class=cm>     * scheduler 运行，将 this._dirty 赋值为 true
</span></span></span><span class=line><span class=cl><span class=cm>     * valueGetter 会执行 this.effect 进行求值
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 valueGetter 没有被访问到
</span></span></span><span class=line><span class=cl><span class=cm>     * this.effect 也不会被依赖收集
</span></span></span><span class=line><span class=cl><span class=cm>     * 更不会进行求值
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>effect</span> <span class=o>=</span> <span class=nx>effect</span><span class=p>(</span><span class=nx>getter</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 等到 computedValueGetter 被访问时，才会运行 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>lazy</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 每当依赖更新，scheduler 将 this._dirty 设置为 true，并派发通知
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>scheduler</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>_dirty</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>_dirty</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 派发通知，通知访问该计算属性的 activeEffect 运行
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>trigger</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=s1>&#39;set&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>[</span><span class=s1>&#39;__v_isReadonly&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>isReadonly</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>value() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 渲染开始时，当 .value 真正被访问，computedValueGetter 才被触发
</span></span></span><span class=line><span class=cl><span class=cm>     * 调用 this.effect，getter 副作用运行，track 被调用，依赖被收集
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_dirty</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 值是通过调用 effect 获得的，缓存在 this._value 上
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>_value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>effect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 当被外界 get 之后，数据不再“脏”了（因为刚刚进行求值，值还是新的）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>_dirty</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * computed 本身被访问，computed 内部的 getter 会访问别的响应式数据
</span></span></span><span class=line><span class=cl><span class=cm>     * 这种情况会发生 effect 嵌套，所以这里需要触发 track
</span></span></span><span class=line><span class=cl><span class=cm>     * 这时候的 computed 很像一个 ref 有没有？
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>track</span><span class=p>(</span><span class=nx>toRaw</span><span class=p>(</span><span class=k>this</span><span class=p>),</span> <span class=s1>&#39;get&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回计算值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>set</span> <span class=nx>value</span><span class=p>(</span><span class=nx>newValue</span>: <span class=kt>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_setter</span><span class=p>(</span><span class=nx>newValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=diff-2x>diff 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span><span class=lnt>439
</span><span class=lnt>440
</span><span class=lnt>441
</span><span class=lnt>442
</span><span class=lnt>443
</span><span class=lnt>444
</span><span class=lnt>445
</span><span class=lnt>446
</span><span class=lnt>447
</span><span class=lnt>448
</span><span class=lnt>449
</span><span class=lnt>450
</span><span class=lnt>451
</span><span class=lnt>452
</span><span class=lnt>453
</span><span class=lnt>454
</span><span class=lnt>455
</span><span class=lnt>456
</span><span class=lnt>457
</span><span class=lnt>458
</span><span class=lnt>459
</span><span class=lnt>460
</span><span class=lnt>461
</span><span class=lnt>462
</span><span class=lnt>463
</span><span class=lnt>464
</span><span class=lnt>465
</span><span class=lnt>466
</span><span class=lnt>467
</span><span class=lnt>468
</span><span class=lnt>469
</span><span class=lnt>470
</span><span class=lnt>471
</span><span class=lnt>472
</span><span class=lnt>473
</span><span class=lnt>474
</span><span class=lnt>475
</span><span class=lnt>476
</span><span class=lnt>477
</span><span class=lnt>478
</span><span class=lnt>479
</span><span class=lnt>480
</span><span class=lnt>481
</span><span class=lnt>482
</span><span class=lnt>483
</span><span class=lnt>484
</span><span class=lnt>485
</span><span class=lnt>486
</span><span class=lnt>487
</span><span class=lnt>488
</span><span class=lnt>489
</span><span class=lnt>490
</span><span class=lnt>491
</span><span class=lnt>492
</span><span class=lnt>493
</span><span class=lnt>494
</span><span class=lnt>495
</span><span class=lnt>496
</span><span class=lnt>497
</span><span class=lnt>498
</span><span class=lnt>499
</span><span class=lnt>500
</span><span class=lnt>501
</span><span class=lnt>502
</span><span class=lnt>503
</span><span class=lnt>504
</span><span class=lnt>505
</span><span class=lnt>506
</span><span class=lnt>507
</span><span class=lnt>508
</span><span class=lnt>509
</span><span class=lnt>510
</span><span class=lnt>511
</span><span class=lnt>512
</span><span class=lnt>513
</span><span class=lnt>514
</span><span class=lnt>515
</span><span class=lnt>516
</span><span class=lnt>517
</span><span class=lnt>518
</span><span class=lnt>519
</span><span class=lnt>520
</span><span class=lnt>521
</span><span class=lnt>522
</span><span class=lnt>523
</span><span class=lnt>524
</span><span class=lnt>525
</span><span class=lnt>526
</span><span class=lnt>527
</span><span class=lnt>528
</span><span class=lnt>529
</span><span class=lnt>530
</span><span class=lnt>531
</span><span class=lnt>532
</span><span class=lnt>533
</span><span class=lnt>534
</span><span class=lnt>535
</span><span class=lnt>536
</span><span class=lnt>537
</span><span class=lnt>538
</span><span class=lnt>539
</span><span class=lnt>540
</span><span class=lnt>541
</span><span class=lnt>542
</span><span class=lnt>543
</span><span class=lnt>544
</span><span class=lnt>545
</span><span class=lnt>546
</span><span class=lnt>547
</span><span class=lnt>548
</span><span class=lnt>549
</span><span class=lnt>550
</span><span class=lnt>551
</span><span class=lnt>552
</span><span class=lnt>553
</span><span class=lnt>554
</span><span class=lnt>555
</span><span class=lnt>556
</span><span class=lnt>557
</span><span class=lnt>558
</span><span class=lnt>559
</span><span class=lnt>560
</span><span class=lnt>561
</span><span class=lnt>562
</span><span class=lnt>563
</span><span class=lnt>564
</span><span class=lnt>565
</span><span class=lnt>566
</span><span class=lnt>567
</span><span class=lnt>568
</span><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span><span class=lnt>583
</span><span class=lnt>584
</span><span class=lnt>585
</span><span class=lnt>586
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 挂载
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>mountComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span>: <span class=kt>?Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeMount&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 创建 renderWatcher
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>noop</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>before() {</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果是更新流程，调用“beforeUpdate”钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;mounted&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 调用 render，返回 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_render</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span><span class=o>:</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vm</span>: <span class=kt>Component</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>render</span><span class=p>,</span> <span class=nx>_parentVnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>_parentVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span> <span class=o>=</span> <span class=nx>normalizeScopedSlots</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>_parentVnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>scopedSlots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置父节点，这允许 render 访问占位符节点上的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>=</span> <span class=nx>_parentVnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 渲染自身
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 不需要维护栈的原因是，render 是依次分开被调用的
</span></span></span><span class=line><span class=cl><span class=cm>     * 当父级 patched 之后，嵌套组件的 render 才会被调用
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentRenderingInstance</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * vm._renderProxy = vm
</span></span></span><span class=line><span class=cl><span class=cm>     * vm.$createElement = (a, b, c, d) =&gt; createElement(vm, a, b, c, d, true)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>render</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_renderProxy</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$createElement</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=sb>`render`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>renderError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>renderError</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span><span class=p>.</span><span class=nx>_renderProxy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span><span class=p>.</span><span class=nx>$createElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>e</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=sb>`renderError`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 渲染完成，重置变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>currentRenderingInstance</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>vnode</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;2.x 里 render 不能返回多个节点，需要有一个根节点&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 返回空节点代替
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createEmptyVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置父节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span> <span class=o>=</span> <span class=nx>_parentVnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// h 函数，生成 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>normalizationType</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>alwaysNormalize</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=nb>Array</span><span class=p>&lt;</span><span class=nt>VNode</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPrimitive</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>normalizationType</span> <span class=o>=</span> <span class=nx>children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span> <span class=o>=</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>alwaysNormalize</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>normalizationType</span> <span class=o>=</span> <span class=nx>ALWAYS_NORMALIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>_createElement</span><span class=p>(</span><span class=nx>context</span><span class=p>,</span> <span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>normalizationType</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>_createElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag?</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nx>Class</span><span class=p>&lt;</span><span class=nt>Component</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data?</span>: <span class=kt>VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children?</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>normalizationType?</span>: <span class=kt>number</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=nb>Array</span><span class=p>&lt;</span><span class=nt>VNode</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createEmptyVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// &lt;component :is=&#34;xxx&#34; /&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=k>is</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=k>is</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>tag</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createEmptyVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isPrimitive</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;key 只能为“原始值”&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// children 为数组并且第一项与函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>children</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>children</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 作为作用域插槽的默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>data</span><span class=p>.</span><span class=nx>scopedSlots</span> <span class=o>=</span> <span class=p>{</span> <span class=k>default</span><span class=o>:</span> <span class=nx>children</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>normalizationType</span> <span class=o>===</span> <span class=nx>ALWAYS_NORMALIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span> <span class=o>=</span> <span class=nx>normalizeChildren</span><span class=p>(</span><span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>normalizationType</span> <span class=o>===</span> <span class=nx>SIMPLE_NORMALIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span> <span class=o>=</span> <span class=nx>simpleNormalizeChildren</span><span class=p>(</span><span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>Ctor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>ns</span> <span class=o>=</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>)</span> <span class=o>||</span> <span class=nx>config</span><span class=p>.</span><span class=nx>getTagNamespace</span><span class=p>(</span><span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>isReservedTag</span><span class=p>(</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 平台原生/内建标签
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>nativeOn</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>tag</span> <span class=o>!==</span> <span class=s1>&#39;component&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;.native 修饰符只能用在组件上，而不是原生元素上&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=p>.</span><span class=nx>parsePlatformTagName</span><span class=p>(</span><span class=nx>tag</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=o>!</span><span class=nx>data</span> <span class=o>||</span> <span class=o>!</span><span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>isDef</span><span class=p>((</span><span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsset</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$options</span><span class=p>,</span> <span class=s1>&#39;components&#39;</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Vue 组件，使用 createComponent 创建 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 未知元素
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 组件选项/构造函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>ns</span><span class=p>))</span> <span class=nx>applyNS</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>ns</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=nx>registerDeepBindings</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createEmptyVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ctor</span>: <span class=kt>Class</span><span class=p>&lt;</span><span class=nt>Component</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span>: <span class=kt>?VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>?Array</span><span class=p>&lt;</span><span class=nt>VNode</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag?</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=nb>Array</span><span class=p>&lt;</span><span class=nt>VNode</span><span class=p>&gt;</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>baseCtor</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>baseCtor</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>Ctor</span> <span class=o>!==</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 异步组件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>asyncFactory</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span> <span class=o>=</span> <span class=nx>Ctor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsyncComponent</span><span class=p>(</span><span class=nx>asyncFactory</span><span class=p>,</span> <span class=nx>baseCtor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Ctor</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>createAsyncPlaceholder</span><span class=p>(</span><span class=nx>asyncFactory</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// v-model 转换为 props 和事件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>model</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>transformModel</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span> <span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 提取 props
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>propsData</span> <span class=o>=</span> <span class=nx>extractPropsFromVNodeData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>functional</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 函数式组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>createFunctionalComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>listeners</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 on.native 替代 nativeOn
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>data</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>nativeOn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=kr>abstract</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 抽象组件除了 props、listeners、slot，什么都不管
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span> <span class=o>=</span> <span class=nx>slot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>installComponentHooks</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>tag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`vue-component-</span><span class=si>${</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=si>}${</span><span class=nx>name</span> <span class=o>?</span> <span class=sb>`-</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>undefined</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>listeners</span><span class=p>,</span> <span class=nx>tag</span><span class=p>,</span> <span class=nx>children</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 将 VNode 更新到 DOM
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_update</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>,</span> <span class=nx>hydrating?</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vm</span>: <span class=kt>Component</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>prevEl</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>;</span> <span class=c1>// 旧 VNode 挂载的 DOM 节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>prevVnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>;</span> <span class=c1>// 旧 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>restoreActiveInstance</span> <span class=o>=</span> <span class=nx>setActiveInstance</span><span class=p>(</span><span class=nx>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初次渲染
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 应用更新
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>restoreActiveInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>prevEl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>prevEl</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果父组件是告诫组件，更新他的 $el 属性
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * patch 在做什么？
</span></span></span><span class=line><span class=cl><span class=cm> * 1. vnode 不存在，oldVnode 存在，销毁旧节点
</span></span></span><span class=line><span class=cl><span class=cm> * 2. vnode 存在：
</span></span></span><span class=line><span class=cl><span class=cm> *      2.1 oldVnode 不存在，组件首次渲染
</span></span></span><span class=line><span class=cl><span class=cm> *      2.2 oldVnode 存在：
</span></span></span><span class=line><span class=cl><span class=cm> *              2.2.1 oldVnode 是 DOM 元素，根组件的首次渲染
</span></span></span><span class=line><span class=cl><span class=cm> *              2.2.2 oldVnode 不是 DOM 元素，组件更新：
</span></span></span><span class=line><span class=cl><span class=cm> *                  2.2.2.1 oldVnode 与 vnode 相同节点，调用 patchVNode
</span></span></span><span class=line><span class=cl><span class=cm> *                  2.2.2.2 oldVnode 与 vnode 不同节点，卸载 oldVnode 创建 vnode
</span></span></span><span class=line><span class=cl><span class=cm> * 什么是相同节点？
</span></span></span><span class=line><span class=cl><span class=cm> * 1. key 相等
</span></span></span><span class=line><span class=cl><span class=cm> * 2. tag 相同
</span></span></span><span class=line><span class=cl><span class=cm> * 3. 都（不）是注释节点
</span></span></span><span class=line><span class=cl><span class=cm> * 4. data 都（没有）定义
</span></span></span><span class=line><span class=cl><span class=cm> * 5. 如果是 input，type 要一致
</span></span></span><span class=line><span class=cl><span class=cm> * 6. 如果都是异步组件，工厂函数要完全相同
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>__patch__</span> <span class=o>=</span> <span class=kd>function</span> <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>removeOnly</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 旧节点存在新节点不存在，触发旧节点的 destory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否是初次 patch
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>insertedVnodeQueue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 旧节点不存在？肯定是第一次 patch，创建新的根元素
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>createElm</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 旧节点存在，属于更新流程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isRealElement</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isRealElement</span> <span class=o>&amp;&amp;</span> <span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isRealElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// oldVnode 是 DOM 节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span> <span class=o>===</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>hasAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldVnode</span> <span class=o>=</span> <span class=nx>emptyNodeAt</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>oldElm</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parentElm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>parentNode</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>);</span> <span class=c1>// 旧 VNode 对应元素的父级
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 创建一个 DOM 元素
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>createElm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldElm</span><span class=p>.</span><span class=nx>_leaveCb</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 递归更新父级的占位节点元素
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>patchable</span> <span class=o>=</span> <span class=nx>isPatchable</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nx>ancestor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>ancestor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nx>ancestor</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>patchable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>emptyNode</span><span class=p>,</span> <span class=nx>ancestor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>insert</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>.</span><span class=nx>insert</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>insert</span><span class=p>.</span><span class=nx>merged</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>[</span><span class=nx>i</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>registerRef</span><span class=p>(</span><span class=nx>ancestor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>removeVnodes</span><span class=p>([</span><span class=nx>oldVnode</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 销毁旧节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>);</span> <span class=c1>// 触发就节点的 destory 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>invokeInsertHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>isInitialPatch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// 当 oldVnode 与 vnode 相同节点，会调用 patchVNode 更新节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>oldVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ownerArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>removeOnly</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 一摸一样？返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>oldVnode</span> <span class=o>===</span> <span class=nx>vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>ownerArray</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>ownerArray</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span> <span class=o>=</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>elm</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>isAsyncPlaceholder</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 旧 VNode 异步占位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>asyncFactory</span><span class=p>.</span><span class=nx>resolved</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hydrate</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>isAsyncPlaceholder</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果是静态树，可以复用元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>isTrue</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>isStatic</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>isTrue</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>isStatic</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>===</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>isCloned</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isTrue</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>isOnce</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 新旧都是静态的，且 key 相同
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 prepatch 钩子（更新之前的钩子）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>prepatch</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>oldCh</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>children</span><span class=p>;</span> <span class=c1>// 旧 VNode 子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>ch</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span><span class=p>;</span> <span class=c1>// 新 VNode 子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isPatchable</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// VNode 可修补
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>update</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>update</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>update</span><span class=p>)))</span> <span class=nx>i</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span> <span class=c1>// 调用 VNode 的 Update
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>ch</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 新旧子节点不同，需要更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>oldCh</span> <span class=o>!==</span> <span class=nx>ch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>updateChildren</span><span class=p>(</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>ch</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>ch</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 旧子节点是文本？清空文本，添加新子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>text</span><span class=p>))</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>setTextContent</span><span class=p>(</span><span class=nx>elm</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>addVnodes</span><span class=p>(</span><span class=nx>elm</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>ch</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>ch</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 没有新子节点，仅有旧的子节点，那么删除旧的就好
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>removeVnodes</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>text</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 清空旧的文本子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>setTextContent</span><span class=p>(</span><span class=nx>elm</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>text</span> <span class=o>!==</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果新旧子节点都为文本节点，更新文字就好
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>setTextContent</span><span class=p>(</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 postpatch 钩子（更新之后的钩子）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>((</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>postpatch</span><span class=p>)))</span> <span class=nx>i</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// diff（更新新旧 VNode 的子节点）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>updateChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>parentElm</span><span class=p>,</span> <span class=c1>// VNode 对应的 DOM 元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>oldCh</span><span class=p>,</span> <span class=c1>// 旧 VNode 的子元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>newCh</span><span class=p>,</span> <span class=c1>// 新 VNode 的子元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>removeOnly</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>oldStartIdx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>oldEndIdx</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// 下一个未经 patch 的旧子 VNode 节点，在此索引之前的旧子 VNode 都已经处理完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>oldEndIdx</span><span class=p>];</span> <span class=c1>// 最后一个未经 patch 的旧子 VNode 节点，在此索引之后的旧子 VNode 都已经处理完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>newStartIdx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>newEndIdx</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// 下一个未经 patch 的新子 VNode 节点，在此索引之前的新子 VNode 都已经处理完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span><span class=p>];</span> <span class=c1>// 最后一个未经 patch 的新子 VNode 节点，在此索引之前的新子 VNode 都已经处理完毕
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>oldKeyToIdx</span><span class=p>,</span> <span class=nx>idxInOld</span><span class=p>,</span> <span class=nx>vnodeToMove</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 只有 &lt;transition-group&gt; 用到，确保在 transitions 期间移除元素呆在正确的相对位置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>canMove</span> <span class=o>=</span> <span class=o>!</span><span class=nx>removeOnly</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 当下一个未经处理的（新/旧）节点的索引小于等于最后一个未经处理的（新/旧）节点的索引
</span></span></span><span class=line><span class=cl><span class=cm>   * 每次循环会进行四次比较：
</span></span></span><span class=line><span class=cl><span class=cm>   * 1. sameVnode(oldStartVnode, newStartVnode)
</span></span></span><span class=line><span class=cl><span class=cm>   * 2. sameVnode(oldEndVnode, newEndVnode)
</span></span></span><span class=line><span class=cl><span class=cm>   * 3. sameVnode(oldStartVnode, newEndVnode)
</span></span></span><span class=line><span class=cl><span class=cm>   * 4. sameVnode(oldEndVnode, newStartVnode)
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&lt;=</span> <span class=nx>oldEndIdx</span> <span class=o>&amp;&amp;</span> <span class=nx>newStartIdx</span> <span class=o>&lt;=</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>];</span> <span class=c1>// 下一个旧的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>];</span> <span class=c1>// 上一个旧的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartIdx</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>];</span> <span class=c1>// 下一个旧的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>];</span> <span class=c1>// 下一个新的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndIdx</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>];</span> <span class=c1>// 上一个旧的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>];</span> <span class=c1>// 上一个新的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 下一个未经 patch 的旧子 VNode 节点 和 最后一个未经 patch 的新子 VNode 节点 相同
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndIdx</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>canMove</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 最后一个未经 patch 的旧子 VNode 节点 和 下一个未经 patch 的新子 VNode 节点 相同
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartIdx</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>canMove</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldKeyToIdx</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldKeyToIdx</span> <span class=o>=</span> <span class=nx>createKeyToOldIdx</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>idxInOld</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>oldKeyToIdx</span><span class=p>[</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>findIdxInOld</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>idxInOld</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>createElm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>newStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>newStartIdx</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnodeToMove</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>vnodeToMove</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>patchVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>vnodeToMove</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartIdx</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>]</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>canMove</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnodeToMove</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>createElm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartIdx</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&gt;</span> <span class=nx>oldEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>refElm</span> <span class=o>=</span> <span class=nx>isUndef</span><span class=p>(</span><span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=nx>elm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>addVnodes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>refElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>newCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>newStartIdx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>newEndIdx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>insertedVnodeQueue</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>newStartIdx</span> <span class=o>&gt;</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>removeVnodes</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=diff-3x>diff 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>   1
</span><span class=lnt>   2
</span><span class=lnt>   3
</span><span class=lnt>   4
</span><span class=lnt>   5
</span><span class=lnt>   6
</span><span class=lnt>   7
</span><span class=lnt>   8
</span><span class=lnt>   9
</span><span class=lnt>  10
</span><span class=lnt>  11
</span><span class=lnt>  12
</span><span class=lnt>  13
</span><span class=lnt>  14
</span><span class=lnt>  15
</span><span class=lnt>  16
</span><span class=lnt>  17
</span><span class=lnt>  18
</span><span class=lnt>  19
</span><span class=lnt>  20
</span><span class=lnt>  21
</span><span class=lnt>  22
</span><span class=lnt>  23
</span><span class=lnt>  24
</span><span class=lnt>  25
</span><span class=lnt>  26
</span><span class=lnt>  27
</span><span class=lnt>  28
</span><span class=lnt>  29
</span><span class=lnt>  30
</span><span class=lnt>  31
</span><span class=lnt>  32
</span><span class=lnt>  33
</span><span class=lnt>  34
</span><span class=lnt>  35
</span><span class=lnt>  36
</span><span class=lnt>  37
</span><span class=lnt>  38
</span><span class=lnt>  39
</span><span class=lnt>  40
</span><span class=lnt>  41
</span><span class=lnt>  42
</span><span class=lnt>  43
</span><span class=lnt>  44
</span><span class=lnt>  45
</span><span class=lnt>  46
</span><span class=lnt>  47
</span><span class=lnt>  48
</span><span class=lnt>  49
</span><span class=lnt>  50
</span><span class=lnt>  51
</span><span class=lnt>  52
</span><span class=lnt>  53
</span><span class=lnt>  54
</span><span class=lnt>  55
</span><span class=lnt>  56
</span><span class=lnt>  57
</span><span class=lnt>  58
</span><span class=lnt>  59
</span><span class=lnt>  60
</span><span class=lnt>  61
</span><span class=lnt>  62
</span><span class=lnt>  63
</span><span class=lnt>  64
</span><span class=lnt>  65
</span><span class=lnt>  66
</span><span class=lnt>  67
</span><span class=lnt>  68
</span><span class=lnt>  69
</span><span class=lnt>  70
</span><span class=lnt>  71
</span><span class=lnt>  72
</span><span class=lnt>  73
</span><span class=lnt>  74
</span><span class=lnt>  75
</span><span class=lnt>  76
</span><span class=lnt>  77
</span><span class=lnt>  78
</span><span class=lnt>  79
</span><span class=lnt>  80
</span><span class=lnt>  81
</span><span class=lnt>  82
</span><span class=lnt>  83
</span><span class=lnt>  84
</span><span class=lnt>  85
</span><span class=lnt>  86
</span><span class=lnt>  87
</span><span class=lnt>  88
</span><span class=lnt>  89
</span><span class=lnt>  90
</span><span class=lnt>  91
</span><span class=lnt>  92
</span><span class=lnt>  93
</span><span class=lnt>  94
</span><span class=lnt>  95
</span><span class=lnt>  96
</span><span class=lnt>  97
</span><span class=lnt>  98
</span><span class=lnt>  99
</span><span class=lnt> 100
</span><span class=lnt> 101
</span><span class=lnt> 102
</span><span class=lnt> 103
</span><span class=lnt> 104
</span><span class=lnt> 105
</span><span class=lnt> 106
</span><span class=lnt> 107
</span><span class=lnt> 108
</span><span class=lnt> 109
</span><span class=lnt> 110
</span><span class=lnt> 111
</span><span class=lnt> 112
</span><span class=lnt> 113
</span><span class=lnt> 114
</span><span class=lnt> 115
</span><span class=lnt> 116
</span><span class=lnt> 117
</span><span class=lnt> 118
</span><span class=lnt> 119
</span><span class=lnt> 120
</span><span class=lnt> 121
</span><span class=lnt> 122
</span><span class=lnt> 123
</span><span class=lnt> 124
</span><span class=lnt> 125
</span><span class=lnt> 126
</span><span class=lnt> 127
</span><span class=lnt> 128
</span><span class=lnt> 129
</span><span class=lnt> 130
</span><span class=lnt> 131
</span><span class=lnt> 132
</span><span class=lnt> 133
</span><span class=lnt> 134
</span><span class=lnt> 135
</span><span class=lnt> 136
</span><span class=lnt> 137
</span><span class=lnt> 138
</span><span class=lnt> 139
</span><span class=lnt> 140
</span><span class=lnt> 141
</span><span class=lnt> 142
</span><span class=lnt> 143
</span><span class=lnt> 144
</span><span class=lnt> 145
</span><span class=lnt> 146
</span><span class=lnt> 147
</span><span class=lnt> 148
</span><span class=lnt> 149
</span><span class=lnt> 150
</span><span class=lnt> 151
</span><span class=lnt> 152
</span><span class=lnt> 153
</span><span class=lnt> 154
</span><span class=lnt> 155
</span><span class=lnt> 156
</span><span class=lnt> 157
</span><span class=lnt> 158
</span><span class=lnt> 159
</span><span class=lnt> 160
</span><span class=lnt> 161
</span><span class=lnt> 162
</span><span class=lnt> 163
</span><span class=lnt> 164
</span><span class=lnt> 165
</span><span class=lnt> 166
</span><span class=lnt> 167
</span><span class=lnt> 168
</span><span class=lnt> 169
</span><span class=lnt> 170
</span><span class=lnt> 171
</span><span class=lnt> 172
</span><span class=lnt> 173
</span><span class=lnt> 174
</span><span class=lnt> 175
</span><span class=lnt> 176
</span><span class=lnt> 177
</span><span class=lnt> 178
</span><span class=lnt> 179
</span><span class=lnt> 180
</span><span class=lnt> 181
</span><span class=lnt> 182
</span><span class=lnt> 183
</span><span class=lnt> 184
</span><span class=lnt> 185
</span><span class=lnt> 186
</span><span class=lnt> 187
</span><span class=lnt> 188
</span><span class=lnt> 189
</span><span class=lnt> 190
</span><span class=lnt> 191
</span><span class=lnt> 192
</span><span class=lnt> 193
</span><span class=lnt> 194
</span><span class=lnt> 195
</span><span class=lnt> 196
</span><span class=lnt> 197
</span><span class=lnt> 198
</span><span class=lnt> 199
</span><span class=lnt> 200
</span><span class=lnt> 201
</span><span class=lnt> 202
</span><span class=lnt> 203
</span><span class=lnt> 204
</span><span class=lnt> 205
</span><span class=lnt> 206
</span><span class=lnt> 207
</span><span class=lnt> 208
</span><span class=lnt> 209
</span><span class=lnt> 210
</span><span class=lnt> 211
</span><span class=lnt> 212
</span><span class=lnt> 213
</span><span class=lnt> 214
</span><span class=lnt> 215
</span><span class=lnt> 216
</span><span class=lnt> 217
</span><span class=lnt> 218
</span><span class=lnt> 219
</span><span class=lnt> 220
</span><span class=lnt> 221
</span><span class=lnt> 222
</span><span class=lnt> 223
</span><span class=lnt> 224
</span><span class=lnt> 225
</span><span class=lnt> 226
</span><span class=lnt> 227
</span><span class=lnt> 228
</span><span class=lnt> 229
</span><span class=lnt> 230
</span><span class=lnt> 231
</span><span class=lnt> 232
</span><span class=lnt> 233
</span><span class=lnt> 234
</span><span class=lnt> 235
</span><span class=lnt> 236
</span><span class=lnt> 237
</span><span class=lnt> 238
</span><span class=lnt> 239
</span><span class=lnt> 240
</span><span class=lnt> 241
</span><span class=lnt> 242
</span><span class=lnt> 243
</span><span class=lnt> 244
</span><span class=lnt> 245
</span><span class=lnt> 246
</span><span class=lnt> 247
</span><span class=lnt> 248
</span><span class=lnt> 249
</span><span class=lnt> 250
</span><span class=lnt> 251
</span><span class=lnt> 252
</span><span class=lnt> 253
</span><span class=lnt> 254
</span><span class=lnt> 255
</span><span class=lnt> 256
</span><span class=lnt> 257
</span><span class=lnt> 258
</span><span class=lnt> 259
</span><span class=lnt> 260
</span><span class=lnt> 261
</span><span class=lnt> 262
</span><span class=lnt> 263
</span><span class=lnt> 264
</span><span class=lnt> 265
</span><span class=lnt> 266
</span><span class=lnt> 267
</span><span class=lnt> 268
</span><span class=lnt> 269
</span><span class=lnt> 270
</span><span class=lnt> 271
</span><span class=lnt> 272
</span><span class=lnt> 273
</span><span class=lnt> 274
</span><span class=lnt> 275
</span><span class=lnt> 276
</span><span class=lnt> 277
</span><span class=lnt> 278
</span><span class=lnt> 279
</span><span class=lnt> 280
</span><span class=lnt> 281
</span><span class=lnt> 282
</span><span class=lnt> 283
</span><span class=lnt> 284
</span><span class=lnt> 285
</span><span class=lnt> 286
</span><span class=lnt> 287
</span><span class=lnt> 288
</span><span class=lnt> 289
</span><span class=lnt> 290
</span><span class=lnt> 291
</span><span class=lnt> 292
</span><span class=lnt> 293
</span><span class=lnt> 294
</span><span class=lnt> 295
</span><span class=lnt> 296
</span><span class=lnt> 297
</span><span class=lnt> 298
</span><span class=lnt> 299
</span><span class=lnt> 300
</span><span class=lnt> 301
</span><span class=lnt> 302
</span><span class=lnt> 303
</span><span class=lnt> 304
</span><span class=lnt> 305
</span><span class=lnt> 306
</span><span class=lnt> 307
</span><span class=lnt> 308
</span><span class=lnt> 309
</span><span class=lnt> 310
</span><span class=lnt> 311
</span><span class=lnt> 312
</span><span class=lnt> 313
</span><span class=lnt> 314
</span><span class=lnt> 315
</span><span class=lnt> 316
</span><span class=lnt> 317
</span><span class=lnt> 318
</span><span class=lnt> 319
</span><span class=lnt> 320
</span><span class=lnt> 321
</span><span class=lnt> 322
</span><span class=lnt> 323
</span><span class=lnt> 324
</span><span class=lnt> 325
</span><span class=lnt> 326
</span><span class=lnt> 327
</span><span class=lnt> 328
</span><span class=lnt> 329
</span><span class=lnt> 330
</span><span class=lnt> 331
</span><span class=lnt> 332
</span><span class=lnt> 333
</span><span class=lnt> 334
</span><span class=lnt> 335
</span><span class=lnt> 336
</span><span class=lnt> 337
</span><span class=lnt> 338
</span><span class=lnt> 339
</span><span class=lnt> 340
</span><span class=lnt> 341
</span><span class=lnt> 342
</span><span class=lnt> 343
</span><span class=lnt> 344
</span><span class=lnt> 345
</span><span class=lnt> 346
</span><span class=lnt> 347
</span><span class=lnt> 348
</span><span class=lnt> 349
</span><span class=lnt> 350
</span><span class=lnt> 351
</span><span class=lnt> 352
</span><span class=lnt> 353
</span><span class=lnt> 354
</span><span class=lnt> 355
</span><span class=lnt> 356
</span><span class=lnt> 357
</span><span class=lnt> 358
</span><span class=lnt> 359
</span><span class=lnt> 360
</span><span class=lnt> 361
</span><span class=lnt> 362
</span><span class=lnt> 363
</span><span class=lnt> 364
</span><span class=lnt> 365
</span><span class=lnt> 366
</span><span class=lnt> 367
</span><span class=lnt> 368
</span><span class=lnt> 369
</span><span class=lnt> 370
</span><span class=lnt> 371
</span><span class=lnt> 372
</span><span class=lnt> 373
</span><span class=lnt> 374
</span><span class=lnt> 375
</span><span class=lnt> 376
</span><span class=lnt> 377
</span><span class=lnt> 378
</span><span class=lnt> 379
</span><span class=lnt> 380
</span><span class=lnt> 381
</span><span class=lnt> 382
</span><span class=lnt> 383
</span><span class=lnt> 384
</span><span class=lnt> 385
</span><span class=lnt> 386
</span><span class=lnt> 387
</span><span class=lnt> 388
</span><span class=lnt> 389
</span><span class=lnt> 390
</span><span class=lnt> 391
</span><span class=lnt> 392
</span><span class=lnt> 393
</span><span class=lnt> 394
</span><span class=lnt> 395
</span><span class=lnt> 396
</span><span class=lnt> 397
</span><span class=lnt> 398
</span><span class=lnt> 399
</span><span class=lnt> 400
</span><span class=lnt> 401
</span><span class=lnt> 402
</span><span class=lnt> 403
</span><span class=lnt> 404
</span><span class=lnt> 405
</span><span class=lnt> 406
</span><span class=lnt> 407
</span><span class=lnt> 408
</span><span class=lnt> 409
</span><span class=lnt> 410
</span><span class=lnt> 411
</span><span class=lnt> 412
</span><span class=lnt> 413
</span><span class=lnt> 414
</span><span class=lnt> 415
</span><span class=lnt> 416
</span><span class=lnt> 417
</span><span class=lnt> 418
</span><span class=lnt> 419
</span><span class=lnt> 420
</span><span class=lnt> 421
</span><span class=lnt> 422
</span><span class=lnt> 423
</span><span class=lnt> 424
</span><span class=lnt> 425
</span><span class=lnt> 426
</span><span class=lnt> 427
</span><span class=lnt> 428
</span><span class=lnt> 429
</span><span class=lnt> 430
</span><span class=lnt> 431
</span><span class=lnt> 432
</span><span class=lnt> 433
</span><span class=lnt> 434
</span><span class=lnt> 435
</span><span class=lnt> 436
</span><span class=lnt> 437
</span><span class=lnt> 438
</span><span class=lnt> 439
</span><span class=lnt> 440
</span><span class=lnt> 441
</span><span class=lnt> 442
</span><span class=lnt> 443
</span><span class=lnt> 444
</span><span class=lnt> 445
</span><span class=lnt> 446
</span><span class=lnt> 447
</span><span class=lnt> 448
</span><span class=lnt> 449
</span><span class=lnt> 450
</span><span class=lnt> 451
</span><span class=lnt> 452
</span><span class=lnt> 453
</span><span class=lnt> 454
</span><span class=lnt> 455
</span><span class=lnt> 456
</span><span class=lnt> 457
</span><span class=lnt> 458
</span><span class=lnt> 459
</span><span class=lnt> 460
</span><span class=lnt> 461
</span><span class=lnt> 462
</span><span class=lnt> 463
</span><span class=lnt> 464
</span><span class=lnt> 465
</span><span class=lnt> 466
</span><span class=lnt> 467
</span><span class=lnt> 468
</span><span class=lnt> 469
</span><span class=lnt> 470
</span><span class=lnt> 471
</span><span class=lnt> 472
</span><span class=lnt> 473
</span><span class=lnt> 474
</span><span class=lnt> 475
</span><span class=lnt> 476
</span><span class=lnt> 477
</span><span class=lnt> 478
</span><span class=lnt> 479
</span><span class=lnt> 480
</span><span class=lnt> 481
</span><span class=lnt> 482
</span><span class=lnt> 483
</span><span class=lnt> 484
</span><span class=lnt> 485
</span><span class=lnt> 486
</span><span class=lnt> 487
</span><span class=lnt> 488
</span><span class=lnt> 489
</span><span class=lnt> 490
</span><span class=lnt> 491
</span><span class=lnt> 492
</span><span class=lnt> 493
</span><span class=lnt> 494
</span><span class=lnt> 495
</span><span class=lnt> 496
</span><span class=lnt> 497
</span><span class=lnt> 498
</span><span class=lnt> 499
</span><span class=lnt> 500
</span><span class=lnt> 501
</span><span class=lnt> 502
</span><span class=lnt> 503
</span><span class=lnt> 504
</span><span class=lnt> 505
</span><span class=lnt> 506
</span><span class=lnt> 507
</span><span class=lnt> 508
</span><span class=lnt> 509
</span><span class=lnt> 510
</span><span class=lnt> 511
</span><span class=lnt> 512
</span><span class=lnt> 513
</span><span class=lnt> 514
</span><span class=lnt> 515
</span><span class=lnt> 516
</span><span class=lnt> 517
</span><span class=lnt> 518
</span><span class=lnt> 519
</span><span class=lnt> 520
</span><span class=lnt> 521
</span><span class=lnt> 522
</span><span class=lnt> 523
</span><span class=lnt> 524
</span><span class=lnt> 525
</span><span class=lnt> 526
</span><span class=lnt> 527
</span><span class=lnt> 528
</span><span class=lnt> 529
</span><span class=lnt> 530
</span><span class=lnt> 531
</span><span class=lnt> 532
</span><span class=lnt> 533
</span><span class=lnt> 534
</span><span class=lnt> 535
</span><span class=lnt> 536
</span><span class=lnt> 537
</span><span class=lnt> 538
</span><span class=lnt> 539
</span><span class=lnt> 540
</span><span class=lnt> 541
</span><span class=lnt> 542
</span><span class=lnt> 543
</span><span class=lnt> 544
</span><span class=lnt> 545
</span><span class=lnt> 546
</span><span class=lnt> 547
</span><span class=lnt> 548
</span><span class=lnt> 549
</span><span class=lnt> 550
</span><span class=lnt> 551
</span><span class=lnt> 552
</span><span class=lnt> 553
</span><span class=lnt> 554
</span><span class=lnt> 555
</span><span class=lnt> 556
</span><span class=lnt> 557
</span><span class=lnt> 558
</span><span class=lnt> 559
</span><span class=lnt> 560
</span><span class=lnt> 561
</span><span class=lnt> 562
</span><span class=lnt> 563
</span><span class=lnt> 564
</span><span class=lnt> 565
</span><span class=lnt> 566
</span><span class=lnt> 567
</span><span class=lnt> 568
</span><span class=lnt> 569
</span><span class=lnt> 570
</span><span class=lnt> 571
</span><span class=lnt> 572
</span><span class=lnt> 573
</span><span class=lnt> 574
</span><span class=lnt> 575
</span><span class=lnt> 576
</span><span class=lnt> 577
</span><span class=lnt> 578
</span><span class=lnt> 579
</span><span class=lnt> 580
</span><span class=lnt> 581
</span><span class=lnt> 582
</span><span class=lnt> 583
</span><span class=lnt> 584
</span><span class=lnt> 585
</span><span class=lnt> 586
</span><span class=lnt> 587
</span><span class=lnt> 588
</span><span class=lnt> 589
</span><span class=lnt> 590
</span><span class=lnt> 591
</span><span class=lnt> 592
</span><span class=lnt> 593
</span><span class=lnt> 594
</span><span class=lnt> 595
</span><span class=lnt> 596
</span><span class=lnt> 597
</span><span class=lnt> 598
</span><span class=lnt> 599
</span><span class=lnt> 600
</span><span class=lnt> 601
</span><span class=lnt> 602
</span><span class=lnt> 603
</span><span class=lnt> 604
</span><span class=lnt> 605
</span><span class=lnt> 606
</span><span class=lnt> 607
</span><span class=lnt> 608
</span><span class=lnt> 609
</span><span class=lnt> 610
</span><span class=lnt> 611
</span><span class=lnt> 612
</span><span class=lnt> 613
</span><span class=lnt> 614
</span><span class=lnt> 615
</span><span class=lnt> 616
</span><span class=lnt> 617
</span><span class=lnt> 618
</span><span class=lnt> 619
</span><span class=lnt> 620
</span><span class=lnt> 621
</span><span class=lnt> 622
</span><span class=lnt> 623
</span><span class=lnt> 624
</span><span class=lnt> 625
</span><span class=lnt> 626
</span><span class=lnt> 627
</span><span class=lnt> 628
</span><span class=lnt> 629
</span><span class=lnt> 630
</span><span class=lnt> 631
</span><span class=lnt> 632
</span><span class=lnt> 633
</span><span class=lnt> 634
</span><span class=lnt> 635
</span><span class=lnt> 636
</span><span class=lnt> 637
</span><span class=lnt> 638
</span><span class=lnt> 639
</span><span class=lnt> 640
</span><span class=lnt> 641
</span><span class=lnt> 642
</span><span class=lnt> 643
</span><span class=lnt> 644
</span><span class=lnt> 645
</span><span class=lnt> 646
</span><span class=lnt> 647
</span><span class=lnt> 648
</span><span class=lnt> 649
</span><span class=lnt> 650
</span><span class=lnt> 651
</span><span class=lnt> 652
</span><span class=lnt> 653
</span><span class=lnt> 654
</span><span class=lnt> 655
</span><span class=lnt> 656
</span><span class=lnt> 657
</span><span class=lnt> 658
</span><span class=lnt> 659
</span><span class=lnt> 660
</span><span class=lnt> 661
</span><span class=lnt> 662
</span><span class=lnt> 663
</span><span class=lnt> 664
</span><span class=lnt> 665
</span><span class=lnt> 666
</span><span class=lnt> 667
</span><span class=lnt> 668
</span><span class=lnt> 669
</span><span class=lnt> 670
</span><span class=lnt> 671
</span><span class=lnt> 672
</span><span class=lnt> 673
</span><span class=lnt> 674
</span><span class=lnt> 675
</span><span class=lnt> 676
</span><span class=lnt> 677
</span><span class=lnt> 678
</span><span class=lnt> 679
</span><span class=lnt> 680
</span><span class=lnt> 681
</span><span class=lnt> 682
</span><span class=lnt> 683
</span><span class=lnt> 684
</span><span class=lnt> 685
</span><span class=lnt> 686
</span><span class=lnt> 687
</span><span class=lnt> 688
</span><span class=lnt> 689
</span><span class=lnt> 690
</span><span class=lnt> 691
</span><span class=lnt> 692
</span><span class=lnt> 693
</span><span class=lnt> 694
</span><span class=lnt> 695
</span><span class=lnt> 696
</span><span class=lnt> 697
</span><span class=lnt> 698
</span><span class=lnt> 699
</span><span class=lnt> 700
</span><span class=lnt> 701
</span><span class=lnt> 702
</span><span class=lnt> 703
</span><span class=lnt> 704
</span><span class=lnt> 705
</span><span class=lnt> 706
</span><span class=lnt> 707
</span><span class=lnt> 708
</span><span class=lnt> 709
</span><span class=lnt> 710
</span><span class=lnt> 711
</span><span class=lnt> 712
</span><span class=lnt> 713
</span><span class=lnt> 714
</span><span class=lnt> 715
</span><span class=lnt> 716
</span><span class=lnt> 717
</span><span class=lnt> 718
</span><span class=lnt> 719
</span><span class=lnt> 720
</span><span class=lnt> 721
</span><span class=lnt> 722
</span><span class=lnt> 723
</span><span class=lnt> 724
</span><span class=lnt> 725
</span><span class=lnt> 726
</span><span class=lnt> 727
</span><span class=lnt> 728
</span><span class=lnt> 729
</span><span class=lnt> 730
</span><span class=lnt> 731
</span><span class=lnt> 732
</span><span class=lnt> 733
</span><span class=lnt> 734
</span><span class=lnt> 735
</span><span class=lnt> 736
</span><span class=lnt> 737
</span><span class=lnt> 738
</span><span class=lnt> 739
</span><span class=lnt> 740
</span><span class=lnt> 741
</span><span class=lnt> 742
</span><span class=lnt> 743
</span><span class=lnt> 744
</span><span class=lnt> 745
</span><span class=lnt> 746
</span><span class=lnt> 747
</span><span class=lnt> 748
</span><span class=lnt> 749
</span><span class=lnt> 750
</span><span class=lnt> 751
</span><span class=lnt> 752
</span><span class=lnt> 753
</span><span class=lnt> 754
</span><span class=lnt> 755
</span><span class=lnt> 756
</span><span class=lnt> 757
</span><span class=lnt> 758
</span><span class=lnt> 759
</span><span class=lnt> 760
</span><span class=lnt> 761
</span><span class=lnt> 762
</span><span class=lnt> 763
</span><span class=lnt> 764
</span><span class=lnt> 765
</span><span class=lnt> 766
</span><span class=lnt> 767
</span><span class=lnt> 768
</span><span class=lnt> 769
</span><span class=lnt> 770
</span><span class=lnt> 771
</span><span class=lnt> 772
</span><span class=lnt> 773
</span><span class=lnt> 774
</span><span class=lnt> 775
</span><span class=lnt> 776
</span><span class=lnt> 777
</span><span class=lnt> 778
</span><span class=lnt> 779
</span><span class=lnt> 780
</span><span class=lnt> 781
</span><span class=lnt> 782
</span><span class=lnt> 783
</span><span class=lnt> 784
</span><span class=lnt> 785
</span><span class=lnt> 786
</span><span class=lnt> 787
</span><span class=lnt> 788
</span><span class=lnt> 789
</span><span class=lnt> 790
</span><span class=lnt> 791
</span><span class=lnt> 792
</span><span class=lnt> 793
</span><span class=lnt> 794
</span><span class=lnt> 795
</span><span class=lnt> 796
</span><span class=lnt> 797
</span><span class=lnt> 798
</span><span class=lnt> 799
</span><span class=lnt> 800
</span><span class=lnt> 801
</span><span class=lnt> 802
</span><span class=lnt> 803
</span><span class=lnt> 804
</span><span class=lnt> 805
</span><span class=lnt> 806
</span><span class=lnt> 807
</span><span class=lnt> 808
</span><span class=lnt> 809
</span><span class=lnt> 810
</span><span class=lnt> 811
</span><span class=lnt> 812
</span><span class=lnt> 813
</span><span class=lnt> 814
</span><span class=lnt> 815
</span><span class=lnt> 816
</span><span class=lnt> 817
</span><span class=lnt> 818
</span><span class=lnt> 819
</span><span class=lnt> 820
</span><span class=lnt> 821
</span><span class=lnt> 822
</span><span class=lnt> 823
</span><span class=lnt> 824
</span><span class=lnt> 825
</span><span class=lnt> 826
</span><span class=lnt> 827
</span><span class=lnt> 828
</span><span class=lnt> 829
</span><span class=lnt> 830
</span><span class=lnt> 831
</span><span class=lnt> 832
</span><span class=lnt> 833
</span><span class=lnt> 834
</span><span class=lnt> 835
</span><span class=lnt> 836
</span><span class=lnt> 837
</span><span class=lnt> 838
</span><span class=lnt> 839
</span><span class=lnt> 840
</span><span class=lnt> 841
</span><span class=lnt> 842
</span><span class=lnt> 843
</span><span class=lnt> 844
</span><span class=lnt> 845
</span><span class=lnt> 846
</span><span class=lnt> 847
</span><span class=lnt> 848
</span><span class=lnt> 849
</span><span class=lnt> 850
</span><span class=lnt> 851
</span><span class=lnt> 852
</span><span class=lnt> 853
</span><span class=lnt> 854
</span><span class=lnt> 855
</span><span class=lnt> 856
</span><span class=lnt> 857
</span><span class=lnt> 858
</span><span class=lnt> 859
</span><span class=lnt> 860
</span><span class=lnt> 861
</span><span class=lnt> 862
</span><span class=lnt> 863
</span><span class=lnt> 864
</span><span class=lnt> 865
</span><span class=lnt> 866
</span><span class=lnt> 867
</span><span class=lnt> 868
</span><span class=lnt> 869
</span><span class=lnt> 870
</span><span class=lnt> 871
</span><span class=lnt> 872
</span><span class=lnt> 873
</span><span class=lnt> 874
</span><span class=lnt> 875
</span><span class=lnt> 876
</span><span class=lnt> 877
</span><span class=lnt> 878
</span><span class=lnt> 879
</span><span class=lnt> 880
</span><span class=lnt> 881
</span><span class=lnt> 882
</span><span class=lnt> 883
</span><span class=lnt> 884
</span><span class=lnt> 885
</span><span class=lnt> 886
</span><span class=lnt> 887
</span><span class=lnt> 888
</span><span class=lnt> 889
</span><span class=lnt> 890
</span><span class=lnt> 891
</span><span class=lnt> 892
</span><span class=lnt> 893
</span><span class=lnt> 894
</span><span class=lnt> 895
</span><span class=lnt> 896
</span><span class=lnt> 897
</span><span class=lnt> 898
</span><span class=lnt> 899
</span><span class=lnt> 900
</span><span class=lnt> 901
</span><span class=lnt> 902
</span><span class=lnt> 903
</span><span class=lnt> 904
</span><span class=lnt> 905
</span><span class=lnt> 906
</span><span class=lnt> 907
</span><span class=lnt> 908
</span><span class=lnt> 909
</span><span class=lnt> 910
</span><span class=lnt> 911
</span><span class=lnt> 912
</span><span class=lnt> 913
</span><span class=lnt> 914
</span><span class=lnt> 915
</span><span class=lnt> 916
</span><span class=lnt> 917
</span><span class=lnt> 918
</span><span class=lnt> 919
</span><span class=lnt> 920
</span><span class=lnt> 921
</span><span class=lnt> 922
</span><span class=lnt> 923
</span><span class=lnt> 924
</span><span class=lnt> 925
</span><span class=lnt> 926
</span><span class=lnt> 927
</span><span class=lnt> 928
</span><span class=lnt> 929
</span><span class=lnt> 930
</span><span class=lnt> 931
</span><span class=lnt> 932
</span><span class=lnt> 933
</span><span class=lnt> 934
</span><span class=lnt> 935
</span><span class=lnt> 936
</span><span class=lnt> 937
</span><span class=lnt> 938
</span><span class=lnt> 939
</span><span class=lnt> 940
</span><span class=lnt> 941
</span><span class=lnt> 942
</span><span class=lnt> 943
</span><span class=lnt> 944
</span><span class=lnt> 945
</span><span class=lnt> 946
</span><span class=lnt> 947
</span><span class=lnt> 948
</span><span class=lnt> 949
</span><span class=lnt> 950
</span><span class=lnt> 951
</span><span class=lnt> 952
</span><span class=lnt> 953
</span><span class=lnt> 954
</span><span class=lnt> 955
</span><span class=lnt> 956
</span><span class=lnt> 957
</span><span class=lnt> 958
</span><span class=lnt> 959
</span><span class=lnt> 960
</span><span class=lnt> 961
</span><span class=lnt> 962
</span><span class=lnt> 963
</span><span class=lnt> 964
</span><span class=lnt> 965
</span><span class=lnt> 966
</span><span class=lnt> 967
</span><span class=lnt> 968
</span><span class=lnt> 969
</span><span class=lnt> 970
</span><span class=lnt> 971
</span><span class=lnt> 972
</span><span class=lnt> 973
</span><span class=lnt> 974
</span><span class=lnt> 975
</span><span class=lnt> 976
</span><span class=lnt> 977
</span><span class=lnt> 978
</span><span class=lnt> 979
</span><span class=lnt> 980
</span><span class=lnt> 981
</span><span class=lnt> 982
</span><span class=lnt> 983
</span><span class=lnt> 984
</span><span class=lnt> 985
</span><span class=lnt> 986
</span><span class=lnt> 987
</span><span class=lnt> 988
</span><span class=lnt> 989
</span><span class=lnt> 990
</span><span class=lnt> 991
</span><span class=lnt> 992
</span><span class=lnt> 993
</span><span class=lnt> 994
</span><span class=lnt> 995
</span><span class=lnt> 996
</span><span class=lnt> 997
</span><span class=lnt> 998
</span><span class=lnt> 999
</span><span class=lnt>1000
</span><span class=lnt>1001
</span><span class=lnt>1002
</span><span class=lnt>1003
</span><span class=lnt>1004
</span><span class=lnt>1005
</span><span class=lnt>1006
</span><span class=lnt>1007
</span><span class=lnt>1008
</span><span class=lnt>1009
</span><span class=lnt>1010
</span><span class=lnt>1011
</span><span class=lnt>1012
</span><span class=lnt>1013
</span><span class=lnt>1014
</span><span class=lnt>1015
</span><span class=lnt>1016
</span><span class=lnt>1017
</span><span class=lnt>1018
</span><span class=lnt>1019
</span><span class=lnt>1020
</span><span class=lnt>1021
</span><span class=lnt>1022
</span><span class=lnt>1023
</span><span class=lnt>1024
</span><span class=lnt>1025
</span><span class=lnt>1026
</span><span class=lnt>1027
</span><span class=lnt>1028
</span><span class=lnt>1029
</span><span class=lnt>1030
</span><span class=lnt>1031
</span><span class=lnt>1032
</span><span class=lnt>1033
</span><span class=lnt>1034
</span><span class=lnt>1035
</span><span class=lnt>1036
</span><span class=lnt>1037
</span><span class=lnt>1038
</span><span class=lnt>1039
</span><span class=lnt>1040
</span><span class=lnt>1041
</span><span class=lnt>1042
</span><span class=lnt>1043
</span><span class=lnt>1044
</span><span class=lnt>1045
</span><span class=lnt>1046
</span><span class=lnt>1047
</span><span class=lnt>1048
</span><span class=lnt>1049
</span><span class=lnt>1050
</span><span class=lnt>1051
</span><span class=lnt>1052
</span><span class=lnt>1053
</span><span class=lnt>1054
</span><span class=lnt>1055
</span><span class=lnt>1056
</span><span class=lnt>1057
</span><span class=lnt>1058
</span><span class=lnt>1059
</span><span class=lnt>1060
</span><span class=lnt>1061
</span><span class=lnt>1062
</span><span class=lnt>1063
</span><span class=lnt>1064
</span><span class=lnt>1065
</span><span class=lnt>1066
</span><span class=lnt>1067
</span><span class=lnt>1068
</span><span class=lnt>1069
</span><span class=lnt>1070
</span><span class=lnt>1071
</span><span class=lnt>1072
</span><span class=lnt>1073
</span><span class=lnt>1074
</span><span class=lnt>1075
</span><span class=lnt>1076
</span><span class=lnt>1077
</span><span class=lnt>1078
</span><span class=lnt>1079
</span><span class=lnt>1080
</span><span class=lnt>1081
</span><span class=lnt>1082
</span><span class=lnt>1083
</span><span class=lnt>1084
</span><span class=lnt>1085
</span><span class=lnt>1086
</span><span class=lnt>1087
</span><span class=lnt>1088
</span><span class=lnt>1089
</span><span class=lnt>1090
</span><span class=lnt>1091
</span><span class=lnt>1092
</span><span class=lnt>1093
</span><span class=lnt>1094
</span><span class=lnt>1095
</span><span class=lnt>1096
</span><span class=lnt>1097
</span><span class=lnt>1098
</span><span class=lnt>1099
</span><span class=lnt>1100
</span><span class=lnt>1101
</span><span class=lnt>1102
</span><span class=lnt>1103
</span><span class=lnt>1104
</span><span class=lnt>1105
</span><span class=lnt>1106
</span><span class=lnt>1107
</span><span class=lnt>1108
</span><span class=lnt>1109
</span><span class=lnt>1110
</span><span class=lnt>1111
</span><span class=lnt>1112
</span><span class=lnt>1113
</span><span class=lnt>1114
</span><span class=lnt>1115
</span><span class=lnt>1116
</span><span class=lnt>1117
</span><span class=lnt>1118
</span><span class=lnt>1119
</span><span class=lnt>1120
</span><span class=lnt>1121
</span><span class=lnt>1122
</span><span class=lnt>1123
</span><span class=lnt>1124
</span><span class=lnt>1125
</span><span class=lnt>1126
</span><span class=lnt>1127
</span><span class=lnt>1128
</span><span class=lnt>1129
</span><span class=lnt>1130
</span><span class=lnt>1131
</span><span class=lnt>1132
</span><span class=lnt>1133
</span><span class=lnt>1134
</span><span class=lnt>1135
</span><span class=lnt>1136
</span><span class=lnt>1137
</span><span class=lnt>1138
</span><span class=lnt>1139
</span><span class=lnt>1140
</span><span class=lnt>1141
</span><span class=lnt>1142
</span><span class=lnt>1143
</span><span class=lnt>1144
</span><span class=lnt>1145
</span><span class=lnt>1146
</span><span class=lnt>1147
</span><span class=lnt>1148
</span><span class=lnt>1149
</span><span class=lnt>1150
</span><span class=lnt>1151
</span><span class=lnt>1152
</span><span class=lnt>1153
</span><span class=lnt>1154
</span><span class=lnt>1155
</span><span class=lnt>1156
</span><span class=lnt>1157
</span><span class=lnt>1158
</span><span class=lnt>1159
</span><span class=lnt>1160
</span><span class=lnt>1161
</span><span class=lnt>1162
</span><span class=lnt>1163
</span><span class=lnt>1164
</span><span class=lnt>1165
</span><span class=lnt>1166
</span><span class=lnt>1167
</span><span class=lnt>1168
</span><span class=lnt>1169
</span><span class=lnt>1170
</span><span class=lnt>1171
</span><span class=lnt>1172
</span><span class=lnt>1173
</span><span class=lnt>1174
</span><span class=lnt>1175
</span><span class=lnt>1176
</span><span class=lnt>1177
</span><span class=lnt>1178
</span><span class=lnt>1179
</span><span class=lnt>1180
</span><span class=lnt>1181
</span><span class=lnt>1182
</span><span class=lnt>1183
</span><span class=lnt>1184
</span><span class=lnt>1185
</span><span class=lnt>1186
</span><span class=lnt>1187
</span><span class=lnt>1188
</span><span class=lnt>1189
</span><span class=lnt>1190
</span><span class=lnt>1191
</span><span class=lnt>1192
</span><span class=lnt>1193
</span><span class=lnt>1194
</span><span class=lnt>1195
</span><span class=lnt>1196
</span><span class=lnt>1197
</span><span class=lnt>1198
</span><span class=lnt>1199
</span><span class=lnt>1200
</span><span class=lnt>1201
</span><span class=lnt>1202
</span><span class=lnt>1203
</span><span class=lnt>1204
</span><span class=lnt>1205
</span><span class=lnt>1206
</span><span class=lnt>1207
</span><span class=lnt>1208
</span><span class=lnt>1209
</span><span class=lnt>1210
</span><span class=lnt>1211
</span><span class=lnt>1212
</span><span class=lnt>1213
</span><span class=lnt>1214
</span><span class=lnt>1215
</span><span class=lnt>1216
</span><span class=lnt>1217
</span><span class=lnt>1218
</span><span class=lnt>1219
</span><span class=lnt>1220
</span><span class=lnt>1221
</span><span class=lnt>1222
</span><span class=lnt>1223
</span><span class=lnt>1224
</span><span class=lnt>1225
</span><span class=lnt>1226
</span><span class=lnt>1227
</span><span class=lnt>1228
</span><span class=lnt>1229
</span><span class=lnt>1230
</span><span class=lnt>1231
</span><span class=lnt>1232
</span><span class=lnt>1233
</span><span class=lnt>1234
</span><span class=lnt>1235
</span><span class=lnt>1236
</span><span class=lnt>1237
</span><span class=lnt>1238
</span><span class=lnt>1239
</span><span class=lnt>1240
</span><span class=lnt>1241
</span><span class=lnt>1242
</span><span class=lnt>1243
</span><span class=lnt>1244
</span><span class=lnt>1245
</span><span class=lnt>1246
</span><span class=lnt>1247
</span><span class=lnt>1248
</span><span class=lnt>1249
</span><span class=lnt>1250
</span><span class=lnt>1251
</span><span class=lnt>1252
</span><span class=lnt>1253
</span><span class=lnt>1254
</span><span class=lnt>1255
</span><span class=lnt>1256
</span><span class=lnt>1257
</span><span class=lnt>1258
</span><span class=lnt>1259
</span><span class=lnt>1260
</span><span class=lnt>1261
</span><span class=lnt>1262
</span><span class=lnt>1263
</span><span class=lnt>1264
</span><span class=lnt>1265
</span><span class=lnt>1266
</span><span class=lnt>1267
</span><span class=lnt>1268
</span><span class=lnt>1269
</span><span class=lnt>1270
</span><span class=lnt>1271
</span><span class=lnt>1272
</span><span class=lnt>1273
</span><span class=lnt>1274
</span><span class=lnt>1275
</span><span class=lnt>1276
</span><span class=lnt>1277
</span><span class=lnt>1278
</span><span class=lnt>1279
</span><span class=lnt>1280
</span><span class=lnt>1281
</span><span class=lnt>1282
</span><span class=lnt>1283
</span><span class=lnt>1284
</span><span class=lnt>1285
</span><span class=lnt>1286
</span><span class=lnt>1287
</span><span class=lnt>1288
</span><span class=lnt>1289
</span><span class=lnt>1290
</span><span class=lnt>1291
</span><span class=lnt>1292
</span><span class=lnt>1293
</span><span class=lnt>1294
</span><span class=lnt>1295
</span><span class=lnt>1296
</span><span class=lnt>1297
</span><span class=lnt>1298
</span><span class=lnt>1299
</span><span class=lnt>1300
</span><span class=lnt>1301
</span><span class=lnt>1302
</span><span class=lnt>1303
</span><span class=lnt>1304
</span><span class=lnt>1305
</span><span class=lnt>1306
</span><span class=lnt>1307
</span><span class=lnt>1308
</span><span class=lnt>1309
</span><span class=lnt>1310
</span><span class=lnt>1311
</span><span class=lnt>1312
</span><span class=lnt>1313
</span><span class=lnt>1314
</span><span class=lnt>1315
</span><span class=lnt>1316
</span><span class=lnt>1317
</span><span class=lnt>1318
</span><span class=lnt>1319
</span><span class=lnt>1320
</span><span class=lnt>1321
</span><span class=lnt>1322
</span><span class=lnt>1323
</span><span class=lnt>1324
</span><span class=lnt>1325
</span><span class=lnt>1326
</span><span class=lnt>1327
</span><span class=lnt>1328
</span><span class=lnt>1329
</span><span class=lnt>1330
</span><span class=lnt>1331
</span><span class=lnt>1332
</span><span class=lnt>1333
</span><span class=lnt>1334
</span><span class=lnt>1335
</span><span class=lnt>1336
</span><span class=lnt>1337
</span><span class=lnt>1338
</span><span class=lnt>1339
</span><span class=lnt>1340
</span><span class=lnt>1341
</span><span class=lnt>1342
</span><span class=lnt>1343
</span><span class=lnt>1344
</span><span class=lnt>1345
</span><span class=lnt>1346
</span><span class=lnt>1347
</span><span class=lnt>1348
</span><span class=lnt>1349
</span><span class=lnt>1350
</span><span class=lnt>1351
</span><span class=lnt>1352
</span><span class=lnt>1353
</span><span class=lnt>1354
</span><span class=lnt>1355
</span><span class=lnt>1356
</span><span class=lnt>1357
</span><span class=lnt>1358
</span><span class=lnt>1359
</span><span class=lnt>1360
</span><span class=lnt>1361
</span><span class=lnt>1362
</span><span class=lnt>1363
</span><span class=lnt>1364
</span><span class=lnt>1365
</span><span class=lnt>1366
</span><span class=lnt>1367
</span><span class=lnt>1368
</span><span class=lnt>1369
</span><span class=lnt>1370
</span><span class=lnt>1371
</span><span class=lnt>1372
</span><span class=lnt>1373
</span><span class=lnt>1374
</span><span class=lnt>1375
</span><span class=lnt>1376
</span><span class=lnt>1377
</span><span class=lnt>1378
</span><span class=lnt>1379
</span><span class=lnt>1380
</span><span class=lnt>1381
</span><span class=lnt>1382
</span><span class=lnt>1383
</span><span class=lnt>1384
</span><span class=lnt>1385
</span><span class=lnt>1386
</span><span class=lnt>1387
</span><span class=lnt>1388
</span><span class=lnt>1389
</span><span class=lnt>1390
</span><span class=lnt>1391
</span><span class=lnt>1392
</span><span class=lnt>1393
</span><span class=lnt>1394
</span><span class=lnt>1395
</span><span class=lnt>1396
</span><span class=lnt>1397
</span><span class=lnt>1398
</span><span class=lnt>1399
</span><span class=lnt>1400
</span><span class=lnt>1401
</span><span class=lnt>1402
</span><span class=lnt>1403
</span><span class=lnt>1404
</span><span class=lnt>1405
</span><span class=lnt>1406
</span><span class=lnt>1407
</span><span class=lnt>1408
</span><span class=lnt>1409
</span><span class=lnt>1410
</span><span class=lnt>1411
</span><span class=lnt>1412
</span><span class=lnt>1413
</span><span class=lnt>1414
</span><span class=lnt>1415
</span><span class=lnt>1416
</span><span class=lnt>1417
</span><span class=lnt>1418
</span><span class=lnt>1419
</span><span class=lnt>1420
</span><span class=lnt>1421
</span><span class=lnt>1422
</span><span class=lnt>1423
</span><span class=lnt>1424
</span><span class=lnt>1425
</span><span class=lnt>1426
</span><span class=lnt>1427
</span><span class=lnt>1428
</span><span class=lnt>1429
</span><span class=lnt>1430
</span><span class=lnt>1431
</span><span class=lnt>1432
</span><span class=lnt>1433
</span><span class=lnt>1434
</span><span class=lnt>1435
</span><span class=lnt>1436
</span><span class=lnt>1437
</span><span class=lnt>1438
</span><span class=lnt>1439
</span><span class=lnt>1440
</span><span class=lnt>1441
</span><span class=lnt>1442
</span><span class=lnt>1443
</span><span class=lnt>1444
</span><span class=lnt>1445
</span><span class=lnt>1446
</span><span class=lnt>1447
</span><span class=lnt>1448
</span><span class=lnt>1449
</span><span class=lnt>1450
</span><span class=lnt>1451
</span><span class=lnt>1452
</span><span class=lnt>1453
</span><span class=lnt>1454
</span><span class=lnt>1455
</span><span class=lnt>1456
</span><span class=lnt>1457
</span><span class=lnt>1458
</span><span class=lnt>1459
</span><span class=lnt>1460
</span><span class=lnt>1461
</span><span class=lnt>1462
</span><span class=lnt>1463
</span><span class=lnt>1464
</span><span class=lnt>1465
</span><span class=lnt>1466
</span><span class=lnt>1467
</span><span class=lnt>1468
</span><span class=lnt>1469
</span><span class=lnt>1470
</span><span class=lnt>1471
</span><span class=lnt>1472
</span><span class=lnt>1473
</span><span class=lnt>1474
</span><span class=lnt>1475
</span><span class=lnt>1476
</span><span class=lnt>1477
</span><span class=lnt>1478
</span><span class=lnt>1479
</span><span class=lnt>1480
</span><span class=lnt>1481
</span><span class=lnt>1482
</span><span class=lnt>1483
</span><span class=lnt>1484
</span><span class=lnt>1485
</span><span class=lnt>1486
</span><span class=lnt>1487
</span><span class=lnt>1488
</span><span class=lnt>1489
</span><span class=lnt>1490
</span><span class=lnt>1491
</span><span class=lnt>1492
</span><span class=lnt>1493
</span><span class=lnt>1494
</span><span class=lnt>1495
</span><span class=lnt>1496
</span><span class=lnt>1497
</span><span class=lnt>1498
</span><span class=lnt>1499
</span><span class=lnt>1500
</span><span class=lnt>1501
</span><span class=lnt>1502
</span><span class=lnt>1503
</span><span class=lnt>1504
</span><span class=lnt>1505
</span><span class=lnt>1506
</span><span class=lnt>1507
</span><span class=lnt>1508
</span><span class=lnt>1509
</span><span class=lnt>1510
</span><span class=lnt>1511
</span><span class=lnt>1512
</span><span class=lnt>1513
</span><span class=lnt>1514
</span><span class=lnt>1515
</span><span class=lnt>1516
</span><span class=lnt>1517
</span><span class=lnt>1518
</span><span class=lnt>1519
</span><span class=lnt>1520
</span><span class=lnt>1521
</span><span class=lnt>1522
</span><span class=lnt>1523
</span><span class=lnt>1524
</span><span class=lnt>1525
</span><span class=lnt>1526
</span><span class=lnt>1527
</span><span class=lnt>1528
</span><span class=lnt>1529
</span><span class=lnt>1530
</span><span class=lnt>1531
</span><span class=lnt>1532
</span><span class=lnt>1533
</span><span class=lnt>1534
</span><span class=lnt>1535
</span><span class=lnt>1536
</span><span class=lnt>1537
</span><span class=lnt>1538
</span><span class=lnt>1539
</span><span class=lnt>1540
</span><span class=lnt>1541
</span><span class=lnt>1542
</span><span class=lnt>1543
</span><span class=lnt>1544
</span><span class=lnt>1545
</span><span class=lnt>1546
</span><span class=lnt>1547
</span><span class=lnt>1548
</span><span class=lnt>1549
</span><span class=lnt>1550
</span><span class=lnt>1551
</span><span class=lnt>1552
</span><span class=lnt>1553
</span><span class=lnt>1554
</span><span class=lnt>1555
</span><span class=lnt>1556
</span><span class=lnt>1557
</span><span class=lnt>1558
</span><span class=lnt>1559
</span><span class=lnt>1560
</span><span class=lnt>1561
</span><span class=lnt>1562
</span><span class=lnt>1563
</span><span class=lnt>1564
</span><span class=lnt>1565
</span><span class=lnt>1566
</span><span class=lnt>1567
</span><span class=lnt>1568
</span><span class=lnt>1569
</span><span class=lnt>1570
</span><span class=lnt>1571
</span><span class=lnt>1572
</span><span class=lnt>1573
</span><span class=lnt>1574
</span><span class=lnt>1575
</span><span class=lnt>1576
</span><span class=lnt>1577
</span><span class=lnt>1578
</span><span class=lnt>1579
</span><span class=lnt>1580
</span><span class=lnt>1581
</span><span class=lnt>1582
</span><span class=lnt>1583
</span><span class=lnt>1584
</span><span class=lnt>1585
</span><span class=lnt>1586
</span><span class=lnt>1587
</span><span class=lnt>1588
</span><span class=lnt>1589
</span><span class=lnt>1590
</span><span class=lnt>1591
</span><span class=lnt>1592
</span><span class=lnt>1593
</span><span class=lnt>1594
</span><span class=lnt>1595
</span><span class=lnt>1596
</span><span class=lnt>1597
</span><span class=lnt>1598
</span><span class=lnt>1599
</span><span class=lnt>1600
</span><span class=lnt>1601
</span><span class=lnt>1602
</span><span class=lnt>1603
</span><span class=lnt>1604
</span><span class=lnt>1605
</span><span class=lnt>1606
</span><span class=lnt>1607
</span><span class=lnt>1608
</span><span class=lnt>1609
</span><span class=lnt>1610
</span><span class=lnt>1611
</span><span class=lnt>1612
</span><span class=lnt>1613
</span><span class=lnt>1614
</span><span class=lnt>1615
</span><span class=lnt>1616
</span><span class=lnt>1617
</span><span class=lnt>1618
</span><span class=lnt>1619
</span><span class=lnt>1620
</span><span class=lnt>1621
</span><span class=lnt>1622
</span><span class=lnt>1623
</span><span class=lnt>1624
</span><span class=lnt>1625
</span><span class=lnt>1626
</span><span class=lnt>1627
</span><span class=lnt>1628
</span><span class=lnt>1629
</span><span class=lnt>1630
</span><span class=lnt>1631
</span><span class=lnt>1632
</span><span class=lnt>1633
</span><span class=lnt>1634
</span><span class=lnt>1635
</span><span class=lnt>1636
</span><span class=lnt>1637
</span><span class=lnt>1638
</span><span class=lnt>1639
</span><span class=lnt>1640
</span><span class=lnt>1641
</span><span class=lnt>1642
</span><span class=lnt>1643
</span><span class=lnt>1644
</span><span class=lnt>1645
</span><span class=lnt>1646
</span><span class=lnt>1647
</span><span class=lnt>1648
</span><span class=lnt>1649
</span><span class=lnt>1650
</span><span class=lnt>1651
</span><span class=lnt>1652
</span><span class=lnt>1653
</span><span class=lnt>1654
</span><span class=lnt>1655
</span><span class=lnt>1656
</span><span class=lnt>1657
</span><span class=lnt>1658
</span><span class=lnt>1659
</span><span class=lnt>1660
</span><span class=lnt>1661
</span><span class=lnt>1662
</span><span class=lnt>1663
</span><span class=lnt>1664
</span><span class=lnt>1665
</span><span class=lnt>1666
</span><span class=lnt>1667
</span><span class=lnt>1668
</span><span class=lnt>1669
</span><span class=lnt>1670
</span><span class=lnt>1671
</span><span class=lnt>1672
</span><span class=lnt>1673
</span><span class=lnt>1674
</span><span class=lnt>1675
</span><span class=lnt>1676
</span><span class=lnt>1677
</span><span class=lnt>1678
</span><span class=lnt>1679
</span><span class=lnt>1680
</span><span class=lnt>1681
</span><span class=lnt>1682
</span><span class=lnt>1683
</span><span class=lnt>1684
</span><span class=lnt>1685
</span><span class=lnt>1686
</span><span class=lnt>1687
</span><span class=lnt>1688
</span><span class=lnt>1689
</span><span class=lnt>1690
</span><span class=lnt>1691
</span><span class=lnt>1692
</span><span class=lnt>1693
</span><span class=lnt>1694
</span><span class=lnt>1695
</span><span class=lnt>1696
</span><span class=lnt>1697
</span><span class=lnt>1698
</span><span class=lnt>1699
</span><span class=lnt>1700
</span><span class=lnt>1701
</span><span class=lnt>1702
</span><span class=lnt>1703
</span><span class=lnt>1704
</span><span class=lnt>1705
</span><span class=lnt>1706
</span><span class=lnt>1707
</span><span class=lnt>1708
</span><span class=lnt>1709
</span><span class=lnt>1710
</span><span class=lnt>1711
</span><span class=lnt>1712
</span><span class=lnt>1713
</span><span class=lnt>1714
</span><span class=lnt>1715
</span><span class=lnt>1716
</span><span class=lnt>1717
</span><span class=lnt>1718
</span><span class=lnt>1719
</span><span class=lnt>1720
</span><span class=lnt>1721
</span><span class=lnt>1722
</span><span class=lnt>1723
</span><span class=lnt>1724
</span><span class=lnt>1725
</span><span class=lnt>1726
</span><span class=lnt>1727
</span><span class=lnt>1728
</span><span class=lnt>1729
</span><span class=lnt>1730
</span><span class=lnt>1731
</span><span class=lnt>1732
</span><span class=lnt>1733
</span><span class=lnt>1734
</span><span class=lnt>1735
</span><span class=lnt>1736
</span><span class=lnt>1737
</span><span class=lnt>1738
</span><span class=lnt>1739
</span><span class=lnt>1740
</span><span class=lnt>1741
</span><span class=lnt>1742
</span><span class=lnt>1743
</span><span class=lnt>1744
</span><span class=lnt>1745
</span><span class=lnt>1746
</span><span class=lnt>1747
</span><span class=lnt>1748
</span><span class=lnt>1749
</span><span class=lnt>1750
</span><span class=lnt>1751
</span><span class=lnt>1752
</span><span class=lnt>1753
</span><span class=lnt>1754
</span><span class=lnt>1755
</span><span class=lnt>1756
</span><span class=lnt>1757
</span><span class=lnt>1758
</span><span class=lnt>1759
</span><span class=lnt>1760
</span><span class=lnt>1761
</span><span class=lnt>1762
</span><span class=lnt>1763
</span><span class=lnt>1764
</span><span class=lnt>1765
</span><span class=lnt>1766
</span><span class=lnt>1767
</span><span class=lnt>1768
</span><span class=lnt>1769
</span><span class=lnt>1770
</span><span class=lnt>1771
</span><span class=lnt>1772
</span><span class=lnt>1773
</span><span class=lnt>1774
</span><span class=lnt>1775
</span><span class=lnt>1776
</span><span class=lnt>1777
</span><span class=lnt>1778
</span><span class=lnt>1779
</span><span class=lnt>1780
</span><span class=lnt>1781
</span><span class=lnt>1782
</span><span class=lnt>1783
</span><span class=lnt>1784
</span><span class=lnt>1785
</span><span class=lnt>1786
</span><span class=lnt>1787
</span><span class=lnt>1788
</span><span class=lnt>1789
</span><span class=lnt>1790
</span><span class=lnt>1791
</span><span class=lnt>1792
</span><span class=lnt>1793
</span><span class=lnt>1794
</span><span class=lnt>1795
</span><span class=lnt>1796
</span><span class=lnt>1797
</span><span class=lnt>1798
</span><span class=lnt>1799
</span><span class=lnt>1800
</span><span class=lnt>1801
</span><span class=lnt>1802
</span><span class=lnt>1803
</span><span class=lnt>1804
</span><span class=lnt>1805
</span><span class=lnt>1806
</span><span class=lnt>1807
</span><span class=lnt>1808
</span><span class=lnt>1809
</span><span class=lnt>1810
</span><span class=lnt>1811
</span><span class=lnt>1812
</span><span class=lnt>1813
</span><span class=lnt>1814
</span><span class=lnt>1815
</span><span class=lnt>1816
</span><span class=lnt>1817
</span><span class=lnt>1818
</span><span class=lnt>1819
</span><span class=lnt>1820
</span><span class=lnt>1821
</span><span class=lnt>1822
</span><span class=lnt>1823
</span><span class=lnt>1824
</span><span class=lnt>1825
</span><span class=lnt>1826
</span><span class=lnt>1827
</span><span class=lnt>1828
</span><span class=lnt>1829
</span><span class=lnt>1830
</span><span class=lnt>1831
</span><span class=lnt>1832
</span><span class=lnt>1833
</span><span class=lnt>1834
</span><span class=lnt>1835
</span><span class=lnt>1836
</span><span class=lnt>1837
</span><span class=lnt>1838
</span><span class=lnt>1839
</span><span class=lnt>1840
</span><span class=lnt>1841
</span><span class=lnt>1842
</span><span class=lnt>1843
</span><span class=lnt>1844
</span><span class=lnt>1845
</span><span class=lnt>1846
</span><span class=lnt>1847
</span><span class=lnt>1848
</span><span class=lnt>1849
</span><span class=lnt>1850
</span><span class=lnt>1851
</span><span class=lnt>1852
</span><span class=lnt>1853
</span><span class=lnt>1854
</span><span class=lnt>1855
</span><span class=lnt>1856
</span><span class=lnt>1857
</span><span class=lnt>1858
</span><span class=lnt>1859
</span><span class=lnt>1860
</span><span class=lnt>1861
</span><span class=lnt>1862
</span><span class=lnt>1863
</span><span class=lnt>1864
</span><span class=lnt>1865
</span><span class=lnt>1866
</span><span class=lnt>1867
</span><span class=lnt>1868
</span><span class=lnt>1869
</span><span class=lnt>1870
</span><span class=lnt>1871
</span><span class=lnt>1872
</span><span class=lnt>1873
</span><span class=lnt>1874
</span><span class=lnt>1875
</span><span class=lnt>1876
</span><span class=lnt>1877
</span><span class=lnt>1878
</span><span class=lnt>1879
</span><span class=lnt>1880
</span><span class=lnt>1881
</span><span class=lnt>1882
</span><span class=lnt>1883
</span><span class=lnt>1884
</span><span class=lnt>1885
</span><span class=lnt>1886
</span><span class=lnt>1887
</span><span class=lnt>1888
</span><span class=lnt>1889
</span><span class=lnt>1890
</span><span class=lnt>1891
</span><span class=lnt>1892
</span><span class=lnt>1893
</span><span class=lnt>1894
</span><span class=lnt>1895
</span><span class=lnt>1896
</span><span class=lnt>1897
</span><span class=lnt>1898
</span><span class=lnt>1899
</span><span class=lnt>1900
</span><span class=lnt>1901
</span><span class=lnt>1902
</span><span class=lnt>1903
</span><span class=lnt>1904
</span><span class=lnt>1905
</span><span class=lnt>1906
</span><span class=lnt>1907
</span><span class=lnt>1908
</span><span class=lnt>1909
</span><span class=lnt>1910
</span><span class=lnt>1911
</span><span class=lnt>1912
</span><span class=lnt>1913
</span><span class=lnt>1914
</span><span class=lnt>1915
</span><span class=lnt>1916
</span><span class=lnt>1917
</span><span class=lnt>1918
</span><span class=lnt>1919
</span><span class=lnt>1920
</span><span class=lnt>1921
</span><span class=lnt>1922
</span><span class=lnt>1923
</span><span class=lnt>1924
</span><span class=lnt>1925
</span><span class=lnt>1926
</span><span class=lnt>1927
</span><span class=lnt>1928
</span><span class=lnt>1929
</span><span class=lnt>1930
</span><span class=lnt>1931
</span><span class=lnt>1932
</span><span class=lnt>1933
</span><span class=lnt>1934
</span><span class=lnt>1935
</span><span class=lnt>1936
</span><span class=lnt>1937
</span><span class=lnt>1938
</span><span class=lnt>1939
</span><span class=lnt>1940
</span><span class=lnt>1941
</span><span class=lnt>1942
</span><span class=lnt>1943
</span><span class=lnt>1944
</span><span class=lnt>1945
</span><span class=lnt>1946
</span><span class=lnt>1947
</span><span class=lnt>1948
</span><span class=lnt>1949
</span><span class=lnt>1950
</span><span class=lnt>1951
</span><span class=lnt>1952
</span><span class=lnt>1953
</span><span class=lnt>1954
</span><span class=lnt>1955
</span><span class=lnt>1956
</span><span class=lnt>1957
</span><span class=lnt>1958
</span><span class=lnt>1959
</span><span class=lnt>1960
</span><span class=lnt>1961
</span><span class=lnt>1962
</span><span class=lnt>1963
</span><span class=lnt>1964
</span><span class=lnt>1965
</span><span class=lnt>1966
</span><span class=lnt>1967
</span><span class=lnt>1968
</span><span class=lnt>1969
</span><span class=lnt>1970
</span><span class=lnt>1971
</span><span class=lnt>1972
</span><span class=lnt>1973
</span><span class=lnt>1974
</span><span class=lnt>1975
</span><span class=lnt>1976
</span><span class=lnt>1977
</span><span class=lnt>1978
</span><span class=lnt>1979
</span><span class=lnt>1980
</span><span class=lnt>1981
</span><span class=lnt>1982
</span><span class=lnt>1983
</span><span class=lnt>1984
</span><span class=lnt>1985
</span><span class=lnt>1986
</span><span class=lnt>1987
</span><span class=lnt>1988
</span><span class=lnt>1989
</span><span class=lnt>1990
</span><span class=lnt>1991
</span><span class=lnt>1992
</span><span class=lnt>1993
</span><span class=lnt>1994
</span><span class=lnt>1995
</span><span class=lnt>1996
</span><span class=lnt>1997
</span><span class=lnt>1998
</span><span class=lnt>1999
</span><span class=lnt>2000
</span><span class=lnt>2001
</span><span class=lnt>2002
</span><span class=lnt>2003
</span><span class=lnt>2004
</span><span class=lnt>2005
</span><span class=lnt>2006
</span><span class=lnt>2007
</span><span class=lnt>2008
</span><span class=lnt>2009
</span><span class=lnt>2010
</span><span class=lnt>2011
</span><span class=lnt>2012
</span><span class=lnt>2013
</span><span class=lnt>2014
</span><span class=lnt>2015
</span><span class=lnt>2016
</span><span class=lnt>2017
</span><span class=lnt>2018
</span><span class=lnt>2019
</span><span class=lnt>2020
</span><span class=lnt>2021
</span><span class=lnt>2022
</span><span class=lnt>2023
</span><span class=lnt>2024
</span><span class=lnt>2025
</span><span class=lnt>2026
</span><span class=lnt>2027
</span><span class=lnt>2028
</span><span class=lnt>2029
</span><span class=lnt>2030
</span><span class=lnt>2031
</span><span class=lnt>2032
</span><span class=lnt>2033
</span><span class=lnt>2034
</span><span class=lnt>2035
</span><span class=lnt>2036
</span><span class=lnt>2037
</span><span class=lnt>2038
</span><span class=lnt>2039
</span><span class=lnt>2040
</span><span class=lnt>2041
</span><span class=lnt>2042
</span><span class=lnt>2043
</span><span class=lnt>2044
</span><span class=lnt>2045
</span><span class=lnt>2046
</span><span class=lnt>2047
</span><span class=lnt>2048
</span><span class=lnt>2049
</span><span class=lnt>2050
</span><span class=lnt>2051
</span><span class=lnt>2052
</span><span class=lnt>2053
</span><span class=lnt>2054
</span><span class=lnt>2055
</span><span class=lnt>2056
</span><span class=lnt>2057
</span><span class=lnt>2058
</span><span class=lnt>2059
</span><span class=lnt>2060
</span><span class=lnt>2061
</span><span class=lnt>2062
</span><span class=lnt>2063
</span><span class=lnt>2064
</span><span class=lnt>2065
</span><span class=lnt>2066
</span><span class=lnt>2067
</span><span class=lnt>2068
</span><span class=lnt>2069
</span><span class=lnt>2070
</span><span class=lnt>2071
</span><span class=lnt>2072
</span><span class=lnt>2073
</span><span class=lnt>2074
</span><span class=lnt>2075
</span><span class=lnt>2076
</span><span class=lnt>2077
</span><span class=lnt>2078
</span><span class=lnt>2079
</span><span class=lnt>2080
</span><span class=lnt>2081
</span><span class=lnt>2082
</span><span class=lnt>2083
</span><span class=lnt>2084
</span><span class=lnt>2085
</span><span class=lnt>2086
</span><span class=lnt>2087
</span><span class=lnt>2088
</span><span class=lnt>2089
</span><span class=lnt>2090
</span><span class=lnt>2091
</span><span class=lnt>2092
</span><span class=lnt>2093
</span><span class=lnt>2094
</span><span class=lnt>2095
</span><span class=lnt>2096
</span><span class=lnt>2097
</span><span class=lnt>2098
</span><span class=lnt>2099
</span><span class=lnt>2100
</span><span class=lnt>2101
</span><span class=lnt>2102
</span><span class=lnt>2103
</span><span class=lnt>2104
</span><span class=lnt>2105
</span><span class=lnt>2106
</span><span class=lnt>2107
</span><span class=lnt>2108
</span><span class=lnt>2109
</span><span class=lnt>2110
</span><span class=lnt>2111
</span><span class=lnt>2112
</span><span class=lnt>2113
</span><span class=lnt>2114
</span><span class=lnt>2115
</span><span class=lnt>2116
</span><span class=lnt>2117
</span><span class=lnt>2118
</span><span class=lnt>2119
</span><span class=lnt>2120
</span><span class=lnt>2121
</span><span class=lnt>2122
</span><span class=lnt>2123
</span><span class=lnt>2124
</span><span class=lnt>2125
</span><span class=lnt>2126
</span><span class=lnt>2127
</span><span class=lnt>2128
</span><span class=lnt>2129
</span><span class=lnt>2130
</span><span class=lnt>2131
</span><span class=lnt>2132
</span><span class=lnt>2133
</span><span class=lnt>2134
</span><span class=lnt>2135
</span><span class=lnt>2136
</span><span class=lnt>2137
</span><span class=lnt>2138
</span><span class=lnt>2139
</span><span class=lnt>2140
</span><span class=lnt>2141
</span><span class=lnt>2142
</span><span class=lnt>2143
</span><span class=lnt>2144
</span><span class=lnt>2145
</span><span class=lnt>2146
</span><span class=lnt>2147
</span><span class=lnt>2148
</span><span class=lnt>2149
</span><span class=lnt>2150
</span><span class=lnt>2151
</span><span class=lnt>2152
</span><span class=lnt>2153
</span><span class=lnt>2154
</span><span class=lnt>2155
</span><span class=lnt>2156
</span><span class=lnt>2157
</span><span class=lnt>2158
</span><span class=lnt>2159
</span><span class=lnt>2160
</span><span class=lnt>2161
</span><span class=lnt>2162
</span><span class=lnt>2163
</span><span class=lnt>2164
</span><span class=lnt>2165
</span><span class=lnt>2166
</span><span class=lnt>2167
</span><span class=lnt>2168
</span><span class=lnt>2169
</span><span class=lnt>2170
</span><span class=lnt>2171
</span><span class=lnt>2172
</span><span class=lnt>2173
</span><span class=lnt>2174
</span><span class=lnt>2175
</span><span class=lnt>2176
</span><span class=lnt>2177
</span><span class=lnt>2178
</span><span class=lnt>2179
</span><span class=lnt>2180
</span><span class=lnt>2181
</span><span class=lnt>2182
</span><span class=lnt>2183
</span><span class=lnt>2184
</span><span class=lnt>2185
</span><span class=lnt>2186
</span><span class=lnt>2187
</span><span class=lnt>2188
</span><span class=lnt>2189
</span><span class=lnt>2190
</span><span class=lnt>2191
</span><span class=lnt>2192
</span><span class=lnt>2193
</span><span class=lnt>2194
</span><span class=lnt>2195
</span><span class=lnt>2196
</span><span class=lnt>2197
</span><span class=lnt>2198
</span><span class=lnt>2199
</span><span class=lnt>2200
</span><span class=lnt>2201
</span><span class=lnt>2202
</span><span class=lnt>2203
</span><span class=lnt>2204
</span><span class=lnt>2205
</span><span class=lnt>2206
</span><span class=lnt>2207
</span><span class=lnt>2208
</span><span class=lnt>2209
</span><span class=lnt>2210
</span><span class=lnt>2211
</span><span class=lnt>2212
</span><span class=lnt>2213
</span><span class=lnt>2214
</span><span class=lnt>2215
</span><span class=lnt>2216
</span><span class=lnt>2217
</span><span class=lnt>2218
</span><span class=lnt>2219
</span><span class=lnt>2220
</span><span class=lnt>2221
</span><span class=lnt>2222
</span><span class=lnt>2223
</span><span class=lnt>2224
</span><span class=lnt>2225
</span><span class=lnt>2226
</span><span class=lnt>2227
</span><span class=lnt>2228
</span><span class=lnt>2229
</span><span class=lnt>2230
</span><span class=lnt>2231
</span><span class=lnt>2232
</span><span class=lnt>2233
</span><span class=lnt>2234
</span><span class=lnt>2235
</span><span class=lnt>2236
</span><span class=lnt>2237
</span><span class=lnt>2238
</span><span class=lnt>2239
</span><span class=lnt>2240
</span><span class=lnt>2241
</span><span class=lnt>2242
</span><span class=lnt>2243
</span><span class=lnt>2244
</span><span class=lnt>2245
</span><span class=lnt>2246
</span><span class=lnt>2247
</span><span class=lnt>2248
</span><span class=lnt>2249
</span><span class=lnt>2250
</span><span class=lnt>2251
</span><span class=lnt>2252
</span><span class=lnt>2253
</span><span class=lnt>2254
</span><span class=lnt>2255
</span><span class=lnt>2256
</span><span class=lnt>2257
</span><span class=lnt>2258
</span><span class=lnt>2259
</span><span class=lnt>2260
</span><span class=lnt>2261
</span><span class=lnt>2262
</span><span class=lnt>2263
</span><span class=lnt>2264
</span><span class=lnt>2265
</span><span class=lnt>2266
</span><span class=lnt>2267
</span><span class=lnt>2268
</span><span class=lnt>2269
</span><span class=lnt>2270
</span><span class=lnt>2271
</span><span class=lnt>2272
</span><span class=lnt>2273
</span><span class=lnt>2274
</span><span class=lnt>2275
</span><span class=lnt>2276
</span><span class=lnt>2277
</span><span class=lnt>2278
</span><span class=lnt>2279
</span><span class=lnt>2280
</span><span class=lnt>2281
</span><span class=lnt>2282
</span><span class=lnt>2283
</span><span class=lnt>2284
</span><span class=lnt>2285
</span><span class=lnt>2286
</span><span class=lnt>2287
</span><span class=lnt>2288
</span><span class=lnt>2289
</span><span class=lnt>2290
</span><span class=lnt>2291
</span><span class=lnt>2292
</span><span class=lnt>2293
</span><span class=lnt>2294
</span><span class=lnt>2295
</span><span class=lnt>2296
</span><span class=lnt>2297
</span><span class=lnt>2298
</span><span class=lnt>2299
</span><span class=lnt>2300
</span><span class=lnt>2301
</span><span class=lnt>2302
</span><span class=lnt>2303
</span><span class=lnt>2304
</span><span class=lnt>2305
</span><span class=lnt>2306
</span><span class=lnt>2307
</span><span class=lnt>2308
</span><span class=lnt>2309
</span><span class=lnt>2310
</span><span class=lnt>2311
</span><span class=lnt>2312
</span><span class=lnt>2313
</span><span class=lnt>2314
</span><span class=lnt>2315
</span><span class=lnt>2316
</span><span class=lnt>2317
</span><span class=lnt>2318
</span><span class=lnt>2319
</span><span class=lnt>2320
</span><span class=lnt>2321
</span><span class=lnt>2322
</span><span class=lnt>2323
</span><span class=lnt>2324
</span><span class=lnt>2325
</span><span class=lnt>2326
</span><span class=lnt>2327
</span><span class=lnt>2328
</span><span class=lnt>2329
</span><span class=lnt>2330
</span><span class=lnt>2331
</span><span class=lnt>2332
</span><span class=lnt>2333
</span><span class=lnt>2334
</span><span class=lnt>2335
</span><span class=lnt>2336
</span><span class=lnt>2337
</span><span class=lnt>2338
</span><span class=lnt>2339
</span><span class=lnt>2340
</span><span class=lnt>2341
</span><span class=lnt>2342
</span><span class=lnt>2343
</span><span class=lnt>2344
</span><span class=lnt>2345
</span><span class=lnt>2346
</span><span class=lnt>2347
</span><span class=lnt>2348
</span><span class=lnt>2349
</span><span class=lnt>2350
</span><span class=lnt>2351
</span><span class=lnt>2352
</span><span class=lnt>2353
</span><span class=lnt>2354
</span><span class=lnt>2355
</span><span class=lnt>2356
</span><span class=lnt>2357
</span><span class=lnt>2358
</span><span class=lnt>2359
</span><span class=lnt>2360
</span><span class=lnt>2361
</span><span class=lnt>2362
</span><span class=lnt>2363
</span><span class=lnt>2364
</span><span class=lnt>2365
</span><span class=lnt>2366
</span><span class=lnt>2367
</span><span class=lnt>2368
</span><span class=lnt>2369
</span><span class=lnt>2370
</span><span class=lnt>2371
</span><span class=lnt>2372
</span><span class=lnt>2373
</span><span class=lnt>2374
</span><span class=lnt>2375
</span><span class=lnt>2376
</span><span class=lnt>2377
</span><span class=lnt>2378
</span><span class=lnt>2379
</span><span class=lnt>2380
</span><span class=lnt>2381
</span><span class=lnt>2382
</span><span class=lnt>2383
</span><span class=lnt>2384
</span><span class=lnt>2385
</span><span class=lnt>2386
</span><span class=lnt>2387
</span><span class=lnt>2388
</span><span class=lnt>2389
</span><span class=lnt>2390
</span><span class=lnt>2391
</span><span class=lnt>2392
</span><span class=lnt>2393
</span><span class=lnt>2394
</span><span class=lnt>2395
</span><span class=lnt>2396
</span><span class=lnt>2397
</span><span class=lnt>2398
</span><span class=lnt>2399
</span><span class=lnt>2400
</span><span class=lnt>2401
</span><span class=lnt>2402
</span><span class=lnt>2403
</span><span class=lnt>2404
</span><span class=lnt>2405
</span><span class=lnt>2406
</span><span class=lnt>2407
</span><span class=lnt>2408
</span><span class=lnt>2409
</span><span class=lnt>2410
</span><span class=lnt>2411
</span><span class=lnt>2412
</span><span class=lnt>2413
</span><span class=lnt>2414
</span><span class=lnt>2415
</span><span class=lnt>2416
</span><span class=lnt>2417
</span><span class=lnt>2418
</span><span class=lnt>2419
</span><span class=lnt>2420
</span><span class=lnt>2421
</span><span class=lnt>2422
</span><span class=lnt>2423
</span><span class=lnt>2424
</span><span class=lnt>2425
</span><span class=lnt>2426
</span><span class=lnt>2427
</span><span class=lnt>2428
</span><span class=lnt>2429
</span><span class=lnt>2430
</span><span class=lnt>2431
</span><span class=lnt>2432
</span><span class=lnt>2433
</span><span class=lnt>2434
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createApp</span> <span class=o>=</span> <span class=p>((...</span><span class=nx>args</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * patchProp 更新 props 方法集合
</span></span></span><span class=line><span class=cl><span class=cm>   * forcePatchProp = (_, key) =&gt; key === &#39;value&#39;
</span></span></span><span class=line><span class=cl><span class=cm>   * nodeOps DOM 操作方法集合
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>rendererOptions</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({</span> <span class=nx>patchProp</span><span class=p>,</span> <span class=nx>forcePatchProp</span> <span class=p>},</span> <span class=nx>nodeOps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>render</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>baseCreateRenderer</span><span class=p>(</span><span class=nx>rendererOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>createApp</span> <span class=o>=</span> <span class=nx>createAppAPI</span><span class=p>(</span><span class=nx>render</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(...</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>mount</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 根组件挂载节点，ShadowRoot 接口是一个 DOM 子树的根节点，它与文档的主 DOM 树分开渲染
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>app</span><span class=p>.</span><span class=nx>mount</span> <span class=o>=</span> <span class=p>(</span><span class=nx>containerOrSelector</span>: <span class=kt>Element</span> <span class=o>|</span> <span class=nx>ShadowRoot</span> <span class=o>|</span> <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span> <span class=nx>normalizeContainer</span><span class=p>(</span><span class=nx>containerOrSelector</span><span class=p>);</span> <span class=c1>// HTMLElement || null
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>container</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>component</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=nx>_component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>component</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>component</span><span class=p>.</span><span class=nx>render</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>component</span><span class=p>.</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=p>.</span><span class=nx>template</span> <span class=o>=</span> <span class=nx>container</span><span class=p>.</span><span class=nx>innerHTML</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 挂载之前清空 container
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>container</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>proxy</span> <span class=o>=</span> <span class=nx>mount</span><span class=p>(</span><span class=nx>container</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>container</span> <span class=k>instanceof</span> <span class=nx>Element</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>container</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=s1>&#39;v-cloak&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>container</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;data-v-app&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>proxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=kr>as</span> <span class=nx>CreateAppFunction</span><span class=p>&lt;</span><span class=nt>Element</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createAppAPI</span><span class=p>&lt;</span><span class=nt>HostElement</span><span class=p>&gt;(</span>
</span></span><span class=line><span class=cl>  <span class=nx>render</span>: <span class=kt>RootRenderFunction</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>CreateAppFunction</span><span class=p>&lt;</span><span class=nt>HostElement</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>rootComponent</span><span class=p>,</span> <span class=nx>rootProps</span> <span class=o>=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>rootProps</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>rootProps</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>rootProps</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>context</span> <span class=o>=</span> <span class=nx>createAppContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>installedPlugins</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>app</span>: <span class=kt>App</span> <span class=o>=</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>app</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>_uid</span>: <span class=kt>uid</span><span class=o>++</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>_component</span>: <span class=kt>rootComponent</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>_props</span>: <span class=kt>rootProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>_container</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>_context</span>: <span class=kt>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kr>get</span> <span class=nx>config() {</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nx>config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=kr>set</span> <span class=nx>config</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;app.config 不能被覆盖&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>use</span><span class=p>(</span><span class=nx>plugin</span>: <span class=kt>Plugin</span><span class=p>,</span> <span class=p>...</span><span class=nx>options</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>plugin</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=sb>`插件已安装`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>plugin</span> <span class=o>&amp;&amp;</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>plugin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=p>...</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>plugin</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>plugin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>plugin</span><span class=p>(</span><span class=nx>app</span><span class=p>,</span> <span class=p>...</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;插件应该是一个函数或者一个有 install 方法的对象&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>mixin</span><span class=p>(</span><span class=nx>mixin</span>: <span class=kt>ComponentOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>context</span><span class=p>.</span><span class=nx>mixins</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>mixin</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>context</span><span class=p>.</span><span class=nx>mixins</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>mixin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>mixin</span><span class=p>.</span><span class=nx>props</span> <span class=o>||</span> <span class=nx>mixin</span><span class=p>.</span><span class=nx>emits</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>context</span><span class=p>.</span><span class=nx>deopt</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;mixin 过了&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>component?</span>: <span class=kt>Component</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;组件已经注册过了&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>directive</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>directive?</span>: <span class=kt>Directive</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>directive</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nx>directives</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>directives</span><span class=p>[</span><span class=nx>name</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;指令已经注册过了&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>.</span><span class=nx>directives</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>directive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>mount</span><span class=p>(</span><span class=nx>rootContainer</span>: <span class=kt>HostElement</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createVNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>rootComponent</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>rootProps</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 在根节点上存储 app context，在第一次渲染的，会被设为根实例
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>vnode</span><span class=p>.</span><span class=nx>appContext</span> <span class=o>=</span> <span class=nx>context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 将 VNode 借助 patch 渲染到 container
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>render</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>rootContainer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>app</span><span class=p>.</span><span class=nx>_container</span> <span class=o>=</span> <span class=nx>rootContainer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>.</span><span class=nx>proxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>unmount() {</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 直接渲染 null
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>render</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>app</span><span class=p>.</span><span class=nx>_container</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=sb>`没有挂载过，怎么卸载？`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>key</span> <span class=kr>as</span> <span class=kt>string</span> <span class=o>|</span> <span class=kt>symbol</span><span class=p>)</span> <span class=k>in</span> <span class=nx>context</span><span class=p>.</span><span class=nx>provides</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;App 已经 provides 这个属性了，小心被覆盖&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>.</span><span class=nx>provides</span><span class=p>[</span><span class=nx>key</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>]</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>app</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createRenderer</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>HostNode</span> <span class=o>=</span> <span class=nx>RendererNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HostElement</span> <span class=o>=</span> <span class=nx>RendererElement</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span><span class=p>(</span><span class=nx>options</span>: <span class=kt>RendererOptions</span><span class=p>&lt;</span><span class=nt>HostNode</span><span class=err>,</span> <span class=na>HostElement</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>baseCreateRenderer</span><span class=p>&lt;</span><span class=nt>HostNode</span><span class=err>,</span> <span class=na>HostElement</span><span class=p>&gt;(</span><span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>baseCreateRenderer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span>: <span class=kt>RendererOptions</span><span class=p>,</span> <span class=c1>// 操作原生元素的方法，浏览器平台为 DOM 操作方法
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>createHydrationFns?</span>: <span class=kt>typeof</span> <span class=nx>createHydrationFunctions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>insert</span>: <span class=kt>hostInsert</span><span class=p>,</span> <span class=c1>// parent.insertBefore(el, anchor)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>remove</span>: <span class=kt>hostRemove</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>patchProp</span>: <span class=kt>hostPatchProp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>forcePatchProp</span>: <span class=kt>hostForcePatchProp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>createElement</span>: <span class=kt>hostCreateElement</span><span class=p>,</span> <span class=c1>// document.createElement(vnode.type)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>createText</span>: <span class=kt>hostCreateText</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>createComment</span>: <span class=kt>hostCreateComment</span><span class=p>,</span> <span class=c1>// document.createComment(data)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>setText</span>: <span class=kt>hostSetText</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>setElementText</span>: <span class=kt>hostSetElementText</span><span class=p>,</span> <span class=c1>// el.textContent = text
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>parentNode</span>: <span class=kt>hostParentNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextSibling</span>: <span class=kt>hostNextSibling</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>setScopeId</span>: <span class=kt>hostSetScopeId</span> <span class=o>=</span> <span class=nx>NOOP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cloneNode</span>: <span class=kt>hostCloneNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>insertStaticContent</span>: <span class=kt>hostInsertStaticContent</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 是否是相同节点（可以复用）：type &amp; key 都相同
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果 n1 存在，并且 n1 n2 不能复用，卸载 n1
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果 n2 的 patchFlag 为 BAIL 忽略所有优化手段（dynamicChildren）
</span></span></span><span class=line><span class=cl><span class=cm>   * 根据 n2 的 type 的值，对 n2 类型做判断，分别做处理：
</span></span></span><span class=line><span class=cl><span class=cm>   *   文字       processText
</span></span></span><span class=line><span class=cl><span class=cm>   *   注释       processCommentNode
</span></span></span><span class=line><span class=cl><span class=cm>   *   静态       mountStaticNode
</span></span></span><span class=line><span class=cl><span class=cm>   *   FRAGMENT   processFragment
</span></span></span><span class=line><span class=cl><span class=cm>   *   ELEMENT    processElement: n1 === null ? mountElement : patchElement
</span></span></span><span class=line><span class=cl><span class=cm>   *                 mountElement 会调用原生方法挂载 n2，如果 n2.children 存在，会调用 mountChildren 将 n2.children 挂载到 n2.el 下
</span></span></span><span class=line><span class=cl><span class=cm>   *                 patchElement 会根据 n2.patchFlag 调用 patchProps、patchBlockChildren、patchChildren 处理 n1 和 n2 及其子节点，并调用生命周期函数
</span></span></span><span class=line><span class=cl><span class=cm>   *                    如果 n2 是一个 Block，自身存在 dynamicChildren，调用 patchBlockChildren 处理动态子节点
</span></span></span><span class=line><span class=cl><span class=cm>   *                        dynamicChildren 的结构是稳定的，只需要遍历 newChildren，调用 patch(old, new) 即可
</span></span></span><span class=line><span class=cl><span class=cm>   *                    如果 n2 不是一个 Block，调用 patchChildren 处理子节点
</span></span></span><span class=line><span class=cl><span class=cm>   *                        如果 n2.patchFlag&amp;KEYED_FRAGMENT，patchChildren 调用 patchKeyedChildren
</span></span></span><span class=line><span class=cl><span class=cm>   *                            这种情况，说明存在可以被复用的节点
</span></span></span><span class=line><span class=cl><span class=cm>   *                            从前向后遍历 i&lt;=e1&amp;&amp;i&lt;=e2，如果 c1[i] 和 c2[i] 可复用，调用 patch；否则，停止遍历；i++
</span></span></span><span class=line><span class=cl><span class=cm>   *                            从后向前遍历 i&lt;=e1&amp;&amp;i&lt;=e2，如果 c1[e1] 和 c2[e2] 可复用，调用 patch；否则，停止遍历；e1++ e2++
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 i&gt;e1，oldChildren 没有剩余
</span></span></span><span class=line><span class=cl><span class=cm>   *                                如果 i&lt;=e2，newChildren 有剩余，调用 patch，挂载 c2[i]
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 i&gt;e2，newChildren 没有剩余
</span></span></span><span class=line><span class=cl><span class=cm>   *                                如果 i&lt;=e1，oldChildren 有剩余，调用 unmount，卸载 c1[i]
</span></span></span><span class=line><span class=cl><span class=cm>   *                            此时 oldChildren/newChildren 均有剩余
</span></span></span><span class=line><span class=cl><span class=cm>   *                                从 s2 开始 e2 结束，遍历 newChildren，将 [c2[i].key,i] 保存在 keyToNewIndexMap（即 c2.key 到相对位置索引 i 的映射）
</span></span></span><span class=line><span class=cl><span class=cm>   *                                初始化变量 patched（将要被 patch 的新节点数量）为 0
</span></span></span><span class=line><span class=cl><span class=cm>   *                                初始化变量 toBePatched（剩下的需要被 patch 的新节点数量）为 e2-s2+1
</span></span></span><span class=line><span class=cl><span class=cm>   *                                初始化一个长度为 toBePatched 的数组 newIndexToOldIndexMap，每项均为 0，用来保存每个 c2 在 oldChildren 中的位置（未更新前的位置）
</span></span></span><span class=line><span class=cl><span class=cm>   *                                从 s1 开始 e1 结束，遍历剩余的 oldChildren
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    如果 patched&gt;toBePatched，说明 newChildren 的每项都被 patch 完了，调用 unmount 卸载 c1[i] 即可
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    如果 c1[i].key 存在，在 keyToNewIndexMap 中查找 c1[i] 在 newChildren 中的新的绝对位置 newIndex
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    否则，从 s2 开始 e2 结束，遍历 newChildren，如果 c2[j] 在 oldChildren 中不存在，newIndex=j
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    如果 newIndex 不存在，说明，c1[i] 在 newChildren 中不存在，需要被卸载掉
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    如果 newIndex 存在，说明 c1[i] 可以被复用，他的新的绝对位置是 newIndex，只是需要被移动
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        更新 newIndexToOldIndexMap[newIndex-s2]=i+1，处于 newIndex-s2 位置的可复用节点 c2 在 oldChildren 中的位置是 i+1
</span></span></span><span class=line><span class=cl><span class=cm>   *                                            newIndexToOldIndexMap 的下标都是相对位置，所以是 newIndex-s2
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        如果 newIndex 小于“遍历 oldChildren 过程中遇到的最大的 newIndex 值”maxNewIndexSoFar，说明当前节点不需要移动
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        对 c1[i] 和 c2[newIndex] 调用 patch，patched++
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    找出 newIndexToOldIndexMap 中“最长递增子序列”的下标，放到 increasingNewIndexSequence 数组里
</span></span></span><span class=line><span class=cl><span class=cm>   *                                    从后向前（toBePatched-1 到 0）遍历剩余的 newChildren
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        如果他在 newIndexToOldIndexMap 中的值为 0，说明这个节点在 oldChildren 中是没有的，需要新增
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        否则，节点需要被移动，调用 move 移动节点，锚点为 c2[nextIndex + 1]
</span></span></span><span class=line><span class=cl><span class=cm>   *                                        从后向前遍历，就是为了方便找移动的锚点
</span></span></span><span class=line><span class=cl><span class=cm>   *                        如果 n2.patchFlag&amp;UNKEYED_FRAGMENT，patchChildren 调用 patchUnkeyedChildren
</span></span></span><span class=line><span class=cl><span class=cm>   *                            遍历 commonLength，对 c1[i] 和 c2[i] 调用 patch
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 oldLength &gt; newLength，调用 unmountChildren 卸载 commonLength 之后的所有剩下的 c1
</span></span></span><span class=line><span class=cl><span class=cm>   *                            否则，调用 mountChildren 挂载 commonLength 之后的所有剩下的 c2
</span></span></span><span class=line><span class=cl><span class=cm>   *                        如果 n2.shapeFlag&amp;TEXT_CHILDREN
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 n1.shapeFlag&amp;ARRAY_CHILDREN，调用 unmountChildren 卸载 c1
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 c1 !== c2，将 c2 更新到页面上去
</span></span></span><span class=line><span class=cl><span class=cm>   *                        如果 n1.shapeFlag&amp;ARRAY_CHILDREN
</span></span></span><span class=line><span class=cl><span class=cm>   *                            如果 n2.shapeFlag&amp;ARRAY_CHILDREN，调用 patchKeyedChildren
</span></span></span><span class=line><span class=cl><span class=cm>   *                            否则，卸载 c1
</span></span></span><span class=line><span class=cl><span class=cm>   *                        如果 n1.shapeFlag&amp;TEXT_CHILDREN，从页面上删除 c1
</span></span></span><span class=line><span class=cl><span class=cm>   *                        否则，调用 mountChildren，挂载 c2 即可
</span></span></span><span class=line><span class=cl><span class=cm>   *   COMPONENT  processComponent
</span></span></span><span class=line><span class=cl><span class=cm>   *   TELEPORT   type.process，使用 vnode 自带的 process 方法
</span></span></span><span class=line><span class=cl><span class=cm>   *   SUSPENSE   type.process，使用 vnode 自带的 process 方法
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>patch</span>: <span class=kt>PatchFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span><span class=p>,</span> <span class=c1>// 旧 vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>n2</span><span class=p>,</span> <span class=c1>// 新 vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>container</span><span class=p>,</span> <span class=c1>// 挂载容器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>anchor</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span> <span class=c1>// 挂载锚点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>parentComponent</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span> <span class=o>=</span> <span class=nx>isHmrUpdating</span> <span class=o>?</span> <span class=kc>false</span> <span class=o>:</span> <span class=o>!!</span><span class=nx>n2</span><span class=p>.</span><span class=nx>dynamicChildren</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * isSameVNodeType 逻辑：
</span></span></span><span class=line><span class=cl><span class=cm>     * n1.type === n2.type &amp;&amp; n1.key === n2.key
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isSameVNodeType</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果 n1 存在，并且 n1 n2 不是相同节点，卸载 n1
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>anchor</span> <span class=o>=</span> <span class=nx>getNextHostNode</span><span class=p>(</span><span class=nx>n1</span><span class=p>);</span> <span class=c1>// 设置锚点为 n1 的宿主节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>unmount</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>n1</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span> <span class=c1>// 保证后续挂载操作的正常执行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>patchFlag</span> <span class=o>===</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>BAIL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果 patchFlag 为 BAIL，忽略所有优化手段，清空 dynamicChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>n2</span><span class=p>.</span><span class=nx>dynamicChildren</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>optimized</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>shapeFlag</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 判断新 vnode 的类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=p>(</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>Text</span><span class=o>:</span> <span class=c1>// 文字节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>processText</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>Comment</span><span class=o>:</span> <span class=c1>// 注释节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>processCommentNode</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>Static</span><span class=o>:</span> <span class=c1>// 静态节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>mountStaticNode</span><span class=p>(</span><span class=nx>n2</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>isSVG</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>Fragment</span><span class=o>:</span> <span class=c1>// 代码片段
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>processFragment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ELEMENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 n2 是 ELEMENT
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>processElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 n2 是 COMPONENT/COMPONENT_KEPT_ALIVE
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>processComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TELEPORT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果 n2 是 TELEPORT，调用 Teleport 组件中的 process 方法
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果 n1 不存在，就将 n2.children 挂载到 n2.props.to 节点下
</span></span></span><span class=line><span class=cl><span class=cm>           * n2 本身是一个虚拟节点，包含了一段代码片段
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果 n1 存在，调用 patchChildren(n1, n2, container)
</span></span></span><span class=line><span class=cl><span class=cm>           * 还需要处理 n1.props.to !== n2.props.to 这种情况
</span></span></span><span class=line><span class=cl><span class=cm>           * 需要调用 move 进行节点移动操作
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=kr>type</span> <span class=kr>as</span> <span class=k>typeof</span> <span class=nx>TeleportImpl</span><span class=p>).</span><span class=nx>process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>n1</span> <span class=kr>as</span> <span class=nx>TeleportVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>n2</span> <span class=kr>as</span> <span class=nx>TeleportVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>internals</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 n2 是 SUSPENSE，调用 Suspense 组件中的 process 方法
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>(</span><span class=kr>type</span> <span class=kr>as</span> <span class=k>typeof</span> <span class=nx>SuspenseImpl</span><span class=p>).</span><span class=nx>process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>internals</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>ref</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=nx>parentComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setRef</span><span class=p>(</span><span class=nx>ref</span><span class=p>,</span> <span class=nx>n1</span> <span class=o>&amp;&amp;</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>ref</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=nx>n2</span> <span class=o>||</span> <span class=nx>n1</span><span class=p>,</span> <span class=o>!</span><span class=nx>n2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>processText</span>: <span class=kt>ProcessTextOrCommentFn</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>hostCreateText</span><span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>el</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>el</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=o>!==</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>children</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>hostSetText</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>processCommentNode</span>: <span class=kt>ProcessTextOrCommentFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>hostCreateComment</span><span class=p>((</span><span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>)</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mountStaticNode</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span><span class=p>,</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>anchor</span><span class=p>]</span> <span class=o>=</span> <span class=nx>hostInsertStaticContent</span><span class=o>!</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>moveStaticNode</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>anchor</span> <span class=p>}</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextSibling</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>el</span> <span class=o>!==</span> <span class=nx>anchor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>next</span> <span class=o>=</span> <span class=nx>hostNextSibling</span><span class=p>(</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>nextSibling</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>el</span> <span class=o>=</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>anchor</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>nextSibling</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>removeStaticNode</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>anchor</span> <span class=p>}</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>el</span> <span class=o>!==</span> <span class=nx>anchor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>next</span> <span class=o>=</span> <span class=nx>hostNextSibling</span><span class=p>(</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostRemove</span><span class=p>(</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>el</span> <span class=o>=</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>hostRemove</span><span class=p>(</span><span class=nx>anchor</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>processElement</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span>: <span class=kt>VNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span> <span class=o>=</span> <span class=nx>isSVG</span> <span class=o>||</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;svg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果旧的 vnode 不存在，直接挂载 n2 即可
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>mountElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对 n1 n2 进行 patch 操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patchElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mountElement</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>el</span>: <span class=kt>RendererElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>vnodeHook</span>: <span class=kt>VNodeHook</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=o>|</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>props</span><span class=p>,</span> <span class=nx>shapeFlag</span><span class=p>,</span> <span class=nx>transition</span><span class=p>,</span> <span class=nx>patchFlag</span><span class=p>,</span> <span class=nx>dirs</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostCloneNode</span> <span class=o>!==</span> <span class=kc>undefined</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchFlag</span> <span class=o>===</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>HOISTED</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 静态提升节点，如果 vnode.el 存在，复用 DOM
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>el</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>hostCloneNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 创建 DOM
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>el</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>hostCreateElement</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=k>is</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>props</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TEXT_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 vnode.children 为文本节点，设置 textContent
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hostSetElementText</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 vnode.children 为数组，调用 mountChildren 处理子节点数组
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>mountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>el</span><span class=p>,</span> <span class=c1>// 将子节点都挂载到 el 下
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span> <span class=o>&amp;&amp;</span> <span class=kr>type</span> <span class=o>!==</span> <span class=s1>&#39;foreignObject&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>dirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;created&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 处理 vnode.props
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isReservedProp</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>             * 调用 node.setAttribute 等 API 处理 HTMLAttr/DOMProp
</span></span></span><span class=line><span class=cl><span class=cm>             * HTMLAttr 的值，在一些情况下会作为 DOMProp 初始值
</span></span></span><span class=line><span class=cl><span class=cm>             * 内部会调用 shouldSetAsProp 处理特殊情况
</span></span></span><span class=line><span class=cl><span class=cm>             * 如果 shouldSetAsProp 返回 true，作为 DOMProp 处理
</span></span></span><span class=line><span class=cl><span class=cm>             * 如果 key 的属性值应该为 boolean，那么 prop[key] 如果为 &#39;&#39;，按照 true 处理
</span></span></span><span class=line><span class=cl><span class=cm>             * 其他均作为 HTMLAttr 处理
</span></span></span><span class=line><span class=cl><span class=cm>             * class 可以通过 className、classList、setAttribute 三种方式设置（性能依次递减）
</span></span></span><span class=line><span class=cl><span class=cm>             */</span>
</span></span><span class=line><span class=cl>            <span class=nx>hostPatchProp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>props</span><span class=p>[</span><span class=nx>key</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>unmountChildren</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeBeforeMount</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>setScopeId</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>scopeId</span><span class=p>,</span> <span class=nx>slotScopeIds</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>dirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;beforeMount&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>needCallTransitionHooks</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=o>!</span><span class=nx>parentSuspense</span> <span class=o>||</span> <span class=p>(</span><span class=nx>parentSuspense</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>pendingBranch</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>transition</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>transition</span><span class=p>.</span><span class=nx>persisted</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>needCallTransitionHooks</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>transition</span><span class=o>!</span><span class=p>.</span><span class=nx>beforeEnter</span><span class=p>(</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 挂载 el
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeMounted</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>needCallTransitionHooks</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>dirs</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnodeHook</span> <span class=o>&amp;&amp;</span> <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>needCallTransitionHooks</span> <span class=o>&amp;&amp;</span> <span class=nx>transition</span><span class=o>!</span><span class=p>.</span><span class=nx>enter</span><span class=p>(</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>dirs</span> <span class=o>&amp;&amp;</span> <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;mounted&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setScopeId</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>scopeId</span>: <span class=kt>string</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>scopeId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostSetScopeId</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>scopeId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slotScopeIds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>slotScopeIds</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>hostSetScopeId</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>slotScopeIds</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>parentComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>subTree</span> <span class=o>=</span> <span class=nx>parentComponent</span><span class=p>.</span><span class=nx>subTree</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span> <span class=o>===</span> <span class=nx>subTree</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>parentVNode</span> <span class=o>=</span> <span class=nx>parentComponent</span><span class=p>.</span><span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>setScopeId</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentVNode</span><span class=p>.</span><span class=nx>scopeId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentVNode</span><span class=p>.</span><span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>.</span><span class=nx>parent</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mountChildren</span>: <span class=kt>MountChildrenFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>start</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历 children 数组，调用 patch 进行挂载
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>start</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=p>(</span><span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>      <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span> <span class=c1>// 此时，旧的 child 不存在
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>child</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>patchElement</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>el</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>el</span><span class=o>!</span><span class=p>);</span> <span class=c1>// DOM 复用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=p>{</span> <span class=nx>patchFlag</span><span class=p>,</span> <span class=nx>dynamicChildren</span><span class=p>,</span> <span class=nx>dirs</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>patchFlag</span> <span class=o>|=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>FULL_PROPS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>oldProps</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>props</span> <span class=o>||</span> <span class=nx>EMPTY_OBJ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newProps</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>props</span> <span class=o>||</span> <span class=nx>EMPTY_OBJ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>vnodeHook</span>: <span class=kt>VNodeHook</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=o>|</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>newProps</span><span class=p>.</span><span class=nx>onVnodeBeforeUpdate</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>n1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>dirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>n2</span><span class=p>,</span> <span class=nx>n1</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>FULL_PROPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 动态 props
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchProps</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>newProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>CLASS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 动态 class
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=nx>oldProps</span><span class=p>.</span><span class=kr>class</span> <span class=o>!==</span> <span class=nx>newProps</span><span class=p>.</span><span class=kr>class</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>hostPatchProp</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=s1>&#39;class&#39;</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>newProps</span><span class=p>.</span><span class=kr>class</span><span class=p>,</span> <span class=nx>isSVG</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>STYLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 动态 style
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>hostPatchProp</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=s1>&#39;style&#39;</span><span class=p>,</span> <span class=nx>oldProps</span><span class=p>.</span><span class=nx>style</span><span class=p>,</span> <span class=nx>newProps</span><span class=p>.</span><span class=nx>style</span><span class=p>,</span> <span class=nx>isSVG</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>PROPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// props 的值动态
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>propsToUpdate</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>dynamicProps</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>propsToUpdate</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span> <span class=nx>propsToUpdate</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>prev</span> <span class=o>=</span> <span class=nx>oldProps</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=nx>newProps</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>next</span> <span class=o>!==</span> <span class=nx>prev</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>hostForcePatchProp</span> <span class=o>&amp;&amp;</span> <span class=nx>hostForcePatchProp</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>hostPatchProp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>next</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>n1</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>unmountChildren</span>
</span></span><span class=line><span class=cl>              <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>TEXT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 动态 textContent
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span><span class=p>.</span><span class=nx>children</span> <span class=o>!==</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>hostSetElementText</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>optimized</span> <span class=o>&amp;&amp;</span> <span class=nx>dynamicChildren</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchProps</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>areChildrenSVG</span> <span class=o>=</span> <span class=nx>isSVG</span> <span class=o>&amp;&amp;</span> <span class=nx>n2</span><span class=p>.</span><span class=kr>type</span> <span class=o>!==</span> <span class=s1>&#39;foreignObject&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>dynamicChildren</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 直接处理 dynamicChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patchBlockChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>n1</span><span class=p>.</span><span class=nx>dynamicChildren</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>dynamicChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>areChildrenSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>optimized</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>areChildrenSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>newProps</span><span class=p>.</span><span class=nx>onVnodeUpdated</span><span class=p>)</span> <span class=o>||</span> <span class=nx>dirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnodeHook</span> <span class=o>&amp;&amp;</span> <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>n1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>dirs</span> <span class=o>&amp;&amp;</span> <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>n2</span><span class=p>,</span> <span class=nx>n1</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;updated&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 相比于 patchChildren 的优化，只会更新动态节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>patchBlockChildren</span>: <span class=kt>PatchBlockChildrenFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>oldChildren</span><span class=p>,</span> <span class=c1>// n1.dynamicChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>newChildren</span><span class=p>,</span> <span class=c1>// n2.dynamicChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fallbackContainer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 只会对 dynamicChildren 进行遍历 patch，跳过了所有静态节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>oldVNode</span> <span class=o>=</span> <span class=nx>oldChildren</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>newVNode</span> <span class=o>=</span> <span class=nx>newChildren</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>container</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldVNode</span><span class=p>.</span><span class=nx>el</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>oldVNode</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Fragment</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=o>!</span><span class=nx>isSameVNodeType</span><span class=p>(</span><span class=nx>oldVNode</span><span class=p>,</span> <span class=nx>newVNode</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TELEPORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>hostParentNode</span><span class=p>(</span><span class=nx>oldVNode</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span><span class=o>!</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=nx>fallbackContainer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>newVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 调用 hostPatchProp 处理节点 props
</span></span></span><span class=line><span class=cl><span class=cm>   * 比如事件监听 addEventListener
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要对事件冒泡做特殊处理（performance.now）
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>patchProps</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>oldProps</span>: <span class=kt>Data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>newProps</span>: <span class=kt>Data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldProps</span> <span class=o>!==</span> <span class=nx>newProps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 遍历新的 props
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>newProps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isReservedProp</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=nx>newProps</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span> <span class=c1>// key 对应的新 props 值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>prev</span> <span class=o>=</span> <span class=nx>oldProps</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span> <span class=c1>// key 对应的旧 props 值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>next</span> <span class=o>!==</span> <span class=nx>prev</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>hostForcePatchProp</span> <span class=o>&amp;&amp;</span> <span class=nx>hostForcePatchProp</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>hostPatchProp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>prev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>next</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>unmountChildren</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 遍历旧的，仅对不在新 props 里的属性作处理
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>oldProps</span> <span class=o>!==</span> <span class=nx>EMPTY_OBJ</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>oldProps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isReservedProp</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>newProps</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>hostPatchProp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>el</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>oldProps</span><span class=p>[</span><span class=nx>key</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>unmountChildren</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>processFragment</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span>: <span class=kt>VNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fragmentStartAnchor</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>n1</span> <span class=o>?</span> <span class=nx>n1.el</span> : <span class=kt>hostCreateText</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>))</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fragmentEndAnchor</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>anchor</span> <span class=o>=</span> <span class=nx>n1</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>n1.anchor</span>
</span></span><span class=line><span class=cl>      : <span class=kt>hostCreateText</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>))</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=p>{</span> <span class=nx>patchFlag</span><span class=p>,</span> <span class=nx>dynamicChildren</span><span class=p>,</span> <span class=nx>slotScopeIds</span>: <span class=kt>fragmentSlotScopeIds</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>dynamicChildren</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>optimized</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>fragmentSlotScopeIds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>slotScopeIds</span> <span class=o>=</span> <span class=nx>slotScopeIds</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>slotScopeIds</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=nx>fragmentSlotScopeIds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>fragmentSlotScopeIds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 旧的 vnode 不存在，挂载 n2.children 即可
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>fragmentStartAnchor</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>fragmentEndAnchor</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>mountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>fragmentEndAnchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对 n1.children 和 n2.children 进行 patch
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchFlag</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>STABLE_FRAGMENT</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>dynamicChildren</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>n1</span><span class=p>.</span><span class=nx>dynamicChildren</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// children 不变的 Frangment
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchBlockChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n1</span><span class=p>.</span><span class=nx>dynamicChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>dynamicChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>.</span><span class=nx>key</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>parentComponent</span> <span class=o>&amp;&amp;</span> <span class=nx>n2</span> <span class=o>===</span> <span class=nx>parentComponent</span><span class=p>.</span><span class=nx>subTree</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>traverseStaticChildren</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* shallow */</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>fragmentEndAnchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>processComponent</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span>: <span class=kt>VNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span><span class=p>.</span><span class=nx>slotScopeIds</span> <span class=o>=</span> <span class=nx>slotScopeIds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>n1</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT_KEPT_ALIVE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 激活组件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=nx>parentComponent</span><span class=o>!</span><span class=p>.</span><span class=nx>ctx</span> <span class=kr>as</span> <span class=nx>KeepAliveContext</span><span class=p>).</span><span class=nx>activate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 挂载组件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>mountComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 更新组件
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>updateComponent</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mountComponent</span>: <span class=kt>MountComponentFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>initialVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>compatMountInstance</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span> <span class=nx>initialVNode</span><span class=p>.</span><span class=nx>isCompatRoot</span> <span class=o>&amp;&amp;</span> <span class=nx>initialVNode</span><span class=p>.</span><span class=nx>component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取/创建组件实例
</span></span></span><span class=line><span class=cl><span class=cm>     * 包含了数据状态、isMounted、渲染内容 subTree...
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>compatMountInstance</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 保存在 vnode.component 上
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>(</span><span class=nx>initialVNode</span><span class=p>.</span><span class=nx>component</span> <span class=o>=</span> <span class=nx>createComponentInstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>initialVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>      <span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isKeepAlive</span><span class=p>(</span><span class=nx>initialVNode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>ctx</span> <span class=kr>as</span> <span class=nx>KeepAliveContext</span><span class=p>).</span><span class=nx>renderer</span> <span class=o>=</span> <span class=nx>internals</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span> <span class=nx>compatMountInstance</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 初始化组件，将内部状态转化为响应式数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>setupComponent</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>asyncDep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentSuspense</span> <span class=o>&amp;&amp;</span> <span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>registerDep</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>setupRenderEffect</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>initialVNode</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>placeholder</span> <span class=o>=</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span> <span class=o>=</span> <span class=nx>createVNode</span><span class=p>(</span><span class=nx>Comment</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>processCommentNode</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>placeholder</span><span class=p>,</span> <span class=nx>container</span><span class=o>!</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 构建 renderEffect 并触发声明周期调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>setupRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>initialVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n1</span>: <span class=kt>VNode</span><span class=p>,</span> <span class=nx>n2</span>: <span class=kt>VNode</span><span class=p>,</span> <span class=nx>optimized</span>: <span class=kt>boolean</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=p>(</span><span class=nx>n2</span><span class=p>.</span><span class=nx>component</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>component</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shouldUpdateComponent</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 需要更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>asyncDep</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=nx>instance</span><span class=p>.</span><span class=nx>asyncResolved</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>updateComponentPreRender</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>n2</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>next</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>invalidateJob</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>update</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>update</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 不需要更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>n2</span><span class=p>.</span><span class=nx>component</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>n2</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 组件渲染对应的 effect：
</span></span></span><span class=line><span class=cl><span class=cm>   * 通过 instance.isMounted 判断组件是更新还是挂载
</span></span></span><span class=line><span class=cl><span class=cm>   * 执行 bm/bu，调用 render 获得 VDOM 并进行 patch
</span></span></span><span class=line><span class=cl><span class=cm>   * 执行 m/u 钩子函数
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setupRenderEffect</span>: <span class=kt>SetupRenderEffectFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>initialVNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 会对 instance.isMounted 做判断
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>componentUpdateFn</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>instance</span><span class=p>.</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果组件实例还没有 mount
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=nx>vnodeHook</span>: <span class=kt>VNodeHook</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>props</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>initialVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>bm</span><span class=p>,</span> <span class=nx>m</span><span class=p>,</span> <span class=nx>parent</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>bm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeArrayFns</span><span class=p>(</span><span class=nx>bm</span><span class=p>);</span> <span class=c1>// 触发 beforeMount 生命周期
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeBeforeMount</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>initialVNode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:beforeMount&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>hydrateNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>hydrateSubTree</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span> <span class=o>=</span> <span class=nx>renderComponentRoot</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>hydrateNode</span><span class=o>!</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>el</span> <span class=kr>as</span> <span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=kc>null</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>isAsyncWrapper</span><span class=p>(</span><span class=nx>initialVNode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=nx>initialVNode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ComponentOptions</span><span class=p>).</span><span class=nx>__asyncLoader</span><span class=o>!</span><span class=p>().</span><span class=nx>then</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>()</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>instance</span><span class=p>.</span><span class=nx>isUnmounted</span> <span class=o>&amp;&amp;</span> <span class=nx>hydrateSubTree</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>hydrateSubTree</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 得到 render 渲染结果
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>subTree</span> <span class=o>=</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span> <span class=o>=</span> <span class=nx>renderComponentRoot</span><span class=p>(</span><span class=nx>instance</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 对渲染结果进行 patch
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span><span class=p>,</span> <span class=c1>// 如果为 null，代表进行全新的挂载
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>subTree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>initialVNode</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>subTree</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>m</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 将 mount 生命周期加入任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>m</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeMounted</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>scopedInitialVNode</span> <span class=o>=</span> <span class=nx>initialVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=o>!</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>scopedInitialVNode</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:mounted&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>initialVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT_SHOULD_KEEP_ALIVE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 将 activated 生命周期加入任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>instance</span><span class=p>.</span><span class=nx>a</span> <span class=o>&amp;&amp;</span> <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>a</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:activated&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 更新组件实例挂载状态
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>initialVNode</span> <span class=o>=</span> <span class=nx>container</span> <span class=o>=</span> <span class=nx>anchor</span> <span class=o>=</span> <span class=kc>null</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果组件实例已经 mount
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=p>{</span> <span class=nx>next</span><span class=p>,</span> <span class=nx>bu</span><span class=p>,</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>vnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>originNext</span> <span class=o>=</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>vnodeHook</span>: <span class=kt>VNodeHook</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>next</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>updateComponentPreRender</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>next</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>next</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>bu</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeArrayFns</span><span class=p>(</span><span class=nx>bu</span><span class=p>);</span> <span class=c1>// 触发 beforeUpdate 生命周期
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>next</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>next</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeBeforeUpdate</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>next</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:beforeUpdate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>nextTree</span> <span class=o>=</span> <span class=nx>renderComponentRoot</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span> <span class=c1>// 重新渲染 subTree
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>prevTree</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span> <span class=o>=</span> <span class=nx>nextTree</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 对渲染前后的 subTree 进行 diff
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>prevTree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>nextTree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>hostParentNode</span><span class=p>(</span><span class=nx>prevTree</span><span class=p>.</span><span class=nx>el</span><span class=o>!</span><span class=p>)</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>getNextHostNode</span><span class=p>(</span><span class=nx>prevTree</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>next</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>nextTree</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>originNext</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>updateHOCHostEl</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>nextTree</span><span class=p>.</span><span class=nx>el</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span> <span class=c1>// 触发 updated 生命周期
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>next</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>next</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeUpdated</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=o>!</span><span class=p>,</span> <span class=nx>parent</span><span class=p>,</span> <span class=nx>next</span><span class=o>!</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:updated&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>effect</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ReactiveEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>componentUpdateFn</span><span class=p>,</span> <span class=c1>// 调用 componentUpdateFn 完成依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>queueJob</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>update</span><span class=p>),</span> <span class=c1>// 组件的后续更新，放在 queueJob 队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>instance</span><span class=p>.</span><span class=nx>scope</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>update</span> <span class=o>=</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>update</span> <span class=o>=</span> <span class=nx>effect</span><span class=p>.</span><span class=nx>run</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>effect</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>SchedulerJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>update</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>uid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>effect</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=nx>update</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>update</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>updateComponentPreRender</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextVNode</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextVNode</span><span class=p>.</span><span class=nx>component</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>;</span> <span class=c1>// 更新 nextVNode 组件实例的指向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>prevProps</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span> <span class=c1>// 获取更新前的 props
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span> <span class=o>=</span> <span class=nx>nextVNode</span><span class=p>;</span> <span class=c1>// 更新组件实例 vnode 指向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>instance</span><span class=p>.</span><span class=nx>next</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateProps</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>nextVNode</span><span class=p>.</span><span class=nx>props</span><span class=p>,</span> <span class=nx>prevProps</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>);</span> <span class=c1>// 更新组件实例 props
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updateSlots</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>nextVNode</span><span class=p>.</span><span class=nx>children</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>);</span> <span class=c1>// 调用插槽
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pauseTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>flushPreFlushCbs</span><span class=p>(</span><span class=kc>undefined</span><span class=p>,</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>update</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>resetTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// diff 核心：patchChildren、patchKeyedChildren、patchUnkeyedChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>patchChildren</span>: <span class=kt>PatchChildrenFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>c1</span> <span class=o>=</span> <span class=nx>n1</span> <span class=o>&amp;&amp;</span> <span class=nx>n1</span><span class=p>.</span><span class=nx>children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevShapeFlag</span> <span class=o>=</span> <span class=nx>n1</span> <span class=o>?</span> <span class=nx>n1.shapeFlag</span> : <span class=kt>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>c2</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>.</span><span class=nx>children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>patchFlag</span><span class=p>,</span> <span class=nx>shapeFlag</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>n2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>KEYED_FRAGMENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// children 有 key 的 Frangment，处理带有 key 属性的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchKeyedChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>c1</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>          <span class=nx>c2</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>UNKEYED_FRAGMENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// children 没有 key 的 Frangment，处理没有 key 属性的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchUnkeyedChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>c1</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>          <span class=nx>c2</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TEXT_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 处理 n2.children 为文本节点的情况（n1.children 可能：没有节点｜文本节点｜一组节点）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>prevShapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 n1.children 为一组节点，unmountChildren 会循环卸载所有 n1.children
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>unmountChildren</span><span class=p>(</span><span class=nx>c1</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>c2</span> <span class=o>!==</span> <span class=nx>c1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 此时 n1.children 可能：没有节点｜文本节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hostSetElementText</span><span class=p>(</span><span class=nx>container</span><span class=p>,</span> <span class=nx>c2</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 此时 n2.children 可能：没有节点｜一组节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>prevShapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果 n1.children 为一组节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 并且 n2.children 也为一组节点，对 c1 c2 进行 patch
</span></span></span><span class=line><span class=cl><span class=cm>           * 最简单的 diff，n1.children 全部卸载，n2.children 全部挂载
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>patchKeyedChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>c1</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nx>c2</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// n2.children 什么也没有，卸载 n1.children 即可
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>unmountChildren</span><span class=p>(</span><span class=nx>c1</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 此时 n1.children 可能：没有节点｜文本节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>prevShapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TEXT_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 n1.children 为文本节点，删除文本
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>hostSetElementText</span><span class=p>(</span><span class=nx>container</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 n2.children 为一组节点，挂载 n2.children
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>mountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>c2</span> <span class=kr>as</span> <span class=nx>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 对于没有 key 的情况：
</span></span></span><span class=line><span class=cl><span class=cm>   * 循环 commonLength 次，对 c1[i] 和 c2[i] 进行 patch 操作
</span></span></span><span class=line><span class=cl><span class=cm>   * oldLength &gt; newLength，卸载旧的节点（commonLength 之后的）
</span></span></span><span class=line><span class=cl><span class=cm>   * oldLength &lt; newLength，挂载新的节点（commonLength 之后的）
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>patchUnkeyedChildren</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>c1</span>: <span class=kt>VNode</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>c2</span>: <span class=kt>VNodeArrayChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>c1</span> <span class=o>=</span> <span class=nx>c1</span> <span class=o>||</span> <span class=nx>EMPTY_ARR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>c2</span> <span class=o>=</span> <span class=nx>c2</span> <span class=o>||</span> <span class=nx>EMPTY_ARR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>oldLength</span> <span class=o>=</span> <span class=nx>c1</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=c1>// 旧节点长度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>newLength</span> <span class=o>=</span> <span class=nx>c2</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=c1>// 新节点长度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>commonLength</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(</span><span class=nx>oldLength</span><span class=p>,</span> <span class=nx>newLength</span><span class=p>);</span> <span class=c1>// 取最短（公共长度）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>commonLength</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>nextChild</span> <span class=o>=</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 对 c1[i] 和 c2[i] 进行 patch 操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>nextChild</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldLength</span> <span class=o>&gt;</span> <span class=nx>newLength</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 卸载旧的节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>unmountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>c1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>commonLength</span> <span class=c1>// commonLength 之后的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 挂载新的节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>mountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>c2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>commonLength</span> <span class=c1>// commonLength 之后的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 快速 Diff 算法：
</span></span></span><span class=line><span class=cl><span class=cm>   * 对于有 key 的情况（新旧节点存在可复用的情况）
</span></span></span><span class=line><span class=cl><span class=cm>   * 只要 vnode 的 type 相同、key 相同，就认为是相同节点
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>patchKeyedChildren</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>c1</span>: <span class=kt>VNode</span><span class=p>[],</span> <span class=c1>// oldChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c2</span>: <span class=kt>VNodeArrayChildren</span><span class=p>,</span> <span class=c1>// newChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>container</span>: <span class=kt>RendererElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentAnchor</span>: <span class=kt>RendererNode</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isSVG</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// newStartIndex/oldStartIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>l2</span> <span class=o>=</span> <span class=nx>c2</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>e1</span> <span class=o>=</span> <span class=nx>c1</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// oldEndIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>e2</span> <span class=o>=</span> <span class=nx>l2</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// newEndIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 这个步骤用来处理相同的‘前置’节点
</span></span></span><span class=line><span class=cl><span class=cm>     * (a b) c
</span></span></span><span class=line><span class=cl><span class=cm>     * (a b) d e
</span></span></span><span class=line><span class=cl><span class=cm>     * 从前向后遍历
</span></span></span><span class=line><span class=cl><span class=cm>     * 每次循环对比 c1[i] 和 c2[i]
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 c1[i] 和 c2[i] 是相同节点，patch c1[i] 和 c2[i]
</span></span></span><span class=line><span class=cl><span class=cm>     * 否则终止循环，记录下 i
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e1</span> <span class=o>&amp;&amp;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>n1</span> <span class=o>=</span> <span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>n2</span> <span class=o>=</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isSameVNodeType</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 这个步骤用来处理相同的‘后置’节点
</span></span></span><span class=line><span class=cl><span class=cm>     * a (b c)
</span></span></span><span class=line><span class=cl><span class=cm>     * d e (b c)
</span></span></span><span class=line><span class=cl><span class=cm>     * 从后向前遍历
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 c1[e1] 和 c2[e2] 是相同节点，patch c1[e1] 和 c2[e2]
</span></span></span><span class=line><span class=cl><span class=cm>     * 否则终止循环，记录下 e1 和 e2
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e1</span> <span class=o>&amp;&amp;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>n1</span> <span class=o>=</span> <span class=nx>c1</span><span class=p>[</span><span class=nx>e1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>n2</span> <span class=o>=</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>e2</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>e2</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>e2</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isSameVNodeType</span><span class=p>(</span><span class=nx>n1</span><span class=p>,</span> <span class=nx>n2</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>n1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>n2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>e1</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>e2</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=nx>e1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 前置相同节点和后置相同节点处理完毕后
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果 oldStartIndex 大于 oldEndIndex
</span></span></span><span class=line><span class=cl><span class=cm>       * 说明，对 oldChildren 完成了完整的遍历
</span></span></span><span class=line><span class=cl><span class=cm>       * oldChildren 中没有剩余节点
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 如果 newStartIndex 小于等于 newEndIndex
</span></span></span><span class=line><span class=cl><span class=cm>         * 说明，对 newChildren 没有完成完整的遍历
</span></span></span><span class=line><span class=cl><span class=cm>         * newChildren 中有新增节点
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>nextPos</span> <span class=o>=</span> <span class=nx>e2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过 newStartIndex 找到挂载锚点，如果 newStartIndex + 1 已经大于 newChildren 的长度，则锚点应为父元素
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>anchor</span> <span class=o>=</span> <span class=nx>nextPos</span> <span class=o>&lt;</span> <span class=nx>l2</span> <span class=o>?</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>nextPos</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>).</span><span class=nx>el</span> : <span class=kt>parentAnchor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 遍历剩下的 newChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>])),</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&gt;</span> <span class=nx>e2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果 newStartIndex 大于 newEndIndex
</span></span></span><span class=line><span class=cl><span class=cm>       * 说明，对 newChildren 完成完整的遍历
</span></span></span><span class=line><span class=cl><span class=cm>       * newChildren 中没有剩余节点
</span></span></span><span class=line><span class=cl><span class=cm>       * 卸载剩下的 oldChildren
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>unmount</span><span class=p>(</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// newChildren 和 oldChildren 都没完成完整的遍历，新旧节点均有剩余
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>s1</span> <span class=o>=</span> <span class=nx>i</span><span class=p>;</span> <span class=c1>// oldStartIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>s2</span> <span class=o>=</span> <span class=nx>i</span><span class=p>;</span> <span class=c1>// newStartIndex
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>keyToNewIndexMap</span>: <span class=kt>Map</span><span class=p>&lt;</span><span class=nt>string</span> <span class=err>|</span> <span class=na>number</span><span class=err>,</span> <span class=na>number</span><span class=p>&gt;</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span> <span class=c1>// 将剩余的 newChildrenKey 和索引映射为 Map
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 遍历剩余的 newChildren，将 c2[i].key 和在 newChildren 中的实际 index 保存在 Map 中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>s2</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>nextChild</span> <span class=o>=</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>cloneIfMounted</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=nx>normalizeVNode</span><span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>nextChild</span><span class=p>.</span><span class=nx>key</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>keyToNewIndexMap</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>nextChild</span><span class=p>.</span><span class=nx>key</span><span class=p>,</span> <span class=nx>i</span><span class=p>);</span> <span class=c1>// i 是绝对位置，因为是从 s2 开始的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>moved</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否需要移动节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>patched</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 已经被 patch 的节点数量
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>maxNewIndexSoFar</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 遍历 oldChildren 过程中遇到的最大的 newIndex 值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>toBePatched</span> <span class=o>=</span> <span class=nx>e2</span> <span class=o>-</span> <span class=nx>s2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// newChildren 中，需要被 patch 的节点个数（剩余节点数量）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 新建长度为 toBePatched 的数组，用来保存“newChildren 中的节点在 oldChildren 中的位置（原先的位置）”
</span></span></span><span class=line><span class=cl><span class=cm>       * newIndexToOldIndexMap[newChild 的相对位置] = oldChild 的下标 + 1（如果找得到的话）
</span></span></span><span class=line><span class=cl><span class=cm>       * 需要计算出 newIndexToOldIndexMap 中的最长递增子序列
</span></span></span><span class=line><span class=cl><span class=cm>       * 0 1  2 3 4  5 6
</span></span></span><span class=line><span class=cl><span class=cm>       * a b [c d e] f g
</span></span></span><span class=line><span class=cl><span class=cm>       * a b [e c d h] f g
</span></span></span><span class=line><span class=cl><span class=cm>       *     [5,3,4,0]
</span></span></span><span class=line><span class=cl><span class=cm>       * [5,3,4,0] 中，3,4 不需要移动，5 需要移动，0 需要新建
</span></span></span><span class=line><span class=cl><span class=cm>       * newChildren 中的 h 节点没有找到可复用的对应节点，所以对应的值为 0
</span></span></span><span class=line><span class=cl><span class=cm>       * 在 newIndexToOldIndexMap 中查找“最长递增子序列”的目的是为了“尽可能少的移动节点”，在子序列中出现的节点是不用动的
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>newIndexToOldIndexMap</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Array</span><span class=p>(</span><span class=nx>toBePatched</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>toBePatched</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=nx>newIndexToOldIndexMap</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 遍历 oldChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>s1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>e1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>prevChild</span> <span class=o>=</span> <span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span> <span class=c1>// 拿取一个 oldChild
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>patched</span> <span class=o>&gt;=</span> <span class=nx>toBePatched</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果已经被 patch 的节点数量 &gt;= 需要被 patch 的节点数量
</span></span></span><span class=line><span class=cl><span class=cm>           * newChildren 中已经没有要更新的节点
</span></span></span><span class=line><span class=cl><span class=cm>           * 卸载 prevChild 即可
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>unmount</span><span class=p>(</span><span class=nx>prevChild</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>continue</span><span class=p>;</span> <span class=c1>// 跳过本次循环
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>newIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>prevChild</span><span class=p>.</span><span class=nx>key</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * newIndex 取 prevChild.key 在 keyToNewIndexMap 中对应的 value（绝对位置）
</span></span></span><span class=line><span class=cl><span class=cm>           * newIndex 指可复用节点 prevChild 在 newChildren 中的位置
</span></span></span><span class=line><span class=cl><span class=cm>           * 此时，c2[newIndex] 对应的可复用节点为 prevChild/c1[i]
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果能取到，说明节点可以复用
</span></span></span><span class=line><span class=cl><span class=cm>           * 如果取不到，卸载 prevChild
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>newIndex</span> <span class=o>=</span> <span class=nx>keyToNewIndexMap</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>prevChild</span><span class=p>.</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 prevChild.key 是 null，遍历剩余（s2～e2）的 newChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>for</span> <span class=p>(</span><span class=nx>j</span> <span class=o>=</span> <span class=nx>s2</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&lt;=</span> <span class=nx>e2</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>               * newIndexToOldIndexMap 的下标为相对位置，所以是 j-s2
</span></span></span><span class=line><span class=cl><span class=cm>               * 如果 j-s2 位置的值 === 0
</span></span></span><span class=line><span class=cl><span class=cm>               * j-s2 对应的节点没有被复用
</span></span></span><span class=line><span class=cl><span class=cm>               */</span>
</span></span><span class=line><span class=cl>              <span class=nx>newIndexToOldIndexMap</span><span class=p>[</span><span class=nx>j</span> <span class=o>-</span> <span class=nx>s2</span><span class=p>]</span> <span class=o>===</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>              <span class=nx>isSameVNodeType</span><span class=p>(</span><span class=nx>prevChild</span><span class=p>,</span> <span class=nx>c2</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>newIndex</span> <span class=o>=</span> <span class=nx>j</span><span class=p>;</span> <span class=c1>// 新增节点的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>newIndex</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 如果 newChildren 中没有找到和 c1[i] 有相同 key 的节点，卸载 c1[i]
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>unmount</span><span class=p>(</span><span class=nx>prevChild</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 找到了就进行 patch（c1[i] 和 c2[newIndex]），还要更新 patched 的值
</span></span></span><span class=line><span class=cl><span class=cm>           * 既然找到了可复用的元素，更新 newIndexToOldIndexMap
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>newIndexToOldIndexMap</span><span class=p>[</span><span class=nx>newIndex</span> <span class=o>-</span> <span class=nx>s2</span><span class=p>]</span> <span class=o>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>newIndex</span> <span class=o>&gt;=</span> <span class=nx>maxNewIndexSoFar</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>             * 如果 c1[i] 在 newChildren 中的新位置 newIndex 比 maxNewIndexSoFar 还要大
</span></span></span><span class=line><span class=cl><span class=cm>             * 因为是从前向后遍历的，如果每次 newIndex 都比上次的 newIndex 大
</span></span></span><span class=line><span class=cl><span class=cm>             * 说明不需要进行移动操作，更新 maxNewIndexSoFar 即可
</span></span></span><span class=line><span class=cl><span class=cm>             */</span>
</span></span><span class=line><span class=cl>            <span class=nx>maxNewIndexSoFar</span> <span class=o>=</span> <span class=nx>newIndex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>             * 如果 newIndex 突然出现有小于 maxNewIndexSoFar
</span></span></span><span class=line><span class=cl><span class=cm>             * 说明，newIndex 的递增趋势被打破
</span></span></span><span class=line><span class=cl><span class=cm>             * 有节点要插队，需要移动节点
</span></span></span><span class=line><span class=cl><span class=cm>             * 否则，就没有必要计算子序列
</span></span></span><span class=line><span class=cl><span class=cm>             */</span>
</span></span><span class=line><span class=cl>            <span class=nx>moved</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>prevChild</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>c2</span><span class=p>[</span><span class=nx>newIndex</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>patched</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 到了这一步，没用的旧节点已经被卸载了，可以“被复用的不需要被移动”的旧节点也被 patch 了
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果出现了需要移动旧节点到新位置的情况（moved===true）
</span></span></span><span class=line><span class=cl><span class=cm>       * 需要计算出 newIndexToOldIndexMap 中的最长递增子序列的“索引/下标”
</span></span></span><span class=line><span class=cl><span class=cm>       * newIndexToOldIndexMap: [5,3,4,0]
</span></span></span><span class=line><span class=cl><span class=cm>       * 最长递增子序列为：[3,4]
</span></span></span><span class=line><span class=cl><span class=cm>       * 对应的下标为：[1,2]
</span></span></span><span class=line><span class=cl><span class=cm>       * 此时，increasingNewIndexSequence 为 [1,2]
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>increasingNewIndexSequence</span> <span class=o>=</span> <span class=nx>moved</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>getSequence</span><span class=p>(</span><span class=nx>newIndexToOldIndexMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>EMPTY_ARR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 获取 increasingNewIndexSequence 中最后一个元素的下标
</span></span></span><span class=line><span class=cl><span class=cm>       * 下标本身没什么实际意义，算是“最长递增子序列”长度的别名
</span></span></span><span class=line><span class=cl><span class=cm>       * 在循环 toBePatched-&gt;0 的时候，用来判断：
</span></span></span><span class=line><span class=cl><span class=cm>       * 什么时候开始移动（跳过多少个节点不移动）
</span></span></span><span class=line><span class=cl><span class=cm>       * 因为子序列里的节点是稳定的，不需要移动
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>j</span> <span class=o>=</span> <span class=nx>increasingNewIndexSequence</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 从后向前遍历需要被处理的剩余节点，处理 move &amp; mount 情况
</span></span></span><span class=line><span class=cl><span class=cm>       * 为什么不“从前往后”遍历呢？因为“插入节点”需要有一个“锚点”
</span></span></span><span class=line><span class=cl><span class=cm>       * 这里的 i 表示“相对位置”
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>toBePatched</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>nextIndex</span> <span class=o>=</span> <span class=nx>s2</span> <span class=o>+</span> <span class=nx>i</span><span class=p>;</span> <span class=c1>// 在 newChildren 中的索引（绝对位置）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>nextChild</span> <span class=o>=</span> <span class=nx>c2</span><span class=p>[</span><span class=nx>nextIndex</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>;</span> <span class=c1>// 拿到待处理的 nextChild
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 锚点为 c2[nextIndex + 1] 或父级锚点（根据 newIndex+1 和 l2 的关系）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>anchor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=nx>nextIndex</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=nx>l2</span> <span class=o>?</span> <span class=p>(</span><span class=nx>c2</span><span class=p>[</span><span class=nx>nextIndex</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>).</span><span class=nx>el</span> : <span class=kt>parentAnchor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>newIndexToOldIndexMap</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 在 oldChildren 中没有对应的节点，属于新增的节点，挂载 nextChild
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>nextChild</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>slotScopeIds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>moved</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>i</span> <span class=o>!==</span> <span class=nx>increasingNewIndexSequence</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=o>||</span> <span class=nx>j</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>             * 当前相对下标和子序列里的最后的下标不相等
</span></span></span><span class=line><span class=cl><span class=cm>             * 或者，不在子序列里的节点
</span></span></span><span class=line><span class=cl><span class=cm>             * 需要移动
</span></span></span><span class=line><span class=cl><span class=cm>             */</span>
</span></span><span class=line><span class=cl>            <span class=nx>move</span><span class=p>(</span><span class=nx>nextChild</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>MoveType</span><span class=p>.</span><span class=nx>REORDER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>j</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>move</span>: <span class=kt>MoveFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>moveType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>el</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>transition</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>shapeFlag</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>move</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>.</span><span class=nx>subTree</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>moveType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>suspense</span><span class=o>!</span><span class=p>.</span><span class=nx>move</span><span class=p>(</span><span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>moveType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TELEPORT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kr>type</span> <span class=kr>as</span> <span class=k>typeof</span> <span class=nx>TeleportImpl</span><span class=p>).</span><span class=nx>move</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>internals</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Fragment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=p>(</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[]).</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>move</span><span class=p>((</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[])[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>moveType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>anchor</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Static</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>moveStaticNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>needTransition</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>moveType</span> <span class=o>!==</span> <span class=nx>MoveType</span><span class=p>.</span><span class=nx>REORDER</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ELEMENT</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>transition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>needTransition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>moveType</span> <span class=o>===</span> <span class=nx>MoveType</span><span class=p>.</span><span class=nx>ENTER</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 挂载 DOM 之前，调用 transition.beforeEnter 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>transition</span><span class=o>!</span><span class=p>.</span><span class=nx>beforeEnter</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 挂载 DOM 之后，调用 transition.enter 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=nx>transition</span><span class=o>!</span><span class=p>.</span><span class=nx>enter</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>),</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>leave</span><span class=p>,</span> <span class=nx>delayLeave</span><span class=p>,</span> <span class=nx>afterLeave</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>transition</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>remove</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>performLeave</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>leave</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>remove</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>afterLeave</span> <span class=o>&amp;&amp;</span> <span class=nx>afterLeave</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>delayLeave</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 调用 transition.delayLeave
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>delayLeave</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>remove</span><span class=p>,</span> <span class=nx>performLeave</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 调用 transition.leave &amp; transition.afterLeave
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>performLeave</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostInsert</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 卸载 vnode
</span></span></span><span class=line><span class=cl><span class=cm>   * 调用自身/子级组件生命周期
</span></span></span><span class=line><span class=cl><span class=cm>   * 调用自定义指令声明周期
</span></span></span><span class=line><span class=cl><span class=cm>   * 移除 DOM 事件绑定
</span></span></span><span class=line><span class=cl><span class=cm>   * 移除 DOM 元素
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>unmount</span>: <span class=kt>UnmountFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>doRemove</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>props</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>ref</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>dynamicChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>shapeFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>patchFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>dirs</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>ref</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setRef</span><span class=p>(</span><span class=nx>ref</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT_SHOULD_KEEP_ALIVE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果包裹在 keep-alive 组件，调用 deactivate 声明周期
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>(</span><span class=nx>parentComponent</span><span class=o>!</span><span class=p>.</span><span class=nx>ctx</span> <span class=kr>as</span> <span class=nx>KeepAliveContext</span><span class=p>).</span><span class=nx>deactivate</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>shouldInvokeDirs</span> <span class=o>=</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ELEMENT</span> <span class=o>&amp;&amp;</span> <span class=nx>dirs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>vnodeHook</span>: <span class=kt>VNodeHook</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=o>|</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeBeforeUnmount</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 卸载对应 vnode 对应的组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>unmountComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=nx>doRemove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>suspense</span><span class=o>!</span><span class=p>.</span><span class=nx>unmount</span><span class=p>(</span><span class=nx>parentSuspense</span><span class=p>,</span> <span class=nx>doRemove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>shouldInvokeDirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;beforeUnmount&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>TELEPORT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=k>typeof</span> <span class=nx>TeleportImpl</span><span class=p>).</span><span class=nx>remove</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>optimized</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>internals</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>doRemove</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>dynamicChildren</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=kr>type</span> <span class=o>!==</span> <span class=nx>Fragment</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>STABLE_FRAGMENT</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// children 不变的 Frangment
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>unmountChildren</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>dynamicChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Fragment</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>KEYED_FRAGMENT</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>            <span class=nx>patchFlag</span> <span class=o>&amp;</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>UNKEYED_FRAGMENT</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>!</span><span class=nx>optimized</span> <span class=o>&amp;&amp;</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ARRAY_CHILDREN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果为 Fragment，卸载 children
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>unmountChildren</span><span class=p>(</span><span class=nx>children</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>[],</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>doRemove</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>remove</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeUnmounted</span><span class=p>)</span> <span class=o>||</span> <span class=nx>shouldInvokeDirs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnodeHook</span> <span class=o>&amp;&amp;</span> <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>shouldInvokeDirs</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeDirectiveHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>parentComponent</span><span class=p>,</span> <span class=s1>&#39;unmounted&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>remove</span>: <span class=kt>RemoveFn</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=kr>type</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>transition</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Fragment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>removeFragment</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>anchor</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>Static</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>removeStaticNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>performRemove</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostRemove</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>transition</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>transition</span><span class=p>.</span><span class=nx>persisted</span> <span class=o>&amp;&amp;</span> <span class=nx>transition</span><span class=p>.</span><span class=nx>afterLeave</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>transition</span><span class=p>.</span><span class=nx>afterLeave</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>ELEMENT</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>transition</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>transition</span><span class=p>.</span><span class=nx>persisted</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>leave</span><span class=p>,</span> <span class=nx>delayLeave</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>transition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>performLeave</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>leave</span><span class=p>(</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>performRemove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>delayLeave</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>delayLeave</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span><span class=o>!</span><span class=p>,</span> <span class=nx>performRemove</span><span class=p>,</span> <span class=nx>performLeave</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>performLeave</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>performRemove</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>removeFragment</span> <span class=o>=</span> <span class=p>(</span><span class=nx>cur</span>: <span class=kt>RendererNode</span><span class=p>,</span> <span class=nx>end</span>: <span class=kt>RendererNode</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>cur</span> <span class=o>!==</span> <span class=nx>end</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>next</span> <span class=o>=</span> <span class=nx>hostNextSibling</span><span class=p>(</span><span class=nx>cur</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>hostRemove</span><span class=p>(</span><span class=nx>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>cur</span> <span class=o>=</span> <span class=nx>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>hostRemove</span><span class=p>(</span><span class=nx>end</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>unmountComponent</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>doRemove?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>bum</span><span class=p>,</span> <span class=nx>scope</span><span class=p>,</span> <span class=nx>update</span><span class=p>,</span> <span class=nx>subTree</span><span class=p>,</span> <span class=nx>um</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>bum</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeArrayFns</span><span class=p>(</span><span class=nx>bum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:beforeDestroy&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>scope</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>scope</span><span class=p>.</span><span class=nx>stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>update</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>update</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>unmount</span><span class=p>(</span><span class=nx>subTree</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>,</span> <span class=nx>doRemove</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>um</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>um</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>isCompatEnabled</span><span class=p>(</span><span class=nx>DeprecationTypes</span><span class=p>.</span><span class=nx>INSTANCE_EVENT_HOOKS</span><span class=p>,</span> <span class=nx>instance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;hook:destroyed&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>isUnmounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentSuspense</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>pendingBranch</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>isUnmounted</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>asyncDep</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>instance</span><span class=p>.</span><span class=nx>asyncResolved</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>suspenseId</span> <span class=o>===</span> <span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>pendingId</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>deps</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>deps</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>.</span><span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>unmountChildren</span>: <span class=kt>UnmountChildrenFn</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>doRemove</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>optimized</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>start</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 遍历 children，一次调用 unmount，unmount 内部会递归调用 unmountChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>start</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>unmount</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>doRemove</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>getNextHostNode</span>: <span class=kt>NextFn</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>getNextHostNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>.</span><span class=nx>subTree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>suspense</span><span class=o>!</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>hostNextSibling</span><span class=p>((</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>anchor</span> <span class=o>||</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>render</span>: <span class=kt>RootRenderFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>isSVG</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 旧的 vnode 存在，新的 vnode 不存在，执行卸载（自身及子组件）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>container</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>unmount</span><span class=p>(</span><span class=nx>container</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 新旧的 vnode 存在，进行 diff/patch/mount
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>||</span> <span class=kc>null</span><span class=p>,</span> <span class=c1>// 每次渲染完成，旧的 vnode 保存在 container._vnode，首次渲染时为 undefined
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>vnode</span><span class=p>,</span> <span class=c1>// 将要被挂载到 DOM 的新 vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>container</span><span class=p>,</span> <span class=c1>// 挂载容器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 清空渲染后的任务队列
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>flushPostFlushCbs</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>container</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>internals</span>: <span class=kt>RendererInternals</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span>: <span class=kt>patch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>um</span>: <span class=kt>unmount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span>: <span class=kt>move</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>r</span>: <span class=kt>remove</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>mt</span>: <span class=kt>mountComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>mc</span>: <span class=kt>mountChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>pc</span>: <span class=kt>patchChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>pbc</span>: <span class=kt>patchBlockChildren</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>n</span>: <span class=kt>getNextHostNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>o</span>: <span class=kt>options</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>hydrate</span>: <span class=kt>ReturnType</span><span class=p>&lt;</span><span class=nt>typeof</span> <span class=na>createHydrationFunctions</span><span class=p>&gt;[</span><span class=mi>0</span><span class=p>]</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>hydrateNode</span>: <span class=kt>ReturnType</span><span class=p>&lt;</span><span class=nt>typeof</span> <span class=na>createHydrationFunctions</span><span class=p>&gt;[</span><span class=mi>1</span><span class=p>]</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>createHydrationFns</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nx>hydrate</span><span class=p>,</span> <span class=nx>hydrateNode</span><span class=p>]</span> <span class=o>=</span> <span class=nx>createHydrationFns</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>internals</span> <span class=kr>as</span> <span class=nx>RendererInternals</span><span class=p>&lt;</span><span class=nt>Node</span><span class=err>,</span> <span class=na>Element</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>render</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>hydrate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>createApp</span>: <span class=kt>createAppAPI</span><span class=p>(</span><span class=nx>render</span><span class=p>,</span> <span class=nx>hydrate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getSequence</span><span class=p>(</span><span class=nx>arr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>lis</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// 保存着“最长递增子序列”的下标
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>record</span> <span class=o>=</span> <span class=nx>arr</span><span class=p>.</span><span class=nx>slice</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>length</span>: <span class=kt>len</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>arr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>len</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>arrI</span> <span class=o>=</span> <span class=nx>arr</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Vue 中，需要用 0 表示新增节点的情况，所以跳过
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>arrI</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * lis[lis.length - 1] 表示最长递增子序列最后一个值的下标
</span></span></span><span class=line><span class=cl><span class=cm>       * 所以 arr[last] 表示最长递增子序列的最后一个值
</span></span></span><span class=line><span class=cl><span class=cm>       * 我们这里没有把最长递增子序列显式的定义出来
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>last</span> <span class=o>=</span> <span class=nx>lis</span><span class=p>[</span><span class=nx>lis</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果最长递增子序列的最后一个值 arr[last] 小于 arrI
</span></span></span><span class=line><span class=cl><span class=cm>       * 说明 arrI 可以直接加入子序列
</span></span></span><span class=line><span class=cl><span class=cm>       * 所以将对应的下标加入 lis
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=nx>last</span><span class=p>]</span> <span class=o>&lt;</span> <span class=nx>arrI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * “最长递增子序列”的最后一个元素 arr[last] 小于新来的元素 arrI
</span></span></span><span class=line><span class=cl><span class=cm>         * [1,3,5] &lt;- 10，arr[last] 是 5，arrI 是 10
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>record</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>last</span><span class=p>;</span> <span class=c1>// 记录一下 i 对应的下标 lis[lis.length - 1]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>lis</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 构建最长递增子序列时，最后一个元素，越小越好
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果 arr[last] &gt;= arrI，需要进行元素替换
</span></span></span><span class=line><span class=cl><span class=cm>       * 用 arrI 把比 arrI 大的最小的那个元素替换掉
</span></span></span><span class=line><span class=cl><span class=cm>       * 所以，需要用二分查找替换
</span></span></span><span class=line><span class=cl><span class=cm>       * 最终找到 arr[lis[left]]
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>left</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>right</span> <span class=o>=</span> <span class=nx>lis</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>left</span> <span class=o>&lt;</span> <span class=nx>right</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 找到“最长递增子序列”里中间的元素的下标 lis[mid]
</span></span></span><span class=line><span class=cl><span class=cm>         * 在去 arr 里找到对应的值 arr[lis[mid]]
</span></span></span><span class=line><span class=cl><span class=cm>         * arr[lis[mid]] 就是子序列的中间值
</span></span></span><span class=line><span class=cl><span class=cm>         * 这里是去找 lis[mid] 对应的值
</span></span></span><span class=line><span class=cl><span class=cm>         * 所以 arr 没有事先排序无所谓
</span></span></span><span class=line><span class=cl><span class=cm>         * “最长递增子序列”是排好序的
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>mid</span> <span class=o>=</span> <span class=p>(</span><span class=nx>left</span> <span class=o>+</span> <span class=nx>right</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=nx>lis</span><span class=p>[</span><span class=nx>mid</span><span class=p>]]</span> <span class=o>&lt;</span> <span class=nx>arrI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 比 arrI 大的最小的那个元素，在右边
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>left</span> <span class=o>=</span> <span class=nx>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 比 arrI 大的最小的那个元素，在左边
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>right</span> <span class=o>=</span> <span class=nx>mid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 找比 arrI 大的最小元素，用 arrI 替换掉
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>arrI</span> <span class=o>&lt;</span> <span class=nx>arr</span><span class=p>[</span><span class=nx>lis</span><span class=p>[</span><span class=nx>left</span><span class=p>]])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>left</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 因为发生了元素的替换，需要更新一下 record[i]
</span></span></span><span class=line><span class=cl><span class=cm>           * record[i] 从 lis[lis.length - 1] 变为了 lis[left - 1]
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=nx>record</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>lis</span><span class=p>[</span><span class=nx>left</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>lis</span><span class=p>[</span><span class=nx>left</span><span class=p>]</span> <span class=o>=</span> <span class=nx>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>lis</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=c1>// “最长递增子序列”的长度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>last</span> <span class=o>=</span> <span class=nx>lis</span><span class=p>[</span><span class=nx>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span> <span class=c1>// “最长递增子序列”中最后一个元素的下标
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>lis</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>last</span> <span class=o>=</span> <span class=nx>record</span><span class=p>[</span><span class=nx>last</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>lis</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createComponentInstance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>parent</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>|</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>suspense</span>: <span class=kt>SuspenseBoundary</span> <span class=o>|</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=kr>type</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 继承父级的 appContext
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>appContext</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>parent</span> <span class=o>?</span> <span class=nx>parent.appContext</span> : <span class=kt>vnode.appContext</span><span class=p>)</span> <span class=o>||</span> <span class=nx>emptyAppContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>uid</span>: <span class=kt>uid</span><span class=o>++</span><span class=p>,</span> <span class=c1>// 唯一 ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>appContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>root</span>: <span class=kt>null</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>subTree</span>: <span class=kt>null</span><span class=o>!</span><span class=p>,</span> <span class=c1>// 实例创建后，被同步设置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>update</span>: <span class=kt>null</span><span class=o>!</span><span class=p>,</span> <span class=c1>// 实例创建后，被同步设置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>scope</span>: <span class=kt>new</span> <span class=nx>EffectScope</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>render</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>proxy</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exposed</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exposeProxy</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>withProxy</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>provides</span>: <span class=kt>parent</span> <span class=o>?</span> <span class=nx>parent.provides</span> : <span class=kt>Object.create</span><span class=p>(</span><span class=nx>appContext</span><span class=p>.</span><span class=nx>provides</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>accessCache</span>: <span class=kt>null</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>renderCache</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>components</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>directives</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>propsOptions</span>: <span class=kt>normalizePropsOptions</span><span class=p>(</span><span class=kr>type</span><span class=p>,</span> <span class=nx>appContext</span><span class=p>),</span> <span class=c1>// 处理 props
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>emitsOptions</span>: <span class=kt>normalizeEmitsOptions</span><span class=p>(</span><span class=kr>type</span><span class=p>,</span> <span class=nx>appContext</span><span class=p>),</span> <span class=c1>// 处理 emits
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>emit</span>: <span class=kt>null</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>emitted</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>propsDefaults</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span> <span class=c1>// props 默认是一个对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>inheritAttrs</span>: <span class=kt>type.inheritAttrs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 组件实例状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ctx</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>props</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>attrs</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slots</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>refs</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>setupState</span>: <span class=kt>EMPTY_OBJ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>setupContext</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Suspense 相关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>suspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>suspenseId</span>: <span class=kt>suspense</span> <span class=o>?</span> <span class=nx>suspense.pendingId</span> : <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncDep</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncResolved</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 生命周期相关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isMounted</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isUnmounted</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isDeactivated</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>bc</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>bm</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>m</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>bu</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>u</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>um</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>bum</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>da</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>a</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rtg</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>rtc</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ec</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>sp</span>: <span class=kt>null</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span><span class=p>.</span><span class=nx>ctx</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>_</span>: <span class=kt>instance</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span><span class=p>.</span><span class=nx>root</span> <span class=o>=</span> <span class=nx>parent</span> <span class=o>?</span> <span class=nx>parent.root</span> : <span class=kt>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span><span class=p>.</span><span class=nx>emit</span> <span class=o>=</span> <span class=nx>emit</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 对自定义元素特殊处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>ce</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>ce</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>setupComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isSSR</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>isInSSRComponentSetup</span> <span class=o>=</span> <span class=nx>isSSR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>props</span><span class=p>,</span> <span class=nx>children</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>;</span> <span class=c1>// 获取 vnode 的 props 和 children
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// isStateful = instance.vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>isStateful</span> <span class=o>=</span> <span class=nx>isStatefulComponent</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>initProps</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>props</span><span class=p>,</span> <span class=nx>isStateful</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>initSlots</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setupResult</span> <span class=o>=</span> <span class=nx>isStateful</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=c1>// 调用 setupStatefulComponent
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>setupStatefulComponent</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isInSSRComponentSetup</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>setupResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>setupStatefulComponent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isSSR</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>Component</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ComponentOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 创建渲染代理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>instance</span><span class=p>.</span><span class=nx>accessCache</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span><span class=p>.</span><span class=nx>proxy</span> <span class=o>=</span> <span class=nx>markRaw</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>Proxy</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>PublicInstanceProxyHandlers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>setup</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>Component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>setup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// {slots, emit, attrs, expose}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>setupContext</span> <span class=o>=</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>setupContext</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>setup</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=nx>createSetupContext</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>setCurrentInstance</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span> <span class=c1>// 将 instance 赋值给 currentInstance
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>pauseTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用 setup，返回 Promise|function|{}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>setupResult</span> <span class=o>=</span> <span class=nx>callWithErrorHandling</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>setup</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>SETUP_FUNCTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>[</span><span class=nx>instance</span><span class=p>.</span><span class=nx>props</span><span class=p>,</span> <span class=nx>setupContext</span><span class=p>]</span> <span class=c1>// setup 接受的两个参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>resetTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsetCurrentInstance</span><span class=p>();</span> <span class=c1>// // 将 null 赋值给 currentInstance
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isPromise</span><span class=p>(</span><span class=nx>setupResult</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>setupResult</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>unsetCurrentInstance</span><span class=p>,</span> <span class=nx>unsetCurrentInstance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isSSR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>setupResult</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>resolvedResult</span>: <span class=kt>unknown</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>handleSetupResult</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>resolvedResult</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>e</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>SETUP_FUNCTION</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>asyncDep</span> <span class=o>=</span> <span class=nx>setupResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果是函数，赋值给 instance.render
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果是对象，赋值给 instance.setupState
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleSetupResult</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>setupResult</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>finishComponentSetup</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>handleSetupResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>setupResult</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isSSR</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>setupResult</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>__NODE_JS__</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ComponentOptions</span><span class=p>).</span><span class=nx>__ssrInlineRender</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>ssrRender</span> <span class=o>=</span> <span class=nx>setupResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=nx>setupResult</span> <span class=kr>as</span> <span class=nx>InternalRenderFunction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>setupResult</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span><span class=p>.</span><span class=nx>setupState</span> <span class=o>=</span> <span class=nx>proxyRefs</span><span class=p>(</span><span class=nx>setupResult</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>finishComponentSetup</span><span class=p>(</span><span class=nx>instance</span><span class=p>,</span> <span class=nx>isSSR</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>finishComponentSetup</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isSSR</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>skipOptions?</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>Component</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ComponentOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>__COMPAT__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>convertLegacyRenderFn</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>__NODE_JS__</span> <span class=o>&amp;&amp;</span> <span class=nx>isSSR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>render</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>Component</span><span class=p>.</span><span class=nx>render</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>NOOP</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>InternalRenderFunction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>instance</span><span class=p>.</span><span class=nx>render</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>compile</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>Component</span><span class=p>.</span><span class=nx>render</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>template</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span><span class=p>[</span><span class=s1>&#39;inline-template&#39;</span><span class=p>])</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=nx>Component</span><span class=p>.</span><span class=nx>template</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>isCustomElement</span><span class=p>,</span> <span class=nx>compilerOptions</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>appContext</span><span class=p>.</span><span class=nx>config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>delimiters</span><span class=p>,</span> <span class=nx>compilerOptions</span>: <span class=kt>componentCompilerOptions</span> <span class=p>}</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=nx>Component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>finalCompilerOptions</span>: <span class=kt>CompilerOptions</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>extend</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>isCustomElement</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>delimiters</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>compilerOptions</span>
</span></span><span class=line><span class=cl>          <span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>componentCompilerOptions</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>__COMPAT__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>finalCompilerOptions</span><span class=p>.</span><span class=nx>compatConfig</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>globalCompatConfig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>Component</span><span class=p>.</span><span class=nx>compatConfig</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>extend</span><span class=p>(</span><span class=nx>finalCompilerOptions</span><span class=p>.</span><span class=nx>compatConfig</span><span class=p>,</span> <span class=nx>Component</span><span class=p>.</span><span class=nx>compatConfig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过编译器，拿到 render
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>Component</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=nx>compile</span><span class=p>(</span><span class=nx>template</span><span class=p>,</span> <span class=nx>finalCompilerOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=p>(</span><span class=nx>Component</span><span class=p>.</span><span class=nx>render</span> <span class=o>||</span> <span class=nx>NOOP</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>InternalRenderFunction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>render</span><span class=p>.</span><span class=nx>_rc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>instance</span><span class=p>.</span><span class=nx>withProxy</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Proxy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>ctx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>RuntimeCompiledPublicInstanceProxyHandlers</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_OPTIONS_API__</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=nx>__COMPAT__</span> <span class=o>&amp;&amp;</span> <span class=nx>skipOptions</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setCurrentInstance</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>pauseTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>applyOptions</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>resetTracking</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsetCurrentInstance</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createSetupContext</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span>: <span class=kt>ComponentInternalInstance</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>SetupContext</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>expose</span>: <span class=kt>SetupContext</span><span class=p>[</span><span class=s1>&#39;expose&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>exposed</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>instance</span><span class=p>.</span><span class=nx>exposed</span> <span class=o>=</span> <span class=nx>exposed</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>attrs</span>: <span class=kt>instance.attrs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slots</span>: <span class=kt>instance.slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>emit</span>: <span class=kt>instance.emit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>expose</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 返回了 AsyncComponentWrapper，一个包装组件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineAsyncComponent</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>T</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=o>=</span> <span class=p>{</span> <span class=k>new</span> <span class=p>()</span><span class=o>:</span> <span class=nx>ComponentPublicInstance</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span><span class=p>(</span><span class=nx>source</span>: <span class=kt>AsyncComponentLoader</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>AsyncComponentOptions</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;)</span><span class=o>:</span> <span class=nx>T</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>source</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>loader</span>: <span class=kt>source</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>loader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>loadingComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>errorComponent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>delay</span> <span class=o>=</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>suspensible</span> <span class=o>=</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onError</span>: <span class=kt>userOnError</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>=</span> <span class=nx>source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>pendingRequest</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>ConcreteComponent</span><span class=p>&gt;</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>resolvedComp</span>: <span class=kt>ConcreteComponent</span> <span class=o>|</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>retries</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>retry</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>retries</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>pendingRequest</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>load</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// load 函数，调用 loader 获取组件内容
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>load</span> <span class=o>=</span> <span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>ConcreteComponent</span><span class=p>&gt;</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>thisRequest</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>ConcreteComponent</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>pendingRequest</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>thisRequest</span> <span class=o>=</span> <span class=nx>pendingRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=nx>loader</span><span class=p>()</span> <span class=c1>// 调用传入的 loader 加载远程组件
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>err</span> <span class=o>=</span> <span class=nx>err</span> <span class=k>instanceof</span> <span class=nb>Error</span> <span class=o>?</span> <span class=nx>err</span> : <span class=kt>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nb>String</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>userOnError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>userRetry</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>retry</span><span class=p>());</span> <span class=c1>// 触发重试
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>userFail</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>userOnError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>userRetry</span><span class=p>,</span> <span class=nx>userFail</span><span class=p>,</span> <span class=nx>retries</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>throw</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>comp</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 组件加载成功后，赋值给 resolvedComp
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nx>thisRequest</span> <span class=o>!==</span> <span class=nx>pendingRequest</span> <span class=o>&amp;&amp;</span> <span class=nx>pendingRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=nx>pendingRequest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=nx>comp</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>comp</span><span class=p>.</span><span class=nx>__esModule</span> <span class=o>||</span> <span class=nx>comp</span><span class=p>[</span><span class=nx>Symbol</span><span class=p>.</span><span class=nx>toStringTag</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;Module&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>comp</span> <span class=o>=</span> <span class=nx>comp</span><span class=p>.</span><span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolvedComp</span> <span class=o>=</span> <span class=nx>comp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>comp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>defineComponent</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;AsyncComponentWrapper&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>__asyncLoader</span>: <span class=kt>load</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>get</span> <span class=nx>__asyncResolved() {</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>resolvedComp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>setup() {</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>currentInstance</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>resolvedComp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>createInnerComp</span><span class=p>(</span><span class=nx>resolvedComp</span><span class=o>!</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>onError</span> <span class=o>=</span> <span class=p>(</span><span class=nx>err</span>: <span class=kt>Error</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>pendingRequest</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>err</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>ASYNC_COMPONENT_LOADER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=o>!</span><span class=nx>errorComponent</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>suspensible</span> <span class=o>&amp;&amp;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>suspense</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>__NODE_JS__</span> <span class=o>&amp;&amp;</span> <span class=nx>isInSSRComponentSetup</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>comp</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>createInnerComp</span><span class=p>(</span><span class=nx>comp</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>onError</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nx>errorComponent</span>
</span></span><span class=line><span class=cl>                <span class=o>?</span> <span class=nx>createVNode</span><span class=p>(</span><span class=nx>errorComponent</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>error</span>: <span class=kt>err</span>
</span></span><span class=line><span class=cl>                  <span class=p>})</span>
</span></span><span class=line><span class=cl>                <span class=o>:</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>loaded</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span> <span class=c1>// 异步是否加载成功
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>error</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>();</span> <span class=c1>// 错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>delayed</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=o>!!</span><span class=nx>delay</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>delay</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>delayed</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>delay</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>timeout</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>loaded</span><span class=p>.</span><span class=nx>value</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>error</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 超时后，渲染失败
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>err</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=sb>`Async component timed out after </span><span class=si>${</span><span class=nx>timeout</span><span class=si>}</span><span class=sb>ms.`</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>onError</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>error</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>then</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 组件加载成功，更改 loaded.value
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>loaded</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span> <span class=o>&amp;&amp;</span> <span class=nx>isKeepAlive</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>queueJob</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>update</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>onError</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>error</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>loaded</span><span class=p>.</span><span class=nx>value</span> <span class=o>&amp;&amp;</span> <span class=nx>resolvedComp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 加载完成并加载成功，渲染 resolvedComp
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>createInnerComp</span><span class=p>(</span><span class=nx>resolvedComp</span><span class=p>,</span> <span class=nx>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>value</span> <span class=o>&amp;&amp;</span> <span class=nx>errorComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 加载失败，渲染 errorComponent
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>createVNode</span><span class=p>(</span><span class=nx>errorComponent</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>error</span>: <span class=kt>error.value</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>loadingComponent</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>delayed</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 加载中，渲染 loadingComponent
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>createVNode</span><span class=p>(</span><span class=nx>loadingComponent</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=keep-alive-2x>keep-alive 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 获取组件 name
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>opts</span>: <span class=kt>?VNodeComponentOptions</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>opts</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// name 是否匹配 pattern
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>pattern</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>pattern</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>).</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isRegExp</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>CacheEntry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>componentInstance</span>: <span class=kt>Component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>?string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span>: <span class=kt>?string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>CacheEntryMap</span> <span class=o>=</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=o>?</span><span class=nx>CacheEntry</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// 修剪缓存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>pruneCache</span><span class=p>(</span><span class=nx>keepAliveInstance</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>filter</span>: <span class=kt>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>keepAliveInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>entry</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>entry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>name</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>filter</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 被修剪的组件，会被组件卸载，在 cache 中也会被置为 null
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>pruneCacheEntry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span>: <span class=kt>CacheEntryMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>keys</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>current?</span>: <span class=kt>VNode</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>entry</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>entry</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>current</span> <span class=o>||</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>tag</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>entry</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>.</span><span class=nx>$destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>patternTypes</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Function</span><span class=p>&gt;</span> <span class=o>=</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>RegExp</span><span class=p>,</span> <span class=nb>Array</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1>// &lt;keep-alive :include=&#34;xxx&#34; :exclude=&#34;yyy&#34; :max=&#34;zzz&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>abstract</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// 抽象组件（在组件实例建立父子关系的时候会被忽略）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span>: <span class=kt>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exclude</span>: <span class=kt>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>max</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Number</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>methods</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 仅在 render 执行过后才执行（mounted/updated）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cacheVNode() {</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>vnodeToCache</span><span class=p>,</span> <span class=nx>keyToCache</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vnodeToCache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>tag</span><span class=p>,</span> <span class=nx>componentInstance</span><span class=p>,</span> <span class=nx>componentOptions</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vnodeToCache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 将 vnode 中的名称、tag、实例缓存起来
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cache</span><span class=p>[</span><span class=nx>keyToCache</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>name</span>: <span class=kt>getComponentName</span><span class=p>(</span><span class=nx>componentOptions</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>tag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>componentInstance</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=c1>// key 也要保存一份
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>keyToCache</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 清理老旧的缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span> <span class=o>&amp;&amp;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=nb>parseInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>keys</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 指向需要被缓存的 vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>vnodeToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>created() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>keys</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>destroyed() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 卸载的时候，清空缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 找到要删除的组件实例并调用 destory 钩子
</span></span></span><span class=line><span class=cl><span class=cm>       * 从缓存中删除 key 对应的缓存
</span></span></span><span class=line><span class=cl><span class=cm>       * 从 keys 中删除 key
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>keys</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>mounted() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cacheVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 监听黑白名单
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;include&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=o>=&gt;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;exclude&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>updated() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cacheVNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>render() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理默认插槽的第一个子组件
</span></span></span><span class=line><span class=cl><span class=cm>     * 所以常和 component 和 router-view 一起使用
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vnode</span>: <span class=kt>VNode</span> <span class=o>=</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span><span class=nx>slot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>componentOptions</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>componentOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 获取 VNode 对应的组件名称
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>name</span>: <span class=kt>?string</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>componentOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>include</span><span class=p>,</span> <span class=nx>exclude</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 组件名称不在白名单（include）内或者在黑名单（exclude）内
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>include</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>name</span> <span class=o>||</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>include</span><span class=p>,</span> <span class=nx>name</span><span class=p>)))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>exclude</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>exclude</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span> <span class=c1>// 直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 想办法拼凑一个独一无二的 key
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>componentOptions</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span> <span class=o>?</span> <span class=sb>`::</span><span class=si>${</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果命中缓存，VNode 的组件实例从缓存里取，并调整 key 的顺序（放在最后一个）
</span></span></span><span class=line><span class=cl><span class=cm>       * 调整 key 的原因是，keys[0] 对应的 key 一定是很久没用的缓存对应的 key
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>].</span><span class=nx>componentInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 没有缓存的话，设置缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>this</span><span class=p>.</span><span class=nx>vnodeToCache</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>keyToCache</span> <span class=o>=</span> <span class=nx>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 对于 KeepAlive 标识的组件，被缓存组件初次渲染时会走正常流程（因为 VNode.componentInstance 为空）
</span></span></span><span class=line><span class=cl><span class=cm>       * 当组件切换，命中缓存时；被缓存组件实例存在，会直接返回；不会执行 created、mounted 等钩子
</span></span></span><span class=line><span class=cl><span class=cm>       * 而是执行 activated，对应的也不会执行 destory，而是会执行 deactivate 钩子
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>keepAlive</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过插槽渲染组件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>vnode</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slot</span> <span class=o>&amp;&amp;</span> <span class=nx>slot</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>children?</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>VNode</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>children</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>c</span> <span class=o>=</span> <span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>componentOptions</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isAsyncPlaceholder</span><span class=p>(</span><span class=nx>c</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>isAsyncPlaceholder</span><span class=p>(</span><span class=nx>node</span>: <span class=kt>VNode</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// @ts-expect-error not really boolean type
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>node</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>&amp;&amp;</span> <span class=nx>node</span><span class=p>.</span><span class=nx>asyncFactory</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=keep-alive-3x>keep-alive 3.x</h2><p>实现 keep-alive 的关键 API 是 _KeepAlive；其缓存原则是“如果经常被访问，则能够快速命中；而不常被访问，则在不满足条件的情况下被释放”。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>type</span> <span class=nx>Cache</span> <span class=o>=</span> <span class=nx>Map</span><span class=p>&lt;</span><span class=nt>CacheKey</span><span class=err>,</span> <span class=na>VNode</span><span class=p>&gt;;</span> <span class=c1>// 缓存结构
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>type</span> <span class=nx>Keys</span> <span class=o>=</span> <span class=nx>Set</span><span class=p>&lt;</span><span class=nt>CacheKey</span><span class=p>&gt;;</span> <span class=c1>// 保存缓存 key 值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>KeepAliveImpl</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=sb>`KeepAlive`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 用于渲染器内部特殊处理的标记
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>__isKeepAlive</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>inheritRef</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>RegExp</span><span class=p>,</span> <span class=nb>Array</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>exclude</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>RegExp</span><span class=p>,</span> <span class=nb>Array</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>max</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Number</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>setup</span><span class=p>(</span><span class=nx>props</span>: <span class=kt>KeepAliveProps</span><span class=p>,</span> <span class=p>{</span> <span class=nx>slots</span> <span class=p>}</span><span class=o>:</span> <span class=nx>SetupContext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>getCurrentInstance</span><span class=p>()</span><span class=o>!</span><span class=p>;</span> <span class=c1>// 获取当前 KeepAlive 组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>parentSuspense</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>suspense</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>keys</span>: <span class=kt>Keys</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cache</span>: <span class=kt>Cache</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Map</span><span class=p>();</span> <span class=c1>// 缓存容器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>current</span>: <span class=kt>VNode</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * KeepAlive 通过在其内部传递 ctx 与实例化的渲染器通信
</span></span></span><span class=line><span class=cl><span class=cm>     * KeepAlive 实例公开 activate/deactivate 的实现
</span></span></span><span class=line><span class=cl><span class=cm>     * 这么做的目的就是避免在 renderer 直接引入 KeepAlive
</span></span></span><span class=line><span class=cl><span class=cm>     * 实现 tree-shaking
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>sharedContext</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>ctx</span> <span class=kr>as</span> <span class=nx>KeepAliveContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>renderer</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>p</span>: <span class=kt>patch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span>: <span class=kt>move</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>um</span>: <span class=kt>_unmount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>o</span><span class=o>:</span> <span class=p>{</span> <span class=nx>createElement</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=o>=</span> <span class=nx>sharedContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>storageContainer</span> <span class=o>=</span> <span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>);</span> <span class=c1>// 创建“隐藏容器”
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// KeepAlive 组件实例上，会被添加两个内部函数 activate &amp; deactivate
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sharedContext</span><span class=p>.</span><span class=nx>activate</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>isSVG</span><span class=p>,</span> <span class=nx>optimized</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>;</span> <span class=c1>// 获取组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>move</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>container</span><span class=p>,</span> <span class=nx>anchor</span><span class=p>,</span> <span class=nx>MoveType</span><span class=p>.</span><span class=nx>ENTER</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>patch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>container</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>anchor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>parentSuspense</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isSVG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>optimized</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>isDeactivated</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeArrayFns</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeMounted</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>vnodeHook</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>sharedContext</span><span class=p>.</span><span class=nx>deactivate</span> <span class=o>=</span> <span class=p>(</span><span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>instance</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 仅仅移动到 storageContainer，没有卸载
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>move</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>storageContainer</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>MoveType</span><span class=p>.</span><span class=nx>LEAVE</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>queuePostRenderEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>da</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeArrayFns</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>da</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>vnodeHook</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>onVnodeUnmounted</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>vnodeHook</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>invokeVNodeHook</span><span class=p>(</span><span class=nx>vnodeHook</span><span class=p>,</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>parent</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>instance</span><span class=p>.</span><span class=nx>isDeactivated</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>unmount</span><span class=p>(</span><span class=nx>vnode</span>: <span class=kt>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>resetShapeFlag</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>_unmount</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>parentSuspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 修剪缓存，可以传入一个过滤函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nx>pruneCache</span><span class=p>(</span><span class=nx>filter</span><span class=o>?:</span> <span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kr>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cache</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>filter</span> <span class=o>||</span> <span class=o>!</span><span class=nx>filter</span><span class=p>(</span><span class=nx>name</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>key</span>: <span class=kt>CacheKey</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>current</span> <span class=o>||</span> <span class=nx>cached</span><span class=p>.</span><span class=kr>type</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>unmount</span><span class=p>(</span><span class=nx>cached</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当前已激活的实例不再 kept-alive
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>resetShapeFlag</span><span class=p>(</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>cache</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>keys</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// prop 变化，对缓存进行修剪
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>watch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=nx>props</span><span class=p>.</span><span class=nx>include</span><span class=p>,</span> <span class=nx>props</span><span class=p>.</span><span class=nx>exclude</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=p>([</span><span class=nx>include</span><span class=p>,</span> <span class=nx>exclude</span><span class=p>])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 根据 include｜exclude 进行修剪
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>include</span> <span class=o>&amp;&amp;</span> <span class=nx>pruneCache</span><span class=p>(</span><span class=nx>name</span> <span class=o>=&gt;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>include</span><span class=p>,</span> <span class=nx>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>exclude</span> <span class=o>&amp;&amp;</span> <span class=nx>pruneCache</span><span class=p>(</span><span class=nx>name</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>exclude</span><span class=p>,</span> <span class=nx>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>flush</span><span class=o>:</span> <span class=s1>&#39;post&#39;</span><span class=p>,</span> <span class=nx>deep</span>: <span class=kt>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>pendingCacheKey</span>: <span class=kt>CacheKey</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cacheSubtree</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>pendingCacheKey</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cache</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>pendingCacheKey</span><span class=p>,</span> <span class=nx>getInnerChild</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>subTree</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 渲染/更新完成之后，缓存子树
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>onMounted</span><span class=p>(</span><span class=nx>cacheSubtree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>onUpdated</span><span class=p>(</span><span class=nx>cacheSubtree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>onBeforeUnmount</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cache</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>cached</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=p>{</span> <span class=nx>subTree</span><span class=p>,</span> <span class=nx>suspense</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>instance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>getInnerChild</span><span class=p>(</span><span class=nx>subTree</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>cached</span><span class=p>.</span><span class=kr>type</span> <span class=o>===</span> <span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>resetShapeFlag</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 触发 deactivated 钩子
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>da</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span><span class=o>!</span><span class=p>.</span><span class=nx>da</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>da</span> <span class=o>&amp;&amp;</span> <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>da</span><span class=p>,</span> <span class=nx>suspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>unmount</span><span class=p>(</span><span class=nx>cached</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// KeepAlive 的渲染函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pendingCacheKey</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>slots</span><span class=p>.</span><span class=k>default</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通过默认插槽，拿到 KeepAlive 包裹的组件
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>slots</span><span class=p>.</span><span class=k>default</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=c1>// KeepAlive 是抽象组件，它本身不渲染成实体节点，而是渲染它的第一个子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>rawVNode</span> <span class=o>=</span> <span class=nx>children</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>children</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;KeepAlive 应该只包含一个子组件&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>current</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=nx>isVNode</span><span class=p>(</span><span class=nx>rawVNode</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>rawVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>STATEFUL_COMPONENT</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>          <span class=o>!</span><span class=p>(</span><span class=nx>rawVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果不是 vnode｜不是状态组件｜不是 SUSPENSE，直接渲染
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>current</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>rawVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>getInnerChild</span><span class=p>(</span><span class=nx>rawVNode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>comp</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=kr>type</span> <span class=kr>as</span> <span class=nx>ConcreteComponent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>comp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 缓存控制
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>include</span><span class=p>,</span> <span class=nx>exclude</span><span class=p>,</span> <span class=nx>max</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>include</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>name</span> <span class=o>||</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>include</span><span class=p>,</span> <span class=nx>name</span><span class=p>)))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>exclude</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>exclude</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>current</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>rawVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=nx>comp</span> : <span class=kt>vnode.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 获取缓存的 vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>cachedVNode</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果重复使用 VNode，则克隆它；因为我们将对其进行修改
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>rawVNode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>rawVNode</span><span class=p>.</span><span class=nx>ssContent</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>pendingCacheKey</span> <span class=o>=</span> <span class=nx>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cachedVNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 缓存存在，使用缓存的内容
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>cachedVNode</span><span class=p>.</span><span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>component</span> <span class=o>=</span> <span class=nx>cachedVNode</span><span class=p>.</span><span class=nx>component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>transition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>setTransitionHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>transition</span><span class=o>!</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 避免 VNode 节点作为新节点被挂载，并打上 KEPT_ALIVE
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>|=</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT_KEPT_ALIVE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 删除再添加，是为更新缓存位置（当缓存满的时候，会卸载最老的组件）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>keys</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 缓存不存在
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>keys</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 舍弃最早的缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>max</span> <span class=o>&amp;&amp;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>size</span> <span class=o>&gt;</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>max</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>keys</span><span class=p>.</span><span class=nx>values</span><span class=p>().</span><span class=nx>next</span><span class=p>().</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 避免 VNode 被卸载，给组件打上 COMPONENT_SHOULD_KEEP_ALIVE
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>|=</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT_SHOULD_KEEP_ALIVE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>current</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>rawVNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>KeepAlive</span> <span class=o>=</span> <span class=nx>KeepAliveImpl</span> <span class=kr>as</span> <span class=kt>any</span> <span class=kr>as</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>__isKeepAlive</span>: <span class=kt>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=p>()</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>$props</span>: <span class=kt>VNodeProps</span> <span class=o>&amp;</span> <span class=nx>KeepAliveProps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=nexttick-2x>nextTick 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$nextTick</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>nextTick</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>nextTick</span> <span class=o>=</span> <span class=nx>nextTick</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>callbacks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>pending</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>timerFunc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 执行 callbacks 里所有的回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>flushCallbacks() {</span>
</span></span><span class=line><span class=cl>  <span class=nx>pending</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>copies</span> <span class=o>=</span> <span class=nx>callbacks</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>callbacks</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>copies</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>copies</span><span class=p>[</span><span class=nx>i</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>Promise</span> <span class=o>!==</span> <span class=s1>&#39;undefined&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isNative</span><span class=p>(</span><span class=nx>Promise</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 Promise
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>p</span> <span class=o>=</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>timerFunc</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>flushCallbacks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isIOS</span><span class=p>)</span> <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>noop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>isUsingMicroTask</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=o>!</span><span class=nx>isIE</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>  <span class=k>typeof</span> <span class=nx>MutationObserver</span> <span class=o>!==</span> <span class=s1>&#39;undefined&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nx>isNative</span><span class=p>(</span><span class=nx>MutationObserver</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>    <span class=nx>MutationObserver</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span> <span class=o>===</span> <span class=s1>&#39;[object MutationObserverConstructor]&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 MutationObserver
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>counter</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>observer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MutationObserver</span><span class=p>(</span><span class=nx>flushCallbacks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>textNode</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createTextNode</span><span class=p>(</span><span class=nb>String</span><span class=p>(</span><span class=nx>counter</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nx>observer</span><span class=p>.</span><span class=nx>observe</span><span class=p>(</span><span class=nx>textNode</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>characterData</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>timerFunc</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>counter</span> <span class=o>=</span> <span class=p>(</span><span class=nx>counter</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>textNode</span><span class=p>.</span><span class=nx>data</span> <span class=o>=</span> <span class=nb>String</span><span class=p>(</span><span class=nx>counter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>isUsingMicroTask</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>setImmediate</span> <span class=o>!==</span> <span class=s1>&#39;undefined&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>isNative</span><span class=p>(</span><span class=nx>setImmediate</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 setImmediate
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>timerFunc</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setImmediate</span><span class=p>(</span><span class=nx>flushCallbacks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 使用 setTimeout
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>timerFunc</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>flushCallbacks</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * $nextTick 有三种调用方式：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. $nextTick(cb)
</span></span></span><span class=line><span class=cl><span class=cm> * 2. $nextTick.then(cb)
</span></span></span><span class=line><span class=cl><span class=cm> * 3. async $nextTick()
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>nextTick</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>_resolve</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>callbacks</span><span class=p>.</span><span class=nx>push</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=s1>&#39;nextTick&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>_resolve</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// _resolve 将 ctx 传递给 then 里边的 cb
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>_resolve</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>pending</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pending</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * timerFunc 有四种运行 flushCallbacks 的方式：
</span></span></span><span class=line><span class=cl><span class=cm>     * 1. Promise（微任务）
</span></span></span><span class=line><span class=cl><span class=cm>     * 2. MutationObserver（微任务）
</span></span></span><span class=line><span class=cl><span class=cm>     * 3. setImmediate（宏任务）
</span></span></span><span class=line><span class=cl><span class=cm>     * 4. setTimeout（宏任务）
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>timerFunc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>cb</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>Promise</span> <span class=o>!==</span> <span class=s1>&#39;undefined&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 当调用 _resolve 时，会走 then(cb)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>_resolve</span> <span class=o>=</span> <span class=nx>resolve</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=nexttick-3x>nextTick 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>resolvedPromise</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>currentFlushPromise</span>: <span class=kt>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// nextTick 的实现就是 Promise
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>nextTick</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>:</span> <span class=nx>ComponentPublicInstance</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>fn</span><span class=o>?:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>p</span> <span class=o>=</span> <span class=nx>currentFlushPromise</span> <span class=o>||</span> <span class=nx>resolvedPromise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>fn</span> <span class=o>?</span> <span class=nx>p</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=k>this</span> <span class=o>?</span> <span class=nx>fn</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=o>:</span> <span class=nx>fn</span><span class=p>)</span> <span class=o>:</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=vnode-2x>vnode 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 调用场景：
</span></span></span><span class=line><span class=cl><span class=cm> * 1. createComponent 中 new VNode(...)
</span></span></span><span class=line><span class=cl><span class=cm> * 2. _createElement 中
</span></span></span><span class=line><span class=cl><span class=cm> *      如果是注册的组件，调用 createComponent
</span></span></span><span class=line><span class=cl><span class=cm> *      如果是 HTML 元素，new VNode(...)
</span></span></span><span class=line><span class=cl><span class=cm> *      如果是未知元素，new VNode(...)
</span></span></span><span class=line><span class=cl><span class=cm> * 3. 创建空节点，emptyNode = new VNode(&#39;&#39;, {}, [])
</span></span></span><span class=line><span class=cl><span class=cm> * 4. 创建文本节点，new VNode(undefined, undefined, undefined, String(val))
</span></span></span><span class=line><span class=cl><span class=cm> * 5. cloneVNode，源码就在下面
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>elm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>componentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>tag</span> <span class=o>=</span> <span class=nx>tag</span><span class=p>;</span> <span class=c1>// `vue-component-${Ctor.cid}${name ? `-${name}` : &#39;&#39;}`,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>children</span> <span class=o>=</span> <span class=nx>children</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>elm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ns</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// 命名空间
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>context</span> <span class=o>=</span> <span class=nx>context</span><span class=p>;</span> <span class=c1>// 渲染组件的作用域
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>fnContext</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// 函数节点的上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>fnOptions</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// SSR 缓存相关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>fnScopeId</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// 函数作用域 ID 支持
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>key</span> <span class=o>=</span> <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>componentOptions</span> <span class=o>=</span> <span class=nx>componentOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// 组件实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * vm.$options.parent：子组件渲染执行 vm.__patch__ 时当前活跃的组件实例，也就是子组件实例的父组件实例
</span></span></span><span class=line><span class=cl><span class=cm>     * vm.$parent：组件实例的第一个“非抽象”的父组件实例
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>parent</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span> <span class=c1>// 组件占位 vnode，不会出现在 DOM
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>raw</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否包含原生 HTML？
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>isStatic</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否是静态提升节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>isRootInsert</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 进入 transition 检查所必需的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否是空的注释占位符？
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>isCloned</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否是克隆节点？
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>isOnce</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 是否是 v-once 节点？
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>asyncFactory</span> <span class=o>=</span> <span class=nx>asyncFactory</span><span class=p>;</span> <span class=c1>// 异步组件工厂函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>asyncMeta</span> <span class=o>=</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>isAsyncPlaceholder</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建空白 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createEmptyVNode</span> <span class=o>=</span> <span class=p>(</span><span class=nx>text</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>node</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>node</span><span class=p>.</span><span class=nx>text</span> <span class=o>=</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>node</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>node</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// 创建文本 VNode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createTextVNode</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span><span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nb>String</span><span class=p>(</span><span class=nx>val</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 适用于静态节点和插槽节点，因为他们可能被多个 render 重用
</span></span></span><span class=line><span class=cl><span class=cm> * 当 DOM 操作依赖它们的 elm 引用时，克隆它们可以避免错误
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cloned</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>tag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span><span class=p>.</span><span class=nx>slice</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>ns</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>isStatic</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>isStatic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>key</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>isComment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>fnContext</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>fnContext</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>fnOptions</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>fnOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>fnScopeId</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>fnScopeId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>asyncMeta</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>asyncMeta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cloned</span><span class=p>.</span><span class=nx>isCloned</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>cloned</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=vnode-3x>vnode 3.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>function</span> <span class=nx>_createVNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>VNodeTypes</span> <span class=o>|</span> <span class=nx>ClassComponent</span> <span class=o>|</span> <span class=k>typeof</span> <span class=nx>NULL_DYNAMIC_COMPONENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>(</span><span class=nx>Data</span> <span class=o>&amp;</span> <span class=nx>VNodeProps</span><span class=p>)</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>unknown</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>patchFlag</span>: <span class=kt>number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=c1>// 补丁标志
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dynamicProps</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isBlockNode</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=kr>type</span> <span class=o>||</span> <span class=kr>type</span> <span class=o>===</span> <span class=nx>NULL_DYNAMIC_COMPONENT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span> <span class=o>=</span> <span class=nx>Comment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isVNode</span><span class=p>(</span><span class=kr>type</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cloned</span> <span class=o>=</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=kr>type</span><span class=p>,</span> <span class=nx>props</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* mergeRef: true */</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>children</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>normalizeChildren</span><span class=p>(</span><span class=nx>cloned</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>cloned</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isClassComponent</span><span class=p>(</span><span class=kr>type</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span> <span class=o>=</span> <span class=kr>type</span><span class=p>.</span><span class=nx>__vccOpts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>__COMPAT__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span> <span class=o>=</span> <span class=nx>convertLegacyComponent</span><span class=p>(</span><span class=kr>type</span><span class=p>,</span> <span class=nx>currentRenderingInstance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>props</span> <span class=o>=</span> <span class=nx>guardReactiveProps</span><span class=p>(</span><span class=nx>props</span><span class=p>)</span><span class=o>!</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=p>{</span> <span class=kr>class</span><span class=o>:</span> <span class=nx>klass</span><span class=p>,</span> <span class=nx>style</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>klass</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isString</span><span class=p>(</span><span class=nx>klass</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 处理 template 中的 class 的特殊写法（字符串、数组、对象）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>props</span><span class=p>.</span><span class=kr>class</span> <span class=o>=</span> <span class=nx>normalizeClass</span><span class=p>(</span><span class=nx>klass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>style</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isProxy</span><span class=p>(</span><span class=nx>style</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>style</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>style</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({},</span> <span class=nx>style</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>props</span><span class=p>.</span><span class=nx>style</span> <span class=o>=</span> <span class=nx>normalizeStyle</span><span class=p>(</span><span class=nx>style</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>shapeFlag</span> <span class=o>=</span> <span class=nx>isString</span><span class=p>(</span><span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>ShapeFlags.ELEMENT</span>
</span></span><span class=line><span class=cl>    : <span class=kt>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>isSuspense</span><span class=p>(</span><span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>ShapeFlags.SUSPENSE</span>
</span></span><span class=line><span class=cl>    : <span class=kt>isTeleport</span><span class=p>(</span><span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>ShapeFlags.TELEPORT</span>
</span></span><span class=line><span class=cl>    : <span class=kt>isObject</span><span class=p>(</span><span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>ShapeFlags.STATEFUL_COMPONENT</span>
</span></span><span class=line><span class=cl>    : <span class=kt>isFunction</span><span class=p>(</span><span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>ShapeFlags.FUNCTIONAL_COMPONENT</span>
</span></span><span class=line><span class=cl>    : <span class=kt>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>createBaseVNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>props</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>patchFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>dynamicProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>shapeFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isBlockNode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createBaseVNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kr>type</span><span class=o>:</span> <span class=nx>VNodeTypes</span> <span class=o>|</span> <span class=nx>ClassComponent</span> <span class=o>|</span> <span class=k>typeof</span> <span class=nx>NULL_DYNAMIC_COMPONENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>(</span><span class=nx>Data</span> <span class=o>&amp;</span> <span class=nx>VNodeProps</span><span class=p>)</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>unknown</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>patchFlag</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>dynamicProps</span>: <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>null</span> <span class=o>=</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>shapeFlag</span> <span class=o>=</span> <span class=kr>type</span> <span class=o>===</span> <span class=nx>Fragment</span> <span class=o>?</span> <span class=nx>0</span> : <span class=kt>ShapeFlags.ELEMENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isBlockNode</span> <span class=o>=</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>needFullChildrenNormalization</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>__v_isVNode</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>__v_skip</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/***
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是普通标签，值为字符串
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是组件实例，值为组件配置（对象）
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是注释节点，使用 Symbol 代指
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是代码片段，值为 Fragment，使用 Symbol 代指
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>props</span><span class=p>,</span> <span class=c1>// 属性值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>key</span>: <span class=kt>props</span> <span class=o>&amp;&amp;</span> <span class=nx>normalizeKey</span><span class=p>(</span><span class=nx>props</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>ref</span>: <span class=kt>props</span> <span class=o>&amp;&amp;</span> <span class=nx>normalizeRef</span><span class=p>(</span><span class=nx>props</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>scopeId</span>: <span class=kt>currentScopeId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>slotScopeIds</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>component</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>suspense</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ssContent</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ssFallback</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>dirs</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>transition</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>anchor</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>targetAnchor</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>staticCount</span>: <span class=kt>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>shapeFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 只要存在，就认为有当前节点为动态节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>patchFlag</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>dynamicProps</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用来保存动态子节点，带有该属性的虚拟节点成为 Block
</span></span></span><span class=line><span class=cl><span class=cm>     * 一个 Block 不仅能够收集自身的动态子节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 而且能够收集多有的动态“子代”节点，以及子 Block 节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 当渲染器在更新一个 Block 时，会忽略 vnode 的 children，只更新动态节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 所有模版的根节点都会是一个 Block 节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 任何带有 v-for|v-if|v-else-if|v-else 等结构性指令的节点都可以作为 Block 节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 因为收集 dynamicChildren 的过程中，是忽略节点层级的，所以需要使用结构化指令的节点也作为 Block 节点
</span></span></span><span class=line><span class=cl><span class=cm>     * 并且，这样可以使 dynamicChildren 结构稳定（数量和顺序一致）
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果更新前后 dynamicChildren 结构不稳定，就没办法 patchBlockChildren
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;template&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;div alt=&#39;这个 div 是一个 Block&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *    &lt;p alt=&#34;这个 p 不是一个 Block，因为它不是根节点&#34;&gt;{{ bar }}&lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;/div&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;h1 alt=&#39;这个 h1 是一个 Block&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *    &lt;span :id=&#34;dynamicId&#34; alt=&#34;这个 span 不是一个 Block，因为它不是根节点&#34;&gt;&lt;/span&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *  &lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;/template&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 在 render 递归调用 createVNode 时，会为维护一个 dynamicChildrenStack 的栈
</span></span></span><span class=line><span class=cl><span class=cm>     * 当调用 openBlock 时，dynamicChildrenStack 会被 push 进一个 currentDynamicChildren 的数组
</span></span></span><span class=line><span class=cl><span class=cm>     * 遇到 patchFlag 不为 undefined 的 vnode 会被 push 进这个 currentDynamicChildren 数组
</span></span></span><span class=line><span class=cl><span class=cm>     * 当调用 closeBlock 时，currentDynamicChildren 会从 dynamicChildrenStack 弹出
</span></span></span><span class=line><span class=cl><span class=cm>     * 此时，当前 Block 的子代动态节点都被收集在 currentDynamicChildren 中
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>dynamicChildren</span>: <span class=kt>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>appContext</span>: <span class=kt>null</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=kr>as</span> <span class=nx>VNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>needFullChildrenNormalization</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>normalizeChildren</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>children</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>__FEATURE_SUSPENSE__</span> <span class=o>&amp;&amp;</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>SUSPENSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kr>type</span> <span class=kr>as</span> <span class=k>typeof</span> <span class=nx>SuspenseImpl</span><span class=p>).</span><span class=nx>normalize</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>children</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>shapeFlag</span> <span class=o>|=</span> <span class=nx>isString</span><span class=p>(</span><span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>ShapeFlags.TEXT_CHILDREN</span>
</span></span><span class=line><span class=cl>      : <span class=kt>ShapeFlags.ARRAY_CHILDREN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>isBlockTreeEnabled</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isBlockNode</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentBlock</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>patchFlag</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>shapeFlag</span> <span class=o>&amp;</span> <span class=nx>ShapeFlags</span><span class=p>.</span><span class=nx>COMPONENT</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>patchFlag</span> <span class=o>!==</span> <span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>HYDRATE_EVENTS</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentBlock</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>__COMPAT__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>convertLegacyVModelProps</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>convertLegacyRefInFor</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>defineLegacyVNodeProperties</span><span class=p>(</span><span class=nx>vnode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>shouldSetAsProp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span>: <span class=kt>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span>: <span class=kt>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span>: <span class=kt>unknown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>isSVG</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isSVG</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 除了 innerHTML，其他属性都作为 HTMLAttr 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;innerHTML&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=c1>// 如果是事件绑定，作为 DOMProp 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>nativeOnRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * pellcheck 和 draggable 是枚举属性，但是它们对应的 DOM 属性实际上是布尔值
</span></span></span><span class=line><span class=cl><span class=cm>   * 这会导致将其设置为字符串 false，导致其被强制为 true
</span></span></span><span class=line><span class=cl><span class=cm>   * contentEditable 没有这个问题
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;spellcheck&#39;</span> <span class=o>||</span> <span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;draggable&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// form 属性是只读属性，应当作 HTMLAttr 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;form&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// &lt;input list&gt; list 属性应当作 HTMLAttr 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;list&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>el</span><span class=p>.</span><span class=nx>tagName</span> <span class=o>===</span> <span class=s1>&#39;INPUT&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// &lt;textarea type&gt; type 属性应当作 HTMLAttr 处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=o>===</span> <span class=s1>&#39;type&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>el</span><span class=p>.</span><span class=nx>tagName</span> <span class=o>===</span> <span class=s1>&#39;TEXTAREA&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// onclick=&#39;handleClick&#39; onxxx 属性应当作 HTMLAttr 处理，如果 value 为字符串的话
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>nativeOnRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isString</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=kr>enum</span> <span class=nx>PatchFlags</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>TEXT</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=c1>// 表示具有动态 textContent 的元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>CLASS</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>,</span> <span class=c1>// 表示具有动态 class 的元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 表示具有动态 style 的元素
</span></span></span><span class=line><span class=cl><span class=cm>   * style=&#34;color: red&#34;
</span></span></span><span class=line><span class=cl><span class=cm>   * :style=&#34;{ color: &#39;red&#39; }&#34;
</span></span></span><span class=line><span class=cl><span class=cm>   * 都会被提升为
</span></span></span><span class=line><span class=cl><span class=cm>   * const style = { color: &#39;red&#39; }
</span></span></span><span class=line><span class=cl><span class=cm>   * render() { return e(&#39;div&#39;, { style }) }
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>STYLE</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 表示具有动态 props（非 class/style）的元素
</span></span></span><span class=line><span class=cl><span class=cm>   * 也可表示具有动态 props（包含 class/style）的组件
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>PROPS</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 表示具有动态 keys 的元素
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要做完整 diff
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>FULL_PROPS</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HYDRATE_EVENTS</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>5</span><span class=p>,</span> <span class=c1>// 表示绑定了事件监听的元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>STABLE_FRAGMENT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>6</span><span class=p>,</span> <span class=c1>// 表示 children 不变的 Frangment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>KEYED_FRAGMENT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>7</span><span class=p>,</span> <span class=c1>// 表示 children 有 key 的 Frangment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>UNKEYED_FRAGMENT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>,</span> <span class=c1>// 表示 children 没有 key 的 Frangment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>NEED_PATCH</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>9</span><span class=p>,</span> <span class=c1>// 需要对非 props 之外的属性（ref/directive）进行 patch 的元素
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 表示具有动态插槽的组件
</span></span></span><span class=line><span class=cl><span class=cm>   * 例如：动态插槽名/引用 v-for 迭代值的插槽
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>DYNAMIC_SLOTS</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>DEV_ROOT_FRAGMENT</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>11</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=cm>/*************特殊 FLAGS：值为负数；不会参与位运算；只参与 patchFlag === FLAG 比较***************/</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 表示一个静态提升的 vnode，永远不会更新/变化
</span></span></span><span class=line><span class=cl><span class=cm>   * 静态提升：将静态 vnode 保存在渲染函数之外
</span></span></span><span class=line><span class=cl><span class=cm>   * 函数内部，只保留对静态节点的引用
</span></span></span><span class=line><span class=cl><span class=cm>   * 减少更新时，创建 vnode 的开销
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>HOISTED</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BAIL</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span> <span class=c1>// 退出 diff 算法优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>PatchFlagNames</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>TEXT</span><span class=p>]</span><span class=o>:</span> <span class=sb>`TEXT`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>CLASS</span><span class=p>]</span><span class=o>:</span> <span class=sb>`CLASS`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>STYLE</span><span class=p>]</span><span class=o>:</span> <span class=sb>`STYLE`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>PROPS</span><span class=p>]</span><span class=o>:</span> <span class=sb>`PROPS`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>FULL_PROPS</span><span class=p>]</span><span class=o>:</span> <span class=sb>`FULL_PROPS`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>HYDRATE_EVENTS</span><span class=p>]</span><span class=o>:</span> <span class=sb>`HYDRATE_EVENTS`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>STABLE_FRAGMENT</span><span class=p>]</span><span class=o>:</span> <span class=sb>`STABLE_FRAGMENT`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>KEYED_FRAGMENT</span><span class=p>]</span><span class=o>:</span> <span class=sb>`KEYED_FRAGMENT`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>UNKEYED_FRAGMENT</span><span class=p>]</span><span class=o>:</span> <span class=sb>`UNKEYED_FRAGMENT`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>NEED_PATCH</span><span class=p>]</span><span class=o>:</span> <span class=sb>`NEED_PATCH`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>DYNAMIC_SLOTS</span><span class=p>]</span><span class=o>:</span> <span class=sb>`DYNAMIC_SLOTS`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>DEV_ROOT_FRAGMENT</span><span class=p>]</span><span class=o>:</span> <span class=sb>`DEV_ROOT_FRAGMENT`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>HOISTED</span><span class=p>]</span><span class=o>:</span> <span class=sb>`HOISTED`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>PatchFlags</span><span class=p>.</span><span class=nx>BAIL</span><span class=p>]</span><span class=o>:</span> <span class=sb>`BAIL`</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=watch-2x>watch 2.x</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 在 initState 的过程中会判断组件 options 有没有 watch 要处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initState</span><span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>&amp;&amp;</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>!==</span> <span class=nx>nativeWatch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>initWatch</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>initWatch</span><span class=p>(</span><span class=nx>vm</span>: <span class=kt>Component</span><span class=p>,</span> <span class=nx>watch</span>: <span class=kt>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>watch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>handler</span> <span class=o>=</span> <span class=nx>watch</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果对一个 getter 注册了多个 watcher，这些 watcher 的 handler 会拼成一个数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>handler</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>handler</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 循环创建 watcher
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>createWatcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>handler</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>createWatcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>handler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createWatcher</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span>: <span class=kt>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>expOrFn</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>handler</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options?</span>: <span class=kt>Object</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// {..., handler, ...}
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>handler</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span> <span class=o>=</span> <span class=nx>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>handler</span> <span class=o>=</span> <span class=nx>handler</span><span class=p>.</span><span class=nx>handler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 去 methods 找 handler
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>handler</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>handler</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>[</span><span class=nx>handler</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 this.$watch
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=nx>expOrFn</span><span class=p>,</span> <span class=nx>handler</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>stateMixin</span><span class=p>(</span><span class=nx>Vue</span>: <span class=kt>Class</span><span class=p>&lt;</span><span class=nt>Component</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$watch</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>expOrFn</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cb</span>: <span class=kt>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options?</span>: <span class=kt>Object</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span>: <span class=kt>Component</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>cb</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>createWatcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>expOrFn</span><span class=p>,</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span> <span class=o>=</span> <span class=nx>options</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// this.$watch 这种调用方式的 user 均为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>watcher</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>expOrFn</span><span class=p>,</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>immediate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 通过 watcher.value 立即执行一次求值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=sb>`callback for immediate watcher &#34;</span><span class=si>${</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>pushTarget</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>invokeWithErrorHandling</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=p>[</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>value</span><span class=p>],</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>popTarget</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>function</span> <span class=nx>unwatchFn() {</span>
</span></span><span class=line><span class=cl>      <span class=nx>watcher</span><span class=p>.</span><span class=nx>teardown</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=watch-3x>watch 3.x</h2><p>watch 需要侦听特定的数据源，并在单独的回调函数中（惰性）执行副作用；watchEffect 立即执行传入的一个函数，同时响应式追踪其依赖，并在其依赖变更时重新运行该函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// watchers 在未定义初始值时触发的初始值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>INITIAL_WATCHER_VALUE</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>WatchOptionsBase</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>flush</span><span class=o>?:</span> <span class=s1>&#39;pre&#39;</span> <span class=o>|</span> <span class=s1>&#39;post&#39;</span> <span class=o>|</span> <span class=s1>&#39;sync&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>onTrack?</span>: <span class=kt>ReactiveEffectOptions</span><span class=p>[</span><span class=s1>&#39;onTrack&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=nx>onTrigger?</span>: <span class=kt>ReactiveEffectOptions</span><span class=p>[</span><span class=s1>&#39;onTrigger&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * watchEffect((onInvalidate) =&gt; {...}, {...})
</span></span></span><span class=line><span class=cl><span class=cm> * Vue 会自动追踪 fn 依赖 instance 中的数据
</span></span></span><span class=line><span class=cl><span class=cm> * 也就是自动生成 getter（需要先运行一次）
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>watchEffect</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>doWatch</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * watch(() =&gt; state.count, (count, prevCount, onInvalidate) =&gt; {...}, {...})
</span></span></span><span class=line><span class=cl><span class=cm> * 1. 懒执行副作用；
</span></span></span><span class=line><span class=cl><span class=cm> * 2. 更具体地说明什么状态应该触发侦听器重新运行；
</span></span></span><span class=line><span class=cl><span class=cm> * 3. 访问侦听状态变化前后的值。
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>watch</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>doWatch</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>cb</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// vm.$watch 背后也是 doWatch
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>instanceWatch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=o>:</span> <span class=nx>ComponentInternalInstance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span>: <span class=kt>string</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span>: <span class=kt>WatchCallback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options?</span>: <span class=kt>WatchOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>WatchStopHandle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>publicThis</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>proxy</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>getter</span> <span class=o>=</span> <span class=nx>isString</span><span class=p>(</span><span class=nx>source</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>publicThis</span><span class=p>[</span><span class=nx>source</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=nx>source</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>publicThis</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>doWatch</span><span class=p>(</span><span class=nx>getter</span><span class=p>,</span> <span class=nx>cb</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>publicThis</span><span class=p>),</span> <span class=nx>options</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 最终实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>doWatch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=nx>immediate</span><span class=p>,</span> <span class=nx>deep</span><span class=p>,</span> <span class=nx>flush</span><span class=p>,</span> <span class=nx>onTrack</span><span class=p>,</span> <span class=nx>onTrigger</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance</span> <span class=o>=</span> <span class=nx>currentInstance</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这也说明 watchEffect 默认就是 immediate&amp;deep
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>immediate</span> <span class=o>!==</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;只有 watch(source, callback, options?) 才支持 immediate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>deep</span> <span class=o>!==</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;只有 watch(source, callback, options?) 才支持 deep&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>getter</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>forceTrigger</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 根据不同的 source，生成不同的 getter，用于触发 Proxy 的拦截器，进行依赖收集
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 source 为 ref，自动展开
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>source</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>forceTrigger</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>source</span><span class=p>.</span><span class=nx>_shallow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isReactive</span><span class=p>(</span><span class=nx>source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 source 为 reactive，自动 deep
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>deep</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果 source 为数组，对每一项做处理并返回数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>s</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isRef</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isReactive</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>traverse</span><span class=p>(</span><span class=nx>s</span><span class=p>);</span> <span class=c1>// 递归读取
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>callWithErrorHandling</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>WATCH_GETTER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>source</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 属于 watch
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>callWithErrorHandling</span><span class=p>(</span><span class=nx>source</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>WATCH_GETTER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 属于 watchEffect
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span> <span class=o>&amp;&amp;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>isUnmounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span> <span class=c1>// 实例都卸载了，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>cleanup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>cleanup</span><span class=p>();</span> <span class=c1>// 运行 source 之前，运行清理函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 运行 source 收集依赖；先清理再收集
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>callWithErrorHandling</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>source</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>WATCH_CALLBACK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>[</span><span class=nx>onInvalidate</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span> <span class=o>=</span> <span class=nx>NOOP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span> <span class=o>&amp;&amp;</span> <span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * watchEffect：深度遍历 getter 运行时访问的值
</span></span></span><span class=line><span class=cl><span class=cm>     * 重新生成 watchEffectGetter
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>baseGetter</span> <span class=o>=</span> <span class=nx>getter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>getter</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>traverse</span><span class=p>(</span><span class=nx>baseGetter</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>cleanup</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 清理副作用的回调会在该副作用下一次执行前被调用
</span></span></span><span class=line><span class=cl><span class=cm>   * onInvalidate 接收的函数，被指向了 cleanup
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>onInvalidate</span>: <span class=kt>InvalidateCbRegistrator</span> <span class=o>=</span> <span class=p>(</span><span class=nx>fn</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cleanup</span> <span class=o>=</span> <span class=nx>runner</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>onStop</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>callWithErrorHandling</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>WATCH_CLEANUP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 初始值是：[] 或 {}
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=nx>isArray</span><span class=p>(</span><span class=nx>source</span><span class=p>)</span> <span class=o>?</span> <span class=p>[]</span> <span class=o>:</span> <span class=nx>INITIAL_WATCHER_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 被 scheduler 控制执行的 job
</span></span></span><span class=line><span class=cl><span class=cm>   * 对于 watch 来说，先运行 runner 获得 newValue，判断和 oldValue 是否相等，在调用 cb
</span></span></span><span class=line><span class=cl><span class=cm>   * 对于 watchEffect，直接运行 runner 即可（拿不到 oldValue）
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>job</span>: <span class=kt>SchedulerJob</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>runner</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// job 在运行期间，重新求最新值并执行回调
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>newValue</span> <span class=o>=</span> <span class=nx>runner</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>deep</span> <span class=o>||</span> <span class=nx>forceTrigger</span> <span class=o>||</span> <span class=nx>hasChanged</span><span class=p>(</span><span class=nx>newValue</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 执行 cb 之前，先清除上一次运行 cb 的“副作用”
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>cleanup</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// cleanup = runner.options.onStop = () =&gt; {...}
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>cleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * cb 的三个入参：
</span></span></span><span class=line><span class=cl><span class=cm>         * watch(id, async (newId, oldId, onCleanup) =&gt; {
</span></span></span><span class=line><span class=cl><span class=cm>         *    const { response, cancel } = doAsyncWork(newId)
</span></span></span><span class=line><span class=cl><span class=cm>         *    onCleanup(cancel)
</span></span></span><span class=line><span class=cl><span class=cm>         *    data.value = await response
</span></span></span><span class=line><span class=cl><span class=cm>         * }
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>callWithAsyncErrorHandling</span><span class=p>(</span><span class=nx>cb</span><span class=p>,</span> <span class=nx>instance</span><span class=p>,</span> <span class=nx>ErrorCodes</span><span class=p>.</span><span class=nx>WATCH_CALLBACK</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=nx>newValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>oldValue</span> <span class=o>===</span> <span class=nx>INITIAL_WATCHER_VALUE</span> <span class=o>?</span> <span class=kc>undefined</span> <span class=o>:</span> <span class=nx>oldValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>onInvalidate</span>
</span></span><span class=line><span class=cl>        <span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldValue</span> <span class=o>=</span> <span class=nx>newValue</span><span class=p>;</span> <span class=c1>// 新值变旧值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>runner</span><span class=p>();</span> <span class=c1>// watchEffect 要执行的副作用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果存在 cb，将 allowRecurse 置为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>job</span><span class=p>.</span><span class=nx>allowRecurse</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>cb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * watch 的 flush 选项：
</span></span></span><span class=line><span class=cl><span class=cm>   * 1. pre，默认值，回调应该在渲染前被调用，允许回调在模板运行前更新了其他值，回调缓存在 preFlushCbs
</span></span></span><span class=line><span class=cl><span class=cm>   * 2. post，将回调推迟到渲染之后的，回调缓存在 postFlushCbs
</span></span></span><span class=line><span class=cl><span class=cm>   * 3. sync，一旦值发生了变化，回调将被同步调用
</span></span></span><span class=line><span class=cl><span class=cm>   * 除了 computed，render/watch 的 effect 的初次运行发生在初次依赖收集阶段
</span></span></span><span class=line><span class=cl><span class=cm>   * 一旦 effect 与响应式数据建立了联系之后，effect 的运行，都是由 scheduler 进行调用的（开启任务队列）
</span></span></span><span class=line><span class=cl><span class=cm>   * watch 正是利用了 scheduler 来运行 callback 回调
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>scheduler</span>: <span class=kt>ReactiveEffectOptions</span><span class=p>[</span><span class=s1>&#39;scheduler&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>flush</span> <span class=o>===</span> <span class=s1>&#39;sync&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>scheduler</span> <span class=o>=</span> <span class=nx>job</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>flush</span> <span class=o>===</span> <span class=s1>&#39;post&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// flush:post，默认值，job 会在微任务队列里 render 之后调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>scheduler</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>job</span><span class=p>,</span> <span class=nx>instance</span> <span class=o>&amp;&amp;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>suspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// flush:pre，job 会在 render 之前调用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>scheduler</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>instance</span> <span class=o>||</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果实例不存在或者实例已经挂载
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>queuePreFlushCb</span><span class=p>(</span><span class=nx>job</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 实例存在但是还没挂载，同步执行就好
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>job</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 经过上边的流程，确定了 getter、scheduler
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>runner</span> <span class=o>=</span> <span class=nx>effect</span><span class=p>(</span><span class=nx>getter</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建一个懒执行的 effect
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>lazy</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onTrack</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>onTrigger</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>scheduler</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>effects</span> <span class=o>||</span> <span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>effects</span> <span class=o>=</span> <span class=p>[])).</span><span class=nx>push</span><span class=p>(</span><span class=nx>runner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>immediate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>job</span><span class=p>();</span> <span class=c1>// 创建 watch 的时候，立即执行一次
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>oldValue</span> <span class=o>=</span> <span class=nx>runner</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>flush</span> <span class=o>===</span> <span class=s1>&#39;post&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>queuePostRenderEffect</span><span class=p>(</span><span class=nx>runner</span><span class=p>,</span> <span class=nx>instance</span> <span class=o>&amp;&amp;</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>suspense</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>runner</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// watch/watchEffect 都会返回一个“停止监听函数”
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>stop</span><span class=p>(</span><span class=nx>runner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>remove</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>effects</span><span class=o>!</span><span class=p>,</span> <span class=nx>runner</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>VueRouter 2.x 源码学习</h2></div></a></article><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8E%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%8F%92%E6%A7%BD%E7%9A%84-renderless-%E7%BB%84%E4%BB%B6/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>基于作用域插槽的 Renderless 组件</h2></div></a></article><article class=has-image><a href=/p/vue-composition-api/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue Composition API</h2></div></a></article><article class=has-image><a href=/p/vue-3.0-%E6%9D%A5%E4%BA%86/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue 3.0 来了</h2></div></a></article><article class=has-image><a href=/p/vue-2.x-%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93/><div class=article-image><img src=/img/cover/vue.png loading=lazy data-key data-hash=/img/cover/vue.png></div><div class=article-details><h2 class=article-title>Vue 2.x 复习总结</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2024
<a href=https://github.com/Vikingama target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#响应式原理-2x>响应式原理 2.x</a></li><li><a href=#响应式原理-3x>响应式原理 3.x</a></li><li><a href=#异步队列-2x>异步队列 2.x</a></li><li><a href=#异步队列-3x>异步队列 3.x</a></li><li><a href=#依赖注入-2x>依赖注入 2.x</a></li><li><a href=#依赖注入-3x>依赖注入 3.x</a></li><li><a href=#生命周期-2x>生命周期 2.x</a></li><li><a href=#生命周期-3x>生命周期 3.x</a></li><li><a href=#computed-2x>computed 2.x</a></li><li><a href=#computed-3x>computed 3.x</a></li><li><a href=#diff-2x>diff 2.x</a></li><li><a href=#diff-3x>diff 3.x</a></li><li><a href=#keep-alive-2x>keep-alive 2.x</a></li><li><a href=#keep-alive-3x>keep-alive 3.x</a></li><li><a href=#nexttick-2x>nextTick 2.x</a></li><li><a href=#nexttick-3x>nextTick 3.x</a></li><li><a href=#vnode-2x>vnode 2.x</a></li><li><a href=#vnode-3x>vnode 3.x</a></li><li><a href=#watch-2x>watch 2.x</a></li><li><a href=#watch-3x>watch 3.x</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script></body></html>